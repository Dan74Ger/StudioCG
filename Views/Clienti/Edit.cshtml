@model StudioCG.Web.Models.Cliente

@{
    ViewData["Title"] = "Modifica Cliente";
}

<div class="card">
    <div class="card-header">
        <h5 class="mb-0"><i class="fas fa-edit me-2"></i>Modifica Cliente</h5>
    </div>
    <div class="card-body">
        <!-- Ricerca soggetti esistenti per copiare dati -->
        <div class="card bg-light mb-4">
            <div class="card-body py-3">
                <label class="form-label"><i class="fas fa-search text-success me-1"></i>Copia dati da Soggetto esistente</label>
                <div class="position-relative">
                    <input type="text" id="searchSoggettoInput" class="form-control" 
                           placeholder="Cerca per nome, cognome o codice fiscale (min 2 caratteri)..." autocomplete="off" />
                    <div id="searchSoggettoResults" class="position-absolute w-100 bg-white border rounded shadow-sm" 
                         style="display: none; z-index: 1050; max-height: 250px; overflow-y: auto;">
                    </div>
                </div>
                <small class="form-text text-muted">Cerca tra legali rappresentanti, consiglieri e soci per copiare i dati</small>
            </div>
        </div>
        
        <form asp-action="Edit" method="post">
            <input type="hidden" asp-for="Id" />
            <input type="hidden" asp-for="CreatedAt" />
            
            <div class="row">
                <div class="col-md-12 mb-3">
                    <label asp-for="RagioneSociale" class="form-label"></label>
                    <input asp-for="RagioneSociale" class="form-control" id="inputRagioneSociale" />
                    <span asp-validation-for="RagioneSociale" class="text-danger"></span>
                </div>
            </div>
            
            <div class="row">
                <div class="col-md-6 mb-3">
                    <label asp-for="Indirizzo" class="form-label"></label>
                    <input asp-for="Indirizzo" class="form-control" />
                </div>
                <div class="col-md-3 mb-3">
                    <label asp-for="Citta" class="form-label"></label>
                    <input asp-for="Citta" class="form-control" />
                </div>
                <div class="col-md-1 mb-3">
                    <label asp-for="Provincia" class="form-label"></label>
                    <input asp-for="Provincia" class="form-control" maxlength="2" />
                </div>
                <div class="col-md-2 mb-3">
                    <label asp-for="CAP" class="form-label"></label>
                    <input asp-for="CAP" class="form-control" maxlength="5" />
                </div>
            </div>

            <div class="row">
                <div class="col-md-3 mb-3">
                    <label asp-for="CodiceFiscale" class="form-label"></label>
                    <input asp-for="CodiceFiscale" class="form-control text-uppercase" maxlength="16" />
                </div>
                <div class="col-md-3 mb-3">
                    <label asp-for="PartitaIVA" class="form-label"></label>
                    <input asp-for="PartitaIVA" class="form-control" maxlength="11" />
                </div>
                <div class="col-md-3 mb-3">
                    <label asp-for="CodiceAteco" class="form-label"></label>
                    <input asp-for="CodiceAteco" class="form-control" maxlength="10" />
                </div>
            </div>

            <div class="row">
                <div class="col-md-3 mb-3">
                    <label asp-for="TipoSoggetto" class="form-label"></label>
                    <input asp-for="TipoSoggetto" class="form-control text-uppercase" placeholder="PF - DI - SP - SC - PROF" maxlength="10" />
                    <small class="form-text text-muted">PF=Persona Fisica, DI=Ditta Individuale, SP=Società Persone, SC=Società Capitali, PROF=Professionista</small>
                </div>
                <div class="col-md-3 mb-3">
                    <label asp-for="Telefono" class="form-label"></label>
                    <input asp-for="Telefono" class="form-control" />
                </div>
            </div>

            <div class="row">
                <div class="col-md-6 mb-3">
                    <label asp-for="Email" class="form-label"></label>
                    <input asp-for="Email" class="form-control" type="email" />
                    <span asp-validation-for="Email" class="text-danger"></span>
                </div>
                <div class="col-md-6 mb-3">
                    <label asp-for="PEC" class="form-label"></label>
                    <input asp-for="PEC" class="form-control" type="email" />
                </div>
            </div>

            <div class="mb-3">
                <label asp-for="Note" class="form-label"></label>
                <textarea asp-for="Note" class="form-control" rows="3"></textarea>
            </div>

            @if (ViewBag.CampiCustom != null && ((IEnumerable<StudioCG.Web.Models.CampoCustomCliente>)ViewBag.CampiCustom).Any())
            {
                var valori = (Dictionary<int, string?>)ViewBag.ValoriCampiCustom ?? new Dictionary<int, string?>();
                <hr class="my-4">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h6 class="text-primary mb-0"><i class="fas fa-th-list me-2"></i>Campi Personalizzati</h6>
                    <a asp-action="CampiCustom" class="btn btn-outline-secondary btn-sm" title="Gestisci Campi Personalizzati">
                        <i class="fas fa-cog me-1"></i>Gestisci Campi
                    </a>
                </div>
                <div class="row">
                    @foreach (var campo in (IEnumerable<StudioCG.Web.Models.CampoCustomCliente>)ViewBag.CampiCustom)
                    {
                        var valoreCampo = valori.ContainsKey(campo.Id) ? valori[campo.Id] : campo.DefaultValue;
                        <div class="col-md-4 mb-3">
                            <label class="form-label">
                                @campo.Label
                                @if (campo.IsRequired)
                                {
                                    <span class="text-danger">*</span>
                                }
                            </label>
                            @switch (campo.TipoCampo)
                            {
                                case "textarea":
                                    <textarea name="custom_@campo.Id" class="form-control" rows="2" 
                                              placeholder="@campo.Placeholder" @(campo.IsRequired ? "required" : "")>@valoreCampo</textarea>
                                    break;
                                case "number":
                                    <input type="number" name="custom_@campo.Id" class="form-control" 
                                           placeholder="@campo.Placeholder" value="@valoreCampo" @(campo.IsRequired ? "required" : "") />
                                    break;
                                case "decimal":
                                    <input type="number" step="0.01" name="custom_@campo.Id" class="form-control" 
                                           placeholder="@campo.Placeholder" value="@valoreCampo" @(campo.IsRequired ? "required" : "") />
                                    break;
                                case "date":
                                    <input type="date" name="custom_@campo.Id" class="form-control" 
                                           value="@valoreCampo" @(campo.IsRequired ? "required" : "") />
                                    break;
                                case "datetime":
                                    <input type="datetime-local" name="custom_@campo.Id" class="form-control" 
                                           value="@valoreCampo" @(campo.IsRequired ? "required" : "") />
                                    break;
                                case "checkbox":
                                    <div class="form-check mt-2">
                                        <input type="checkbox" name="custom_@campo.Id" value="true" class="form-check-input" 
                                               id="custom_@campo.Id" @(valoreCampo == "true" ? "checked" : "") />
                                        <label class="form-check-label" for="custom_@campo.Id">Sì</label>
                                    </div>
                                    break;
                                case "dropdown":
                                    <select name="custom_@campo.Id" class="form-select" @(campo.IsRequired ? "required" : "")>
                                        <option value="">-- Seleziona --</option>
                                        @if (!string.IsNullOrEmpty(campo.Options))
                                        {
                                            foreach (var opt in campo.Options.Split('|'))
                                            {
                                                if (opt == valoreCampo)
                                                {
                                                    <option value="@opt" selected>@opt</option>
                                                }
                                                else
                                                {
                                                    <option value="@opt">@opt</option>
                                                }
                                            }
                                        }
                                    </select>
                                    break;
                                case "email":
                                    <input type="email" name="custom_@campo.Id" class="form-control" 
                                           placeholder="@campo.Placeholder" value="@valoreCampo" @(campo.IsRequired ? "required" : "") />
                                    break;
                                case "phone":
                                    <input type="tel" name="custom_@campo.Id" class="form-control" 
                                           placeholder="@campo.Placeholder" value="@valoreCampo" @(campo.IsRequired ? "required" : "") />
                                    break;
                                case "url":
                                    <input type="url" name="custom_@campo.Id" class="form-control" 
                                           placeholder="@campo.Placeholder" value="@valoreCampo" @(campo.IsRequired ? "required" : "") />
                                    break;
                                default:
                                    <input type="text" name="custom_@campo.Id" class="form-control" 
                                           placeholder="@campo.Placeholder" value="@valoreCampo" @(campo.IsRequired ? "required" : "") />
                                    break;
                            }
                        </div>
                    }
                </div>
            }

            <div class="form-check mb-3">
                <input asp-for="IsActive" class="form-check-input" />
                <label asp-for="IsActive" class="form-check-label"></label>
            </div>

            <div class="d-flex justify-content-between">
                <a asp-action="Details" asp-route-id="@Model.Id" class="btn btn-outline-secondary">
                    <i class="fas fa-arrow-left me-1"></i>Annulla
                </a>
                <button type="submit" class="btn btn-primary">
                    <i class="fas fa-save me-1"></i>Salva Modifiche
                </button>
            </div>
        </form>
    </div>
</div>

@section Scripts {
    <partial name="_ValidationScriptsPartial" />
    <script>
        // ===== Ricerca tra tutti i soggetti =====
        var searchSoggettoInput = document.getElementById('searchSoggettoInput');
        var searchSoggettoResults = document.getElementById('searchSoggettoResults');
        var searchTimeout = null;
        
        if (searchSoggettoInput) {
            searchSoggettoInput.addEventListener('input', function() {
                clearTimeout(searchTimeout);
                var query = this.value.trim();
                
                if (query.length < 2) {
                    searchSoggettoResults.style.display = 'none';
                    return;
                }
                
                searchTimeout = setTimeout(function() {
                    fetch('@Url.Action("SearchSoggettiPerCopia")?q=' + encodeURIComponent(query))
                        .then(response => response.json())
                        .then(data => {
                            if (data.length === 0) {
                                searchSoggettoResults.innerHTML = '<div class="p-2 text-muted small">Nessun risultato</div>';
                            } else {
                                var html = '';
                                data.forEach(function(s) {
                                    var tipoLabel = '<span class="badge bg-' + getTipoBadgeColor(s.tipoSoggetto) + '">' + s.tipoSoggetto + '</span>';
                                    html += '<div class="search-result-item p-2 border-bottom" style="cursor: pointer;" ' +
                                            'data-nome="' + escapeHtml(s.nome) + '" ' +
                                            'data-cognome="' + escapeHtml(s.cognome) + '" ' +
                                            'data-cf="' + escapeHtml(s.codiceFiscale) + '" ' +
                                            'data-indirizzo="' + escapeHtml(s.indirizzo) + '" ' +
                                            'data-citta="' + escapeHtml(s.citta) + '" ' +
                                            'data-provincia="' + escapeHtml(s.provincia) + '" ' +
                                            'data-cap="' + escapeHtml(s.cap) + '" ' +
                                            'data-email="' + escapeHtml(s.email) + '" ' +
                                            'data-telefono="' + escapeHtml(s.telefono) + '">' +
                                            '<strong>' + escapeHtml(s.nomeCompleto) + '</strong> ' + tipoLabel +
                                            '<br><small class="text-muted">di ' + escapeHtml(s.clienteNome) + '</small>' +
                                            (s.codiceFiscale ? '<br><small class="text-muted">CF: ' + s.codiceFiscale + '</small>' : '') +
                                            '</div>';
                                });
                                searchSoggettoResults.innerHTML = html;
                                
                                // Click handler per risultati
                                searchSoggettoResults.querySelectorAll('.search-result-item').forEach(function(item) {
                                    item.addEventListener('click', function() {
                                        var nome = this.getAttribute('data-nome') || '';
                                        var cognome = this.getAttribute('data-cognome') || '';
                                        
                                        // Componi RagioneSociale come "COGNOME NOME"
                                        var ragioneSociale = (cognome + ' ' + nome).trim().toUpperCase();
                                        
                                        document.getElementById('inputRagioneSociale').value = ragioneSociale;
                                        
                                        var cfInput = document.querySelector('input[name="CodiceFiscale"]');
                                        var indirizzoInput = document.querySelector('input[name="Indirizzo"]');
                                        var cittaInput = document.querySelector('input[name="Citta"]');
                                        var provInput = document.querySelector('input[name="Provincia"]');
                                        var capInput = document.querySelector('input[name="CAP"]');
                                        var emailInput = document.querySelector('input[name="Email"]');
                                        var telInput = document.querySelector('input[name="Telefono"]');
                                        
                                        if (cfInput) cfInput.value = this.getAttribute('data-cf') || '';
                                        if (indirizzoInput) indirizzoInput.value = this.getAttribute('data-indirizzo') || '';
                                        if (cittaInput) cittaInput.value = this.getAttribute('data-citta') || '';
                                        if (provInput) provInput.value = this.getAttribute('data-provincia') || '';
                                        if (capInput) capInput.value = this.getAttribute('data-cap') || '';
                                        if (emailInput) emailInput.value = this.getAttribute('data-email') || '';
                                        if (telInput) telInput.value = this.getAttribute('data-telefono') || '';
                                        
                                        // Suggerisci tipo soggetto PF se vuoto
                                        var tipoInput = document.querySelector('input[name="TipoSoggetto"]');
                                        if (tipoInput && !tipoInput.value) tipoInput.value = 'PF';
                                        
                                        // Nascondi risultati e pulisci input
                                        searchSoggettoResults.style.display = 'none';
                                        searchSoggettoInput.value = '';
                                        searchSoggettoInput.classList.add('border-success');
                                        setTimeout(() => searchSoggettoInput.classList.remove('border-success'), 1500);
                                    });
                                });
                            }
                            searchSoggettoResults.style.display = 'block';
                        })
                        .catch(err => {
                            searchSoggettoResults.innerHTML = '<div class="p-2 text-danger small">Errore ricerca</div>';
                            searchSoggettoResults.style.display = 'block';
                        });
                }, 300);
            });
            
            // Nascondi risultati quando si clicca fuori
            document.addEventListener('click', function(e) {
                if (!searchSoggettoInput.contains(e.target) && !searchSoggettoResults.contains(e.target)) {
                    searchSoggettoResults.style.display = 'none';
                }
            });
        }
        
        function getTipoBadgeColor(tipo) {
            switch(tipo) {
                case 'LegaleRappresentante': return 'primary';
                case 'Consigliere': return 'info';
                case 'Socio': return 'success';
                default: return 'secondary';
            }
        }
        
        function escapeHtml(text) {
            if (!text) return '';
            var div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
    </script>
}

