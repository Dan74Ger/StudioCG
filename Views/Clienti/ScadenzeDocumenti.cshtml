@model List<StudioCG.Web.Models.ClienteSoggetto>
@using StudioCG.Web.Models
@{
    ViewData["Title"] = "Scadenze Documenti IdentitÃ ";
    var oggi = ViewBag.Oggi as DateTime? ?? DateTime.Today;
    var dataAvviso = ViewBag.DataAvviso as DateTime? ?? DateTime.Today.AddDays(30);
}

<div class="d-flex justify-content-between align-items-center mb-4">
    <div>
        <h4 class="mb-1"><i class="fas fa-id-card me-2"></i>Scadenze Documenti IdentitÃ </h4>
        <p class="text-muted mb-0">Gestione scadenze documenti per tutti i soggetti</p>
    </div>
    <div>
        <a asp-action="Index" class="btn btn-outline-secondary">
            <i class="fas fa-arrow-left me-1"></i>Torna ai Clienti
        </a>
    </div>
</div>

<!-- Statistiche Riepilogo -->
<div class="row mb-4">
    <div class="col-md-2">
        <div class="card bg-danger text-white">
            <div class="card-body text-center py-2">
                <h3 class="mb-0">@ViewBag.TotaleScaduti</h3>
                <small>Scaduti</small>
            </div>
        </div>
    </div>
    <div class="col-md-2">
        <div class="card bg-warning text-dark">
            <div class="card-body text-center py-2">
                <h3 class="mb-0">@ViewBag.TotaleInScadenza</h3>
                <small>In Scadenza (@ViewBag.GiorniAvviso gg)</small>
            </div>
        </div>
    </div>
    <div class="col-md-2">
        <div class="card bg-success text-white">
            <div class="card-body text-center py-2">
                <h3 class="mb-0">@ViewBag.TotaleValidi</h3>
                <small>Validi</small>
            </div>
        </div>
    </div>
    <div class="col-md-2">
        <div class="card bg-secondary text-white">
            <div class="card-body text-center py-2">
                <h3 class="mb-0">@ViewBag.TotaleSenzaScadenza</h3>
                <small>Senza Scadenza</small>
            </div>
        </div>
    </div>
    <div class="col-md-2">
        <div class="card bg-info text-white">
            <div class="card-body text-center py-2">
                <h3 class="mb-0">@ViewBag.TotaleConDocumento</h3>
                <small>Con Documento</small>
            </div>
        </div>
    </div>
    <div class="col-md-2">
        <div class="card bg-primary text-white">
            <div class="card-body text-center py-2">
                <h3 class="mb-0">@ViewBag.TotaleSoggetti</h3>
                <small>Totale Soggetti</small>
            </div>
        </div>
    </div>
</div>

<!-- Filtri -->
<div class="card mb-4">
    <div class="card-header bg-light">
        <h6 class="mb-0"><i class="fas fa-filter me-2"></i>Filtri</h6>
    </div>
    <div class="card-body">
        <form method="get" asp-action="ScadenzeDocumenti">
            <div class="row g-3">
                <div class="col-md-2">
                    <label class="form-label small">Nome/Cognome/CF</label>
                    <input type="text" name="searchNome" class="form-control form-control-sm" 
                           value="@ViewBag.SearchNome" placeholder="Cerca...">
                </div>
                <div class="col-md-2">
                    <label class="form-label small">Cliente</label>
                    <input type="text" name="searchCliente" class="form-control form-control-sm" 
                           value="@ViewBag.SearchCliente" placeholder="Ragione Sociale...">
                </div>
                <div class="col-md-2">
                    <label class="form-label small">Tipo Soggetto</label>
                    <select name="tipoSoggetto" class="form-select form-select-sm">
                        <option value="">-- Tutti --</option>
                        <option value="@((int)TipoSoggetto.LegaleRappresentante)" 
                                selected="@(ViewBag.TipoSoggetto != null && (int)ViewBag.TipoSoggetto == 0)">Legale Rappresentante</option>
                        <option value="@((int)TipoSoggetto.Consigliere)" 
                                selected="@(ViewBag.TipoSoggetto != null && (int)ViewBag.TipoSoggetto == 1)">Consigliere</option>
                        <option value="@((int)TipoSoggetto.Socio)" 
                                selected="@(ViewBag.TipoSoggetto != null && (int)ViewBag.TipoSoggetto == 2)">Socio</option>
                    </select>
                </div>
                <div class="col-md-2">
                    <label class="form-label small">Stato Scadenza</label>
                    <select name="statoScadenza" class="form-select form-select-sm">
                        <option value="">-- Tutti --</option>
                        <option value="scaduti" selected="@(ViewBag.StatoScadenza == "scaduti")">ðŸ”´ Scaduti</option>
                        <option value="inScadenza" selected="@(ViewBag.StatoScadenza == "inScadenza")">ðŸŸ  In Scadenza</option>
                        <option value="validi" selected="@(ViewBag.StatoScadenza == "validi")">ðŸŸ¢ Validi</option>
                        <option value="senzaScadenza" selected="@(ViewBag.StatoScadenza == "senzaScadenza")">âšª Senza Scadenza</option>
                        <option value="conDocumento" selected="@(ViewBag.StatoScadenza == "conDocumento")">ðŸ“„ Con Documento</option>
                    </select>
                </div>
                <div class="col-md-2">
                    <label class="form-label small">Giorni Avviso</label>
                    <select name="giorniAvviso" class="form-select form-select-sm">
                        <option value="7" selected="@(ViewBag.GiorniAvviso == 7)">7 giorni</option>
                        <option value="15" selected="@(ViewBag.GiorniAvviso == 15)">15 giorni</option>
                        <option value="30" selected="@(ViewBag.GiorniAvviso == 30)">30 giorni</option>
                        <option value="60" selected="@(ViewBag.GiorniAvviso == 60)">60 giorni</option>
                        <option value="90" selected="@(ViewBag.GiorniAvviso == 90)">90 giorni</option>
                    </select>
                </div>
                <div class="col-md-2 d-flex align-items-end">
                    <button type="submit" class="btn btn-primary btn-sm me-2">
                        <i class="fas fa-search me-1"></i>Filtra
                    </button>
                    <a asp-action="ScadenzeDocumenti" class="btn btn-outline-secondary btn-sm">
                        <i class="fas fa-times"></i>
                    </a>
                </div>
            </div>
        </form>
    </div>
</div>

<!-- Tabella Risultati -->
<div class="card">
    <div class="card-header d-flex justify-content-between align-items-center">
        <h6 class="mb-0"><i class="fas fa-list me-2"></i>Elenco Soggetti (@Model.Count risultati)</h6>
        <a asp-action="ExportScadenzeExcel" 
           asp-route-searchNome="@ViewBag.SearchNome"
           asp-route-searchCliente="@ViewBag.SearchCliente"
           asp-route-tipoSoggetto="@ViewBag.TipoSoggetto"
           asp-route-statoScadenza="@ViewBag.StatoScadenza"
           asp-route-giorniAvviso="@ViewBag.GiorniAvviso"
           class="btn btn-success btn-sm">
            <i class="fas fa-file-excel me-1"></i>Esporta Excel
        </a>
    </div>
    <div class="card-body p-0">
        <div class="table-responsive">
            <table class="table table-hover table-striped mb-0">
                <thead class="table-dark">
                    <tr>
                        <th style="width: 50px;">Stato</th>
                        <th>Cliente</th>
                        <th style="width: 120px;">Tipo</th>
                        <th>Cognome</th>
                        <th>Nome</th>
                        <th>Codice Fiscale</th>
                        <th>NÂ° Documento</th>
                        <th>Data Rilascio</th>
                        <th>Rilasciato Da</th>
                        <th>Scadenza</th>
                        <th style="width: 80px;">Azioni</th>
                    </tr>
                </thead>
                <tbody>
                    @if (!Model.Any())
                    {
                        <tr>
                            <td colspan="11" class="text-center text-muted py-4">
                                <i class="fas fa-search fa-2x mb-2"></i><br>
                                Nessun risultato trovato
                            </td>
                        </tr>
                    }
                    @foreach (var soggetto in Model)
                    {
                        var statoClass = "";
                        var statoBadge = "";
                        var statoIcon = "";
                        
                        if (soggetto.DocumentoScadenza.HasValue)
                        {
                            if (soggetto.DocumentoScadenza.Value < oggi)
                            {
                                statoClass = "table-danger";
                                statoBadge = "bg-danger";
                                statoIcon = "fas fa-exclamation-circle";
                            }
                            else if (soggetto.DocumentoScadenza.Value <= dataAvviso)
                            {
                                statoClass = "table-warning";
                                statoBadge = "bg-warning text-dark";
                                statoIcon = "fas fa-exclamation-triangle";
                            }
                            else
                            {
                                statoClass = "";
                                statoBadge = "bg-success";
                                statoIcon = "fas fa-check-circle";
                            }
                        }
                        else
                        {
                            statoClass = "";
                            statoBadge = "bg-secondary";
                            statoIcon = "fas fa-question-circle";
                        }
                        
                        <tr class="@statoClass">
                            <td class="text-center">
                                <span class="badge @statoBadge">
                                    <i class="@statoIcon"></i>
                                </span>
                            </td>
                            <td>
                                <a asp-action="Details" asp-route-id="@soggetto.ClienteId" class="text-decoration-none">
                                    @soggetto.Cliente?.RagioneSociale
                                </a>
                            </td>
                            <td>
                                @switch (soggetto.TipoSoggetto)
                                {
                                    case TipoSoggetto.LegaleRappresentante:
                                        <span class="badge bg-primary">Legale Rapp.</span>
                                        break;
                                    case TipoSoggetto.Consigliere:
                                        <span class="badge bg-info">Consigliere</span>
                                        break;
                                    case TipoSoggetto.Socio:
                                        <span class="badge bg-success">Socio</span>
                                        break;
                                }
                            </td>
                            <td><strong>@soggetto.Cognome</strong></td>
                            <td>@soggetto.Nome</td>
                            <td><code>@soggetto.CodiceFiscale</code></td>
                            <td>@(soggetto.DocumentoNumero ?? "-")</td>
                            <td>@(soggetto.DocumentoDataRilascio?.ToString("dd/MM/yyyy") ?? "-")</td>
                            <td>@(soggetto.DocumentoRilasciatoDa ?? "-")</td>
                            <td>
                                @if (soggetto.DocumentoScadenza.HasValue)
                                {
                                    var giorniRimanenti = (soggetto.DocumentoScadenza.Value - oggi).Days;
                                    <strong class="@(giorniRimanenti < 0 ? "text-danger" : giorniRimanenti <= 30 ? "text-warning" : "text-success")">
                                        @soggetto.DocumentoScadenza.Value.ToString("dd/MM/yyyy")
                                    </strong>
                                    <br>
                                    <small class="@(giorniRimanenti < 0 ? "text-danger" : giorniRimanenti <= 30 ? "text-warning" : "text-muted")">
                                        @if (giorniRimanenti < 0)
                                        {
                                            <text>Scaduto da @Math.Abs(giorniRimanenti) gg</text>
                                        }
                                        else if (giorniRimanenti == 0)
                                        {
                                            <text>Scade oggi!</text>
                                        }
                                        else
                                        {
                                            <text>@giorniRimanenti gg rimanenti</text>
                                        }
                                    </small>
                                }
                                else
                                {
                                    <span class="text-muted">-</span>
                                }
                            </td>
                            <td>
                                <a asp-action="EditSoggetto" asp-route-id="@soggetto.Id" 
                                   class="btn btn-sm btn-outline-primary" title="Modifica">
                                    <i class="fas fa-edit"></i>
                                </a>
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Quick Filters -->
<div class="mt-3">
    <small class="text-muted">Filtri rapidi: </small>
    <a asp-action="ScadenzeDocumenti" asp-route-statoScadenza="scaduti" class="btn btn-sm btn-outline-danger me-1">
        <i class="fas fa-exclamation-circle me-1"></i>Solo Scaduti
    </a>
    <a asp-action="ScadenzeDocumenti" asp-route-statoScadenza="inScadenza" class="btn btn-sm btn-outline-warning me-1">
        <i class="fas fa-exclamation-triangle me-1"></i>In Scadenza
    </a>
    <a asp-action="ScadenzeDocumenti" asp-route-tipoSoggetto="0" class="btn btn-sm btn-outline-primary me-1">
        <i class="fas fa-user-tie me-1"></i>Legali Rapp.
    </a>
    <a asp-action="ScadenzeDocumenti" asp-route-tipoSoggetto="1" class="btn btn-sm btn-outline-info me-1">
        <i class="fas fa-users me-1"></i>Consiglieri
    </a>
    <a asp-action="ScadenzeDocumenti" asp-route-tipoSoggetto="2" class="btn btn-sm btn-outline-success me-1">
        <i class="fas fa-handshake me-1"></i>Soci
    </a>
</div>

