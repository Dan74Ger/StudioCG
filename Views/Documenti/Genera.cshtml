@{
    ViewData["Title"] = "Genera Documento";
    var templates = ViewBag.Templates as List<StudioCG.Web.Models.Documenti.TemplateDocumento>;
    var clienti = ViewBag.Clienti as dynamic;
}

<div class="container-fluid">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2><i class="fas fa-file-export me-2"></i>Genera Documento</h2>
        <a href="@Url.Action("Index")" class="btn btn-outline-secondary">
            <i class="fas fa-arrow-left me-1"></i>Dashboard
        </a>
    </div>

    @if (TempData["Info"] != null)
    {
        <div class="alert alert-info alert-dismissible fade show">
            <i class="fas fa-info-circle me-2"></i>@TempData["Info"]
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    }

    <div class="row justify-content-center">
        <div class="col-lg-8">
            <div class="card">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0"><i class="fas fa-magic me-2"></i>Wizard Generazione</h5>
                </div>
                <div class="card-body">
                    <form asp-action="GeneraDocumento" method="post">
                        @Html.AntiForgeryToken()

                        <!-- Step 1: Seleziona Template -->
                        <div class="mb-4">
                            <label class="form-label fw-bold">
                                <span class="badge bg-primary rounded-pill me-2">1</span>
                                Seleziona Template
                            </label>
                            @if (templates != null && templates.Any())
                            {
                                <select name="templateId" id="templateSelect" class="form-select form-select-lg" required>
                                    <option value="">-- Scegli un template --</option>
                                    @foreach (var cat in templates.Select(t => t.Categoria).Distinct())
                                    {
                                        <optgroup label="@cat">
                                            @foreach (var t in templates.Where(x => x.Categoria == cat))
                                            {
                                                <option value="@t.Id" data-richiede-mandato="@t.RichiestaMandato.ToString().ToLower()">
                                                    @t.Nome
                                                </option>
                                            }
                                        </optgroup>
                                    }
                                </select>
                            }
                            else
                            {
                                <div class="alert alert-warning">
                                    <i class="fas fa-exclamation-triangle me-2"></i>
                                    Nessun template disponibile. <a href="@Url.Action("TemplateEditor")">Creane uno</a>
                                </div>
                            }
                        </div>

                        <!-- Step 2: Seleziona Cliente -->
                        <div class="mb-4">
                            <label class="form-label fw-bold">
                                <span class="badge bg-primary rounded-pill me-2">2</span>
                                Seleziona Cliente
                            </label>
                            <select name="clienteId" id="clienteSelect" class="form-select form-select-lg" required>
                                <option value="">-- Scegli un cliente --</option>
                                @if (clienti != null)
                                {
                                    @foreach (var c in clienti)
                                    {
                                        <option value="@c.Id">@c.RagioneSociale</option>
                                    }
                                }
                            </select>
                        </div>

                        <!-- Step 3: Seleziona Mandato (se richiesto) -->
                        <div class="mb-4" id="mandatoSection" style="display: none;">
                            <label class="form-label fw-bold">
                                <span class="badge bg-warning text-dark rounded-pill me-2">3</span>
                                Seleziona Mandato
                            </label>
                            <select name="mandatoId" id="mandatoSelect" class="form-select form-select-lg">
                                <option value="">-- Seleziona mandato (carica dopo cliente) --</option>
                            </select>
                            <small class="text-muted">Il template richiede la selezione di un mandato</small>
                        </div>

                        <!-- Step 4: Formato Output -->
                        <div class="mb-4">
                            <label class="form-label fw-bold">
                                <span class="badge bg-primary rounded-pill me-2">4</span>
                                Formato Output
                            </label>
                            <div class="btn-group w-100" role="group">
                                <input type="radio" class="btn-check" name="tipoOutput" id="outputPdf" value="0" checked>
                                <label class="btn btn-outline-danger" for="outputPdf">
                                    <i class="fas fa-file-pdf fa-2x d-block mb-1"></i>
                                    PDF
                                </label>
                                <input type="radio" class="btn-check" name="tipoOutput" id="outputWord" value="1">
                                <label class="btn btn-outline-primary" for="outputWord">
                                    <i class="fas fa-file-word fa-2x d-block mb-1"></i>
                                    Word
                                </label>
                            </div>
                        </div>

                        <hr />

                        <div class="d-grid">
                            <button type="submit" class="btn btn-success btn-lg">
                                <i class="fas fa-magic me-2"></i>Genera Documento
                            </button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Anteprima -->
            <div class="card mt-4" id="previewSection" style="display: none;">
                <div class="card-header bg-secondary text-white">
                    <h5 class="mb-0"><i class="fas fa-eye me-2"></i>Anteprima Documento</h5>
                </div>
                <div class="card-body p-0">
                    <iframe id="previewFrame" style="width: 100%; height: 500px; border: none;"></iframe>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
<script>
    var templateSelect = document.getElementById('templateSelect');
    var clienteSelect = document.getElementById('clienteSelect');
    var mandatoSelect = document.getElementById('mandatoSelect');
    var mandatoSection = document.getElementById('mandatoSection');
    var previewFrame = document.getElementById('previewFrame');
    var previewSection = document.getElementById('previewSection');

    templateSelect.addEventListener('change', function() {
        var selected = this.options[this.selectedIndex];
        var richiestaMandato = selected.getAttribute('data-richiede-mandato') === 'true';
        mandatoSection.style.display = richiestaMandato ? 'block' : 'none';
        updatePreview();
    });

    clienteSelect.addEventListener('change', function() {
        var clienteId = this.value;
        if (clienteId) {
            // Carica mandati del cliente
            fetch('@Url.Action("GetMandatiCliente")/' + clienteId)
                .then(response => response.json())
                .then(data => {
                    mandatoSelect.innerHTML = '<option value="">-- Seleziona mandato --</option>';
                    data.forEach(function(m) {
                        var opt = document.createElement('option');
                        opt.value = m.id;
                        opt.textContent = m.oggetto + ' (' + m.importoAnnuo + ' â‚¬)';
                        mandatoSelect.appendChild(opt);
                    });
                });
        }
        updatePreview();
    });

    mandatoSelect.addEventListener('change', updatePreview);

    function updatePreview() {
        var templateId = templateSelect.value;
        var clienteId = clienteSelect.value;
        var mandatoId = mandatoSelect.value;

        if (templateId && clienteId) {
            previewSection.style.display = 'block';
            var url = '@Url.Action("Anteprima")?templateId=' + templateId + '&clienteId=' + clienteId;
            if (mandatoId) url += '&mandatoId=' + mandatoId;
            
            fetch(url)
                .then(response => response.text())
                .then(html => {
                    previewFrame.srcdoc = `
                        <!DOCTYPE html>
                        <html>
                        <head>
                            <style>
                                body { font-family: Arial, sans-serif; font-size: 11pt; padding: 20px; }
                                table { border-collapse: collapse; width: 100%; }
                                td, th { border: 1px solid #ddd; padding: 8px; }
                            </style>
                        </head>
                        <body>${html}</body>
                        </html>
                    `;
                });
        } else {
            previewSection.style.display = 'none';
        }
    }
</script>
}

