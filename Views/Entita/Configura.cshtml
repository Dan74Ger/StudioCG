@model StudioCG.Web.Models.Entita.EntitaDinamica
@{
    ViewData["Title"] = $"Configura: {Model.Nome}";
}

<div class="container-fluid">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h2>
                <i class="@Model.Icon me-2" style="color: @Model.Colore;"></i>
                Configura: @Model.Nome
            </h2>
            <p class="text-muted mb-0">Definisci campi e stati per questa entit√†</p>
        </div>
        <div class="btn-group">
            <a asp-action="Dati" asp-route-id="@Model.Id" class="btn btn-primary">
                <i class="fas fa-database me-1"></i>Vai ai Dati
            </a>
            <a asp-action="Gestione" class="btn btn-outline-secondary">
                <i class="fas fa-arrow-left me-1"></i>Torna a Gestione
            </a>
        </div>
    </div>

    @if (TempData["Success"] != null)
    {
        <div class="alert alert-success alert-dismissible fade show">
            <i class="fas fa-check-circle me-2"></i>@TempData["Success"]
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    }

    @if (TempData["Error"] != null)
    {
        <div class="alert alert-danger alert-dismissible fade show">
            <i class="fas fa-exclamation-circle me-2"></i>@TempData["Error"]
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    }

    <!-- Impostazioni Entit√† -->
    <div class="card mb-4">
        <div class="card-header">
            <h5 class="mb-0"><i class="fas fa-cog me-2"></i>Impostazioni Entit√†</h5>
        </div>
        <div class="card-body">
            <form asp-action="AggiornaEntita" method="post">
                <input type="hidden" name="id" value="@Model.Id" />
                <div class="row">
                    <div class="col-md-3 mb-3">
                        <label class="form-label">Nome</label>
                        <input type="text" name="nome" class="form-control" value="@Model.Nome" required />
                    </div>
                    <div class="col-md-3 mb-3">
                        <label class="form-label">Nome Plurale</label>
                        <input type="text" name="nomePluruale" class="form-control" value="@Model.NomePluruale" />
                    </div>
                    <div class="col-md-2 mb-3">
                        <label class="form-label">Icona</label>
                        <input type="text" name="icon" class="form-control" value="@Model.Icon" />
                    </div>
                    <div class="col-md-1 mb-3">
                        <label class="form-label">Colore</label>
                        <input type="color" name="colore" class="form-control form-control-color" value="@Model.Colore" />
                    </div>
                    <div class="col-md-3 mb-3">
                        <label class="form-label">Descrizione</label>
                        <input type="text" name="descrizione" class="form-control" value="@Model.Descrizione" />
                    </div>
                </div>
                <div class="row mb-3">
                    <div class="col-md-3">
                        <label class="form-label"><i class="fas fa-bell text-warning me-1"></i>Giorni Preavviso Scadenza</label>
                        <input type="number" name="giorniPreavvisoScadenza" class="form-control" value="@Model.GiorniPreavvisoScadenza" min="1" max="365" />
                        <small class="text-muted">Per avvisi scadenza</small>
                    </div>
                    <div class="col-md-9">
                        <label class="form-label"><i class="fas fa-columns text-info me-1"></i>Larghezza Colonne Griglia (px, 0=auto)</label>
                        <div class="row">
                            <div class="col-4">
                                <div class="input-group input-group-sm">
                                    <span class="input-group-text">Cliente</span>
                                    <input type="number" name="larghezzaColonnaCliente" class="form-control" value="@Model.LarghezzaColonnaCliente" min="0" max="500" />
                                </div>
                            </div>
                            <div class="col-4">
                                <div class="input-group input-group-sm">
                                    <span class="input-group-text">Titolo</span>
                                    <input type="number" name="larghezzaColonnaTitolo" class="form-control" value="@Model.LarghezzaColonnaTitolo" min="0" max="500" />
                                </div>
                            </div>
                            <div class="col-4">
                                <div class="input-group input-group-sm">
                                    <span class="input-group-text">Stato</span>
                                    <input type="number" name="larghezzaColonnaStato" class="form-control" value="@Model.LarghezzaColonnaStato" min="0" max="500" />
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="d-flex gap-3 align-items-center">
                    <div class="form-check">
                        <input type="checkbox" name="collegataACliente" value="true" class="form-check-input" 
                               id="collegata" @(Model.CollegataACliente ? "checked" : "")>
                        <label class="form-check-label" for="collegata">Collegata a Cliente</label>
                    </div>
                    <button type="submit" class="btn btn-primary btn-sm">
                        <i class="fas fa-save me-1"></i>Salva Impostazioni
                    </button>
                    <button type="button" class="btn btn-danger btn-sm" data-bs-toggle="modal" data-bs-target="#deleteEntitaModal">
                        <i class="fas fa-trash me-1"></i>Elimina Entit√†
                    </button>
                </div>
            </form>
        </div>
    </div>

    <div class="row">
        <!-- CAMPI (Form Builder) -->
        <div class="col-lg-7">
            <div class="card">
                <div class="card-header bg-info text-white d-flex justify-content-between align-items-center">
                    <h5 class="mb-0"><i class="fas fa-th-list me-2"></i>Campi (@Model.Campi.Count())</h5>
                    <button class="btn btn-light btn-sm" data-bs-toggle="modal" data-bs-target="#addCampoModal">
                        <i class="fas fa-plus me-1"></i>Aggiungi Campo
                    </button>
                </div>
                <div class="card-body p-0">
                    @if (!Model.Campi.Any())
                    {
                        <div class="text-center py-4 text-muted">
                            <i class="fas fa-th-list fa-2x mb-2"></i>
                            <p class="mb-0">Nessun campo definito. Aggiungi il primo campo.</p>
                        </div>
                    }
                    else
                    {
                        <div class="table-responsive">
                            <table class="table table-hover mb-0 align-middle">
                                <thead class="table-light">
                                    <tr>
                                        <th style="width: 50px;"></th>
                                        <th>Campo</th>
                                        <th>Tipo</th>
                                        <th class="text-center">Opzioni</th>
                                        <th style="width: 100px;"></th>
                                    </tr>
                                </thead>
                                <tbody>
                                    @foreach (var campo in Model.Campi)
                                    {
                                        <tr>
                                            <td>
                                                <div class="btn-group-vertical btn-group-sm">
                                                    <form asp-action="MoveCampoUp" method="post" class="d-inline">
                                                        <input type="hidden" name="id" value="@campo.Id" />
                                                        <button type="submit" class="btn btn-outline-secondary btn-sm py-0"><i class="fas fa-chevron-up"></i></button>
                                                    </form>
                                                    <form asp-action="MoveCampoDown" method="post" class="d-inline">
                                                        <input type="hidden" name="id" value="@campo.Id" />
                                                        <button type="submit" class="btn btn-outline-secondary btn-sm py-0"><i class="fas fa-chevron-down"></i></button>
                                                    </form>
                                                </div>
                                            </td>
                                            <td>
                                                <strong>@campo.Label</strong>
                                                <code class="ms-1 text-muted small">[@campo.Nome]</code>
                                                @if (campo.IsCalculated && !string.IsNullOrEmpty(campo.Formula))
                                                {
                                                    <br><small class="text-warning"><i class="fas fa-calculator"></i> @campo.Formula</small>
                                                }
                                            </td>
                                            <td>
                                                @if (campo.IsCalculated)
                                                {
                                                    <span class="badge bg-warning text-dark"><i class="fas fa-calculator me-1"></i>Calcolato</span>
                                                }
                                                else
                                                {
                                                    var tipoIcon = campo.TipoCampo switch {
                                                        "text" => "üìù", "textarea" => "üìÑ", "number" => "üî¢", "decimal" => "üí∞",
                                                        "date" => "üìÖ", "datetime" => "üìÖ‚è∞", "checkbox" => "‚òëÔ∏è", "dropdown" => "üìã",
                                                        "email" => "‚úâÔ∏è", "phone" => "üìû", "url" => "üåê", "cliente" => "üë§", _ => "‚ùì"
                                                    };
                                                    @tipoIcon @campo.TipoCampo
                                                }
                                            </td>
                                            <td class="text-center">
                                                @if (campo.IsRequired) { <span class="badge bg-danger">OBB</span> }
                                                @if (campo.ShowInList) { <span class="badge bg-info">LISTA</span> }
                                                @if (campo.UseAsFilter) { <span class="badge bg-warning text-dark">FILTRO</span> }
                                                @if (campo.IsDataScadenza) { <span class="badge bg-danger"><i class="fas fa-bell me-1"></i>SCADENZA</span> }
                                            </td>
                                            <td>
                                                <button type="button" class="btn btn-sm btn-outline-primary" data-bs-toggle="modal" data-bs-target="#editCampoModal@(campo.Id)">
                                                    <i class="fas fa-edit"></i>
                                                </button>
                                                <form asp-action="DeleteCampo" method="post" class="d-inline" onsubmit="return confirm('Eliminare questo campo?')">
                                                    <input type="hidden" name="id" value="@campo.Id" />
                                                    <button type="submit" class="btn btn-sm btn-outline-danger"><i class="fas fa-trash"></i></button>
                                                </form>
                                            </td>
                                        </tr>

                                        <!-- Modal Edit Campo -->
                                        <div class="modal fade" id="editCampoModal@(campo.Id)" tabindex="-1">
                                            <div class="modal-dialog">
                                                <div class="modal-content">
                                                    <form asp-action="EditCampo" method="post">
                                                        <input type="hidden" name="id" value="@campo.Id" />
                                                        <div class="modal-header"><h5 class="modal-title">Modifica Campo</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
                                                        <div class="modal-body">
                                                            <div class="mb-3"><label class="form-label">Etichetta</label><input type="text" name="label" class="form-control" value="@campo.Label" required /></div>
                                                            <div class="mb-3">
                                                                <label class="form-label">Tipo</label>
                                                                <select name="tipoCampo" class="form-select">
                                                                    @foreach (var t in new[] { ("text","Testo"), ("textarea","Testo Lungo"), ("number","Numero"), ("decimal","Decimale"), ("date","Data"), ("datetime","Data/Ora"), ("checkbox","Checkbox"), ("dropdown","Dropdown"), ("email","Email"), ("phone","Telefono"), ("url","URL") })
                                                                    {
                                                                        if (campo.TipoCampo == t.Item1) { <option value="@t.Item1" selected>@t.Item2</option> } else { <option value="@t.Item1">@t.Item2</option> }
                                                                    }
                                                                </select>
                                                            </div>
                                                            <div class="mb-3"><label class="form-label">Opzioni (per dropdown)</label><input type="text" name="options" class="form-control" value="@campo.Options" placeholder="Opz1|Opz2|Opz3" /></div>
                                                            <div class="mb-3"><label class="form-label">Valore Default</label><input type="text" name="defaultValue" class="form-control" value="@campo.DefaultValue" /></div>
                                                            <div class="mb-3"><label class="form-label">Placeholder</label><input type="text" name="placeholder" class="form-control" value="@campo.Placeholder" /></div>
                                                            <div class="row mb-3">
                                                                <div class="col-6"><label class="form-label">Largh. Form (1-12)</label><input type="number" name="colWidth" class="form-control" value="@campo.ColWidth" min="1" max="12" /></div>
                                                                <div class="col-6"><label class="form-label">Largh. Griglia (px)</label><input type="number" name="columnWidth" class="form-control" value="@campo.ColumnWidth" min="0" max="500" title="0=Auto" /></div>
                                                            </div>
                                                            <div class="row mb-3">
                                                                <div class="col-4"><div class="form-check"><input type="checkbox" name="isRequired" value="true" class="form-check-input" @(campo.IsRequired ? "checked" : "") /><label class="form-check-label">Obbligatorio</label></div></div>
                                                                <div class="col-4"><div class="form-check"><input type="checkbox" name="showInList" value="true" class="form-check-input" @(campo.ShowInList ? "checked" : "") /><label class="form-check-label">In Lista</label></div></div>
                                                                <div class="col-4"><div class="form-check"><input type="checkbox" name="useAsFilter" value="true" class="form-check-input" @(campo.UseAsFilter ? "checked" : "") /><label class="form-check-label">Filtro</label></div></div>
                                                            </div>
                                                            <!-- Data Scadenza (solo per tipo date) -->
                                                            <div class="mb-3" id="scadenzaContainer-@campo.Id" style="display: @(campo.TipoCampo == "date" ? "block" : "none");">
                                                                <div class="form-check">
                                                                    <input type="checkbox" name="isDataScadenza" value="true" class="form-check-input" id="scadenza-@campo.Id" @(campo.IsDataScadenza ? "checked" : "") />
                                                                    <label class="form-check-label" for="scadenza-@campo.Id"><i class="fas fa-bell text-warning me-1"></i><strong>Data Scadenza</strong></label>
                                                                </div>
                                                                <small class="text-muted">I record verranno evidenziati in scadenza</small>
                                                            </div>
                                                            <!-- Campo Calcolato -->
                                                            <div class="card bg-light">
                                                                <div class="card-body py-2">
                                                                    <div class="form-check mb-2">
                                                                        <input type="checkbox" name="isCalculated" value="true" class="form-check-input" id="isCalc-@campo.Id" @(campo.IsCalculated ? "checked" : "") onchange="toggleFormulaEntita(@campo.Id)" />
                                                                        <label class="form-check-label" for="isCalc-@campo.Id"><i class="fas fa-calculator me-1"></i><strong>Campo Calcolato</strong></label>
                                                                    </div>
                                                                    <div id="formulaSection-@campo.Id" style="display: @(campo.IsCalculated ? "block" : "none");">
                                                                        <input type="text" name="formula" id="formulaInput-@campo.Id" class="form-control form-control-sm" value="@campo.Formula" placeholder="Es: [IMPORTO] * 0.22" />
                                                                        <small class="text-muted">Usa [NomeCampo]. Operatori: + - * / Clicca sui campi sotto.</small>
                                                                        @{
                                                                            var altriCampi = Model.Campi.Where(c => !c.IsCalculated && c.Id != campo.Id).ToList();
                                                                        }
                                                                        @if (altriCampi.Any())
                                                                        {
                                                                            <div class="mt-1">
                                                                                @foreach (var c in altriCampi)
                                                                                {
                                                                                    <button type="button" class="btn btn-sm btn-outline-primary me-1 mb-1" onclick="inserisciCampoEdit(@campo.Id, '@c.Nome')">[@c.Nome]</button>
                                                                                }
                                                                            </div>
                                                                        }
                                                                    </div>
                                                                </div>
                                                            </div>
                                                        </div>
                                                        <div class="modal-footer"><button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annulla</button><button type="submit" class="btn btn-primary"><i class="fas fa-save me-1"></i>Salva</button></div>
                                                    </form>
                                                </div>
                                            </div>
                                        </div>
                                    }
                                </tbody>
                            </table>
                        </div>
                    }
                </div>
            </div>
        </div>

        <!-- STATI -->
        <div class="col-lg-5">
            <div class="card">
                <div class="card-header bg-warning text-dark d-flex justify-content-between align-items-center">
                    <h5 class="mb-0"><i class="fas fa-flag me-2"></i>Stati (@Model.Stati.Count())</h5>
                    <button class="btn btn-dark btn-sm" data-bs-toggle="modal" data-bs-target="#addStatoModal">
                        <i class="fas fa-plus me-1"></i>Aggiungi
                    </button>
                </div>
                <ul class="list-group list-group-flush">
                    @if (!Model.Stati.Any())
                    {
                        <li class="list-group-item text-center text-muted py-4">
                            <i class="fas fa-flag fa-2x mb-2"></i>
                            <p class="mb-0">Nessuno stato definito.</p>
                        </li>
                    }
                    @foreach (var stato in Model.Stati)
                    {
                        <li class="list-group-item d-flex justify-content-between align-items-center">
                            <div>
                                <span class="badge me-2" style="background-color: @stato.ColoreSfondo; color: @stato.ColoreTesto;">
                                    <i class="@stato.Icon me-1"></i>@stato.Nome
                                </span>
                                @if (stato.IsDefault) { <span class="badge bg-primary">Default</span> }
                                @if (stato.IsFinale) { <span class="badge bg-success">Finale</span> }
                            </div>
                            <form asp-action="DeleteStato" method="post" class="d-inline" onsubmit="return confirm('Eliminare questo stato?')">
                                <input type="hidden" name="id" value="@stato.Id" />
                                <button type="submit" class="btn btn-sm btn-outline-danger"><i class="fas fa-times"></i></button>
                            </form>
                        </li>
                    }
                </ul>
            </div>
        </div>
    </div>
</div>

<!-- Modal Aggiungi Campo -->
<div class="modal fade" id="addCampoModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <form asp-action="AddCampo" method="post">
                <input type="hidden" name="EntitaDinamicaId" value="@Model.Id" />
                <div class="modal-header bg-info text-white"><h5 class="modal-title"><i class="fas fa-plus me-2"></i>Nuovo Campo</h5><button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button></div>
                <div class="modal-body">
                    <div class="mb-3"><label class="form-label">Nome Campo *</label><input type="text" name="Nome" class="form-control" required pattern="[A-Za-z0-9_]+" placeholder="es: DataDecesso" /><small class="text-muted">Solo lettere, numeri, underscore</small></div>
                    <div class="mb-3"><label class="form-label">Etichetta *</label><input type="text" name="Label" class="form-control" required placeholder="es: Data Decesso" /></div>
                    <div class="mb-3">
                        <label class="form-label">Tipo Campo</label>
                        <select name="TipoCampo" class="form-select" id="newCampoTipo">
                            <option value="text">üìù Testo</option>
                            <option value="textarea">üìÑ Testo Lungo</option>
                            <option value="number">üî¢ Numero</option>
                            <option value="decimal">üí∞ Decimale</option>
                            <option value="date">üìÖ Data</option>
                            <option value="datetime">üìÖ‚è∞ Data/Ora</option>
                            <option value="checkbox">‚òëÔ∏è Checkbox</option>
                            <option value="dropdown">üìã Dropdown</option>
                            <option value="email">‚úâÔ∏è Email</option>
                            <option value="phone">üìû Telefono</option>
                            <option value="url">üåê URL</option>
                        </select>
                    </div>
                    <div class="mb-3" id="optionsContainer" style="display:none;"><label class="form-label">Opzioni (separate da |)</label><input type="text" name="Options" class="form-control" placeholder="Opz1|Opz2|Opz3" /></div>
                    <div class="mb-3"><label class="form-label">Placeholder</label><input type="text" name="Placeholder" class="form-control" /></div>
                    <div class="row mb-3">
                        <div class="col-4"><div class="form-check"><input type="checkbox" name="IsRequired" value="true" class="form-check-input" id="newReq" /><label class="form-check-label" for="newReq">Obbligatorio</label></div></div>
                        <div class="col-4"><div class="form-check"><input type="checkbox" name="ShowInList" value="true" class="form-check-input" id="newList" checked /><label class="form-check-label" for="newList">In Lista</label></div></div>
                        <div class="col-4"><div class="form-check"><input type="checkbox" name="UseAsFilter" value="true" class="form-check-input" id="newFilter" /><label class="form-check-label" for="newFilter">Filtro</label></div></div>
                    </div>
                    <!-- Data Scadenza (solo per tipo date) -->
                    <div class="mb-3" id="newScadenzaContainer" style="display:none;">
                        <div class="form-check">
                            <input type="checkbox" name="IsDataScadenza" value="true" class="form-check-input" id="newScadenza" />
                            <label class="form-check-label" for="newScadenza"><i class="fas fa-bell text-warning me-1"></i><strong>Usa come Data Scadenza</strong></label>
                        </div>
                        <small class="text-muted">I record con questa data verranno evidenziati in base ai giorni di preavviso</small>
                    </div>
                    <!-- Campo Calcolato -->
                    <div class="card bg-light">
                        <div class="card-body py-2">
                            <div class="form-check mb-2">
                                <input type="checkbox" name="IsCalculated" value="true" class="form-check-input" id="newCalc" onchange="toggleNewFormulaEntita()" />
                                <label class="form-check-label" for="newCalc"><i class="fas fa-calculator me-1"></i><strong>Campo Calcolato</strong></label>
                            </div>
                            <div id="newFormulaSection" style="display: none;">
                                <input type="text" name="Formula" id="newFormulaInput" class="form-control form-control-sm" placeholder="Es: [IMPORTO] * 0.22" />
                                <small class="text-muted">Usa [NomeCampo]. Operatori: + - * / Clicca sui campi sotto per inserirli.</small>
                                @if (Model.Campi.Where(c => !c.IsCalculated).Any())
                                {
                                    <div class="mt-2">
                                        <small>Campi disponibili:</small><br/>
                                        @foreach (var c in Model.Campi.Where(c => !c.IsCalculated))
                                        {
                                            <button type="button" class="btn btn-sm btn-outline-primary me-1 mb-1" onclick="inserisciCampoNew('@c.Nome')">[@c.Nome]</button>
                                        }
                                    </div>
                                }
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer"><button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annulla</button><button type="submit" class="btn btn-info"><i class="fas fa-plus me-1"></i>Aggiungi</button></div>
            </form>
        </div>
    </div>
</div>

<!-- Modal Aggiungi Stato -->
<div class="modal fade" id="addStatoModal" tabindex="-1">
    <div class="modal-dialog modal-sm">
        <div class="modal-content">
            <form asp-action="AddStato" method="post">
                <input type="hidden" name="EntitaDinamicaId" value="@Model.Id" />
                <div class="modal-header bg-warning"><h5 class="modal-title"><i class="fas fa-flag me-2"></i>Nuovo Stato</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
                <div class="modal-body">
                    <div class="mb-3"><label class="form-label">Nome *</label><input type="text" name="Nome" class="form-control" required /></div>
                    <div class="mb-3"><label class="form-label">Icona</label><input type="text" name="Icon" class="form-control" value="fas fa-circle" /></div>
                    <div class="row mb-3">
                        <div class="col-6"><label class="form-label">Sfondo</label><input type="color" name="ColoreSfondo" class="form-control form-control-color w-100" value="#6c757d" /></div>
                        <div class="col-6"><label class="form-label">Testo</label><input type="color" name="ColoreTesto" class="form-control form-control-color w-100" value="#FFFFFF" /></div>
                    </div>
                    <div class="form-check"><input type="checkbox" name="IsDefault" value="true" class="form-check-input" id="newDefault" /><label class="form-check-label" for="newDefault">Stato Default</label></div>
                    <div class="form-check"><input type="checkbox" name="IsFinale" value="true" class="form-check-input" id="newFinale" /><label class="form-check-label" for="newFinale">Stato Finale</label></div>
                </div>
                <div class="modal-footer"><button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annulla</button><button type="submit" class="btn btn-warning"><i class="fas fa-plus me-1"></i>Aggiungi</button></div>
            </form>
        </div>
    </div>
</div>

<!-- Modal Elimina Entit√† -->
<div class="modal fade" id="deleteEntitaModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white"><h5 class="modal-title">Conferma Eliminazione</h5><button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button></div>
            <div class="modal-body">
                <p>Sei sicuro di voler eliminare l'entit√† <strong>@Model.Nome</strong>?</p>
                <div class="alert alert-danger"><i class="fas fa-exclamation-triangle me-2"></i>Verranno eliminati TUTTI i dati, campi e stati associati!</div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annulla</button>
                <form asp-action="EliminaEntita" method="post"><input type="hidden" name="id" value="@Model.Id" /><button type="submit" class="btn btn-danger"><i class="fas fa-trash me-1"></i>Elimina</button></form>
            </div>
        </div>
    </div>
</div>

@section Scripts {
<script>
document.getElementById('newCampoTipo').addEventListener('change', function() {
    document.getElementById('optionsContainer').style.display = this.value === 'dropdown' ? 'block' : 'none';
    // Mostra/nascondi opzione data scadenza
    document.getElementById('newScadenzaContainer').style.display = this.value === 'date' ? 'block' : 'none';
});

// Toggle formula per nuovo campo
function toggleNewFormulaEntita() {
    var checkbox = document.getElementById('newCalc');
    var section = document.getElementById('newFormulaSection');
    section.style.display = checkbox.checked ? 'block' : 'none';
}

// Toggle formula per modifica campo
function toggleFormulaEntita(campoId) {
    var checkbox = document.getElementById('isCalc-' + campoId);
    var section = document.getElementById('formulaSection-' + campoId);
    section.style.display = checkbox.checked ? 'block' : 'none';
}

// Inserisce nome campo nella formula del nuovo campo
function inserisciCampoNew(nomeCampo) {
    var input = document.getElementById('newFormulaInput');
    var pos = input.selectionStart || input.value.length;
    var testo = '[' + nomeCampo + ']';
    input.value = input.value.substring(0, pos) + testo + input.value.substring(pos);
    input.focus();
    input.setSelectionRange(pos + testo.length, pos + testo.length);
}

// Inserisce nome campo nella formula di modifica
function inserisciCampoEdit(campoId, nomeCampo) {
    var input = document.getElementById('formulaInput-' + campoId);
    var pos = input.selectionStart || input.value.length;
    var testo = '[' + nomeCampo + ']';
    input.value = input.value.substring(0, pos) + testo + input.value.substring(pos);
    input.focus();
    input.setSelectionRange(pos + testo.length, pos + testo.length);
}
</script>
}
