@model StudioCG.Web.Models.ViewModels.BudgetStudioViewModel
@using StudioCG.Web.Models.BudgetStudio
@using StudioCG.Web.Models.ViewModels
@{
    ViewData["Title"] = "Budget Studio";
    var activeTab = (ViewBag.ActiveTab as string) ?? "anagrafica";

    var mesi = new Dictionary<int, string>
    {
        {1, "Gen"}, {2, "Feb"}, {3, "Mar"}, {4, "Apr"},
        {5, "Mag"}, {6, "Giu"}, {7, "Lug"}, {8, "Ago"},
        {9, "Set"}, {10, "Ott"}, {11, "Nov"}, {12, "Dic"}
    };
}

<style>
    /* Override sidebar nav-link styles (global in _Layout) for Bootstrap tabs in this page */
    #budgetTabs .nav-link {
        color: var(--primary-color) !important;
        background: transparent !important;
        transform: none !important;
        border: 1px solid #e2e8f0 !important;
        border-bottom: none !important;
        border-radius: 10px 10px 0 0 !important;
        padding: 10px 16px !important;
        display: inline-flex !important;
        gap: 8px !important;
    }

    #budgetTabs .nav-link:hover {
        color: var(--primary-color) !important;
        background: #f7fafc !important;
        transform: none !important;
    }

    #budgetTabs .nav-link.active {
        color: var(--primary-color) !important;
        background: #ffffff !important;
        border-bottom: 1px solid #ffffff !important;
        box-shadow: 0 -1px 0 rgba(0,0,0,0.02);
    }

    #budgetTabsContent {
        border-color: #e2e8f0 !important;
        border-radius: 0 12px 12px 12px;
    }

    /* Prospetto: tutto visibile in una schermata */
    .budget-grid-wrap {
        overflow-x: auto;
        overflow-y: visible;
        padding-bottom: 6px;
    }

    table.budget-grid {
        border-collapse: collapse;
        width: 100%;
        table-layout: fixed;
    }

    table.budget-grid th,
    table.budget-grid td {
        vertical-align: middle;
        background: #fff;
        border: 1px solid #dee2e6;
        text-align: center;
        padding: 4px 3px;
    }

    table.budget-grid thead th {
        position: sticky;
        top: 0;
        z-index: 2;
        background: #f8fafc;
        font-size: 0.8rem;
        font-weight: 600;
    }

    /* Prima colonna (Voce) */
    table.budget-grid th:first-child,
    table.budget-grid td:first-child {
        position: sticky;
        left: 0;
        z-index: 3;
        background: #ffffff;
        width: 180px;
        text-align: left;
        padding: 4px 6px;
    }

    table.budget-grid thead th:first-child {
        background: #f8fafc;
    }

    /* Ultima colonna (Totale) */
    table.budget-grid th:last-child,
    table.budget-grid td:last-child {
        background: #f0f4f8;
        width: 70px;
        font-weight: 600;
        font-size: 0.85rem;
    }

    /* Celle mesi */
    .budget-cell {
        width: 100%;
        padding: 2px 1px !important;
        font-size: 0.9rem;
        font-weight: 500;
        text-align: center;
        border: none;
        background: transparent;
    }

    /* Celle pagate - verde chiaro */
    td.cell-pagata {
        background-color: #d4edda !important;
    }
    td.cell-pagata .budget-cell {
        background: transparent;
    }

    /* Celle da pagare (con importo) - rosso chiaro */
    td.cell-da-pagare {
        background-color: #ffe5e5 !important;
    }
    td.cell-da-pagare .budget-cell {
        background: transparent;
    }

    /* Azioni voce: codice + descrizione */
    .budget-voce-actions {
        display: flex;
        gap: 4px;
        align-items: center;
        justify-content: space-between;
    }

    .budget-voce-actions .voce-info {
        overflow: hidden;
        flex: 1;
        min-width: 0;
    }

    .budget-voce-actions .fw-bold {
        font-size: 0.8rem;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }

    .budget-voce-actions .text-muted {
        font-size: 0.65rem;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        display: block;
    }

    .budget-voce-actions .btn-sm {
        padding: 2px 4px;
        font-size: 0.65rem;
        flex-shrink: 0;
    }

    /* Stile per celle banche */
    .cell-banca {
        background-color: #e3f2fd !important;
    }
    .cell-banca .saldo-banca-cell {
        background: transparent !important;
        border-color: #90caf9 !important;
        font-size: 0.85rem;
        padding: 2px 4px;
    }
    .cell-banca .saldo-banca-cell:focus {
        background: #fff !important;
        border-color: #1976d2 !important;
        box-shadow: 0 0 0 0.2rem rgba(25, 118, 210, 0.25);
    }

    /* Pulsante extra small */
    .btn-xs {
        padding: 0.125rem 0.35rem;
        font-size: 0.65rem;
        line-height: 1.2;
        border-radius: 0.2rem;
    }

    /* Riga banche stile */
    .banca-row td:first-child {
        background-color: #e3f2fd !important;
    }
    .banca-row .banca-tot-riga {
        background-color: #bbdefb !important;
    }

    /* Macro voce stile */
    .macro-voce-row {
        background-color: #e3f2fd !important;
    }
    .macro-voce-row:hover {
        background-color: #bbdefb !important;
    }
    .macro-voce-row td {
        background-color: inherit !important;
    }
    .macro-chevron {
        transition: transform 0.2s ease;
        font-size: 0.7rem;
    }
    .macro-chevron.expanded {
        transform: rotate(90deg);
    }
    
    /* Voci analitiche */
    .voce-analitica-row {
        background-color: #f8f9fa;
    }
    .voce-analitica-row td:first-child {
        background-color: #f8f9fa !important;
    }
</style>

<div class="container-fluid">
    <div class="row mb-3">
        <div class="col-12 d-flex justify-content-between align-items-center flex-wrap gap-2">
            <div>
                <h4 class="mb-0"><i class="fas fa-coins me-2 text-warning"></i>Budget Studio</h4>
                <small class="text-muted">Prospetto spese previste Gen–Dic</small>
            </div>
        </div>
    </div>

    <ul class="nav nav-tabs" id="budgetTabs" role="tablist">
        <li class="nav-item" role="presentation">
            <button class="nav-link @(activeTab == "anagrafica" ? "active" : "")" id="tab-anagrafica" data-bs-toggle="tab" data-bs-target="#pane-anagrafica" type="button" role="tab">
                <i class="fas fa-list me-2"></i>Anagrafica Voci
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link @(activeTab == "prospetto" ? "active" : "")" id="tab-prospetto" data-bs-toggle="tab" data-bs-target="#pane-prospetto" type="button" role="tab">
                <i class="fas fa-table me-2"></i>Prospetto (@Model.Anno)
            </button>
        </li>
    </ul>

    <div class="tab-content border border-top-0 p-3 bg-white" id="budgetTabsContent">
        <!-- ===================== TAB ANAGRAFICA ===================== -->
        <div class="tab-pane fade @(activeTab == "anagrafica" ? "show active" : "")" id="pane-anagrafica" role="tabpanel">
            
            <!-- ========== SEZIONE MACRO VOCI ========== -->
            <div class="card mb-4">
                <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                    <span><i class="fas fa-layer-group me-2"></i>Macro Voci (Categorie)</span>
                    <button type="button" class="btn btn-light btn-sm" data-bs-toggle="modal" data-bs-target="#modalNuovaMacroVoce">
                        <i class="fas fa-plus me-1"></i>Nuova Macro Voce
                    </button>
                </div>
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-hover align-middle mb-0">
                            <thead class="table-light">
                                <tr>
                                    <th style="width: 80px;">Ordine</th>
                                    <th style="width: 120px;">Codice</th>
                                    <th>Descrizione</th>
                                    <th style="width: 80px;" class="text-center">Voci</th>
                                    <th style="width: 80px;" class="text-center">Attiva</th>
                                    <th style="width: 100px;" class="text-end">Azioni</th>
                                </tr>
                            </thead>
                            <tbody>
                                @if (!Model.MacroVoci.Any())
                                {
                                    <tr>
                                        <td colspan="6" class="text-center text-muted py-3">
                                            <i class="fas fa-info-circle me-2"></i>Nessuna macro voce. Crea la prima per raggruppare le voci analitiche.
                                        </td>
                                    </tr>
                                }
                                @foreach (var m in Model.MacroVoci)
                                {
                                    <tr>
                                        <td><span class="badge bg-secondary">@m.Ordine</span></td>
                                        <td class="fw-bold">@m.Codice</td>
                                        <td>@m.Descrizione</td>
                                        <td class="text-center">
                                            <span class="badge bg-info">@m.VociAnalitiche.Count</span>
                                        </td>
                                        <td class="text-center">
                                            @if (m.IsActive)
                                            {
                                                <span class="badge bg-success">SI</span>
                                            }
                                            else
                                            {
                                                <span class="badge bg-secondary">NO</span>
                                            }
                                        </td>
                                        <td class="text-end">
                                            <div class="btn-group btn-group-sm">
                                                <button type="button" class="btn btn-outline-primary"
                                                        data-bs-toggle="modal" data-bs-target="#modalEditMacroVoce"
                                                        data-id="@m.Id"
                                                        data-codice="@m.Codice"
                                                        data-descrizione="@m.Descrizione"
                                                        data-ordine="@m.Ordine"
                                                        data-active="@(m.IsActive ? "true" : "false")">
                                                    <i class="fas fa-edit"></i>
                                                </button>
                                                <form asp-action="DeleteMacroVoce" method="post" class="d-inline"
                                                      onsubmit="return confirm('Eliminare la macro voce @m.Codice?');">
                                                    @Html.AntiForgeryToken()
                                                    <input type="hidden" name="id" value="@m.Id" />
                                                    <input type="hidden" name="anno" value="@Model.Anno" />
                                                    <button type="submit" class="btn btn-outline-danger">
                                                        <i class="fas fa-trash"></i>
                                                    </button>
                                                </form>
                                            </div>
                                        </td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- ========== SEZIONE VOCI ANALITICHE ========== -->
            <div class="card">
                <div class="card-header bg-secondary text-white d-flex justify-content-between align-items-center">
                    <span><i class="fas fa-list me-2"></i>Voci Analitiche</span>
                    <button type="button" class="btn btn-light btn-sm" data-bs-toggle="modal" data-bs-target="#modalNuovaVoce">
                        <i class="fas fa-plus me-1"></i>Nuova Voce
                    </button>
                </div>
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-hover align-middle mb-0">
                            <thead class="table-light">
                                <tr>
                                    <th style="width: 100px;">Codice</th>
                                    <th>Descrizione</th>
                                    <th style="width: 180px;">Macro Voce</th>
                                    <th style="width: 100px;">Metodo</th>
                                    <th style="width: 80px;" class="text-center">Attiva</th>
                                    <th style="width: 100px;" class="text-end">Azioni</th>
                                </tr>
                            </thead>
                            <tbody>
                                @if (!Model.VociTutte.Any())
                                {
                                    <tr>
                                        <td colspan="6" class="text-center text-muted py-3">
                                            <i class="fas fa-info-circle me-2"></i>Nessuna voce analitica. Crea la prima!
                                        </td>
                                    </tr>
                                }
                                @foreach (var v in Model.VociTutte)
                                {
                                    <tr>
                                        <td class="fw-bold">@v.CodiceSpesa</td>
                                        <td>@v.Descrizione</td>
                                        <td>
                                            <form asp-action="AssociaVoceAMacro" method="post" class="d-inline">
                                                @Html.AntiForgeryToken()
                                                <input type="hidden" name="voceId" value="@v.Id" />
                                                <input type="hidden" name="anno" value="@Model.Anno" />
                                                <select name="macroVoceId" class="form-select form-select-sm" onchange="this.form.submit()">
                                                    <option value="">-- Nessuna --</option>
                                                    @foreach (var m in Model.MacroVoci)
                                                    {
                                                        <option value="@m.Id" selected="@(v.MacroVoceBudgetId == m.Id)">@m.Codice - @m.Descrizione</option>
                                                    }
                                                </select>
                                            </form>
                                        </td>
                                        <td><small>@v.MetodoPagamentoDefault</small></td>
                                        <td class="text-center">
                                            @if (v.IsActive)
                                            {
                                                <span class="badge bg-success">SI</span>
                                            }
                                            else
                                            {
                                                <span class="badge bg-secondary">NO</span>
                                            }
                                        </td>
                                        <td class="text-end">
                                            <div class="btn-group btn-group-sm">
                                                <button type="button" class="btn btn-outline-primary"
                                                        data-bs-toggle="modal" data-bs-target="#modalEditVoce"
                                                        data-id="@v.Id"
                                                        data-codice="@v.CodiceSpesa"
                                                        data-descrizione="@v.Descrizione"
                                                        data-metodo="@((int)v.MetodoPagamentoDefault)"
                                                        data-note="@v.NoteDefault"
                                                        data-active="@(v.IsActive ? "true" : "false")"
                                                        data-macrovoceid="@v.MacroVoceBudgetId">
                                                    <i class="fas fa-edit"></i>
                                                </button>
                                                <form asp-action="DeleteVoceSpesaBudget" method="post" class="d-inline"
                                                      onsubmit="return confirm('Eliminare la voce @v.CodiceSpesa?');">
                                                    @Html.AntiForgeryToken()
                                                    <input type="hidden" name="id" value="@v.Id" />
                                                    <input type="hidden" name="anno" value="@Model.Anno" />
                                                    <button type="submit" class="btn btn-outline-danger">
                                                        <i class="fas fa-trash"></i>
                                                    </button>
                                                </form>
                                            </div>
                                        </td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- ===================== TAB PROSPETTO ===================== -->
        <div class="tab-pane fade @(activeTab == "prospetto" ? "show active" : "")" id="pane-prospetto" role="tabpanel">
            
            <!-- Selettore Anno stile calendario -->
            <div class="d-flex align-items-center justify-content-center gap-3 mb-3 py-2 bg-light rounded">
                <a href="@Url.Action("Index", new { anno = Model.Anno - 1, meseDa = Model.MeseDa, meseA = Model.MeseA, pagate = Model.PagateFiltro, nascondiVuote = Model.NascondiVuote, tab = "prospetto" })" 
                   class="btn btn-outline-primary" title="Anno precedente">
                    <i class="fas fa-chevron-left"></i>
                </a>
                <h4 class="mb-0 fw-bold text-primary" style="min-width: 80px; text-align: center;">@Model.Anno</h4>
                <a href="@Url.Action("Index", new { anno = Model.Anno + 1, meseDa = Model.MeseDa, meseA = Model.MeseA, pagate = Model.PagateFiltro, nascondiVuote = Model.NascondiVuote, tab = "prospetto" })" 
                   class="btn btn-outline-primary" title="Anno successivo">
                    <i class="fas fa-chevron-right"></i>
                </a>
                @if (Model.Anno != DateTime.Today.Year)
                {
                    <a href="@Url.Action("Index", new { anno = DateTime.Today.Year, meseDa = Model.MeseDa, meseA = Model.MeseA, pagate = Model.PagateFiltro, nascondiVuote = Model.NascondiVuote, tab = "prospetto" })" 
                       class="btn btn-sm btn-outline-secondary ms-2" title="Torna all'anno corrente">
                        <i class="fas fa-calendar-day me-1"></i>Oggi
                    </a>
                }
            </div>

            <form class="row g-2 align-items-end mb-3" method="get" asp-action="Index">
                <input type="hidden" name="tab" value="prospetto" />
                <input type="hidden" name="anno" value="@Model.Anno" />
                <div class="col-sm-2">
                    <label class="form-label small text-muted">Mese da</label>
                    <select class="form-select form-select-sm" name="meseDa">
                        @foreach (var m in mesi)
                        {
                            <option value="@m.Key" selected="@(Model.MeseDa == m.Key)">@m.Value</option>
                        }
                    </select>
                </div>
                <div class="col-sm-2">
                    <label class="form-label small text-muted">Mese a</label>
                    <select class="form-select form-select-sm" name="meseA">
                        @foreach (var m in mesi)
                        {
                            <option value="@m.Key" selected="@(Model.MeseA == m.Key)">@m.Value</option>
                        }
                    </select>
                </div>
                <div class="col-sm-2">
                    <label class="form-label small text-muted">Pagate</label>
                    <select class="form-select form-select-sm" name="pagate">
                        <option value="@BudgetPagateFiltro.NonPagate" selected="@(Model.PagateFiltro == BudgetPagateFiltro.NonPagate)">Non pagate</option>
                        <option value="@BudgetPagateFiltro.Pagate" selected="@(Model.PagateFiltro == BudgetPagateFiltro.Pagate)">Pagate</option>
                        <option value="@BudgetPagateFiltro.Tutte" selected="@(Model.PagateFiltro == BudgetPagateFiltro.Tutte)">Tutte</option>
                    </select>
                </div>
                <div class="col-sm-2 d-flex align-items-end">
                    <div class="form-check">
                        <input type="hidden" name="nascondiVuote" value="false" />
                        <input class="form-check-input" type="checkbox" name="nascondiVuote" value="true" id="chkNascondiVuote" @(Model.NascondiVuote ? "checked" : "") />
                        <label class="form-check-label small" for="chkNascondiVuote">
                            Nascondi vuote
                        </label>
                    </div>
                </div>
                <div class="col-sm-3">
                    <button class="btn btn-primary btn-sm w-100" type="submit">
                        <i class="fas fa-sync-alt me-1"></i>Filtri - Aggiorna GRID
                    </button>
                </div>
                <div class="col-sm-2 text-end d-flex gap-1 justify-content-end">
                    <a href="@Url.Action("ExportExcel", new { anno = Model.Anno, meseDa = Model.MeseDa, meseA = Model.MeseA, pagate = Model.PagateFiltro, nascondiVuote = Model.NascondiVuote })" 
                       class="btn btn-success btn-sm" title="Esporta in Excel">
                        <i class="fas fa-file-excel"></i>
                    </a>
                    <button type="button" class="btn btn-outline-secondary btn-sm" data-bs-toggle="modal" data-bs-target="#modalCopyFromYear">
                        <i class="fas fa-copy me-1"></i>Da @(Model.Anno - 1)
                    </button>
                </div>
            </form>

            @Html.AntiForgeryToken()

            <!-- Accordion Gestione Banche -->
            <div class="accordion mb-3" id="accordionBanche">
                <div class="accordion-item">
                    <h2 class="accordion-header">
                        <button class="accordion-button collapsed py-2" type="button" data-bs-toggle="collapse" data-bs-target="#collapseBanche" aria-expanded="false" aria-controls="collapseBanche">
                            <i class="fas fa-university me-2"></i>
                            <strong>Gestione Banche</strong>
                            <span class="badge bg-primary ms-2">@Model.Banche.Count</span>
                        </button>
                    </h2>
                    <div id="collapseBanche" class="accordion-collapse collapse" data-bs-parent="#accordionBanche">
                        <div class="accordion-body py-3">
                            <!-- Lista banche esistenti -->
                            @if (Model.Banche.Any())
                            {
                                <table class="table table-sm table-bordered mb-3">
                                    <thead class="table-light">
                                        <tr>
                                            <th style="width: 50%;">Banca</th>
                                            <th style="width: 40%;">IBAN</th>
                                            <th style="width: 10%;">Azioni</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        @foreach (var banca in Model.Banche)
                                        {
                                            <tr>
                                                <td><strong>@banca.Nome</strong></td>
                                                <td><small class="text-muted">@(banca.Iban ?? "-")</small></td>
                                                <td class="text-center">
                                                    <div class="btn-group btn-group-sm">
                                                        <button type="button" class="btn btn-outline-primary btn-sm"
                                                                data-bs-toggle="modal" data-bs-target="#modalEditBanca"
                                                                data-id="@banca.Id" data-nome="@banca.Nome" data-iban="@banca.Iban"
                                                                title="Modifica">
                                                            <i class="fas fa-edit"></i>
                                                        </button>
                                                        <form asp-action="DeleteBanca" method="post" class="d-inline" onsubmit="return confirm('Eliminare questa banca?');">
                                                            @Html.AntiForgeryToken()
                                                            <input type="hidden" name="id" value="@banca.Id" />
                                                            <input type="hidden" name="anno" value="@Model.Anno" />
                                                            <button type="submit" class="btn btn-outline-danger btn-sm" title="Elimina">
                                                                <i class="fas fa-trash"></i>
                                                            </button>
                                                        </form>
                                                    </div>
                                                </td>
                                            </tr>
                                        }
                                    </tbody>
                                </table>
                            }
                            else
                            {
                                <div class="alert alert-info mb-3">
                                    <i class="fas fa-info-circle me-2"></i>Nessuna banca configurata. Aggiungi la prima banca qui sotto.
                                </div>
                            }
                            
                            <!-- Form aggiunta nuova banca -->
                            <div class="card bg-light">
                                <div class="card-body py-2">
                                    <form asp-action="CreateBanca" method="post" class="row g-2 align-items-end">
                                        @Html.AntiForgeryToken()
                                        <input type="hidden" name="anno" value="@Model.Anno" />
                                        <div class="col-md-4">
                                            <label class="form-label small mb-1">Nome Banca</label>
                                            <input type="text" class="form-control form-control-sm" name="nome" placeholder="Es. Intesa Sanpaolo" required />
                                        </div>
                                        <div class="col-md-5">
                                            <label class="form-label small mb-1">IBAN (opzionale)</label>
                                            <input type="text" class="form-control form-control-sm" name="iban" placeholder="IT00..." />
                                        </div>
                                        <div class="col-md-3">
                                            <button type="submit" class="btn btn-success btn-sm w-100">
                                                <i class="fas fa-plus me-1"></i>Aggiungi Banca
                                            </button>
                                        </div>
                                    </form>
                                </div>
                            </div>
                            
                            <small class="text-muted d-block mt-2">
                                <i class="fas fa-info-circle me-1"></i>I saldi delle banche si inseriscono direttamente nella griglia del prospetto qui sotto.
                            </small>
                        </div>
                    </div>
                </div>
            </div>

            <div class="budget-grid-wrap">
                <table class="table table-bordered align-middle budget-grid">
                    <thead class="table-light">
                        <tr>
                            <th>Voce</th>
                            @for (int m = Model.MeseDa; m <= Model.MeseA; m++)
                            {
                                <th>@mesi[m]</th>
                            }
                            <th>Tot.</th>
                        </tr>
                    </thead>
                    <tbody>
                        @* ========== MACRO VOCI CON ACCORDION ========== *@
                        @foreach (var macro in Model.MacroVoci)
                        {
                            var vociMacro = Model.Voci.Where(v => v.MacroVoceBudgetId == macro.Id).ToList();
                            var haVoci = vociMacro.Any();
                            
                            // Calcola totali macro voce per mese
                            var totaliMacroMese = new Dictionary<int, decimal>();
                            decimal totMacroAnno = 0;
                            for (int m = Model.MeseDa; m <= Model.MeseA; m++)
                            {
                                var tot = vociMacro.Sum(v => {
                                    Model.Map.TryGetValue((v.Id, m), out var cell);
                                    return cell?.Importo ?? 0m;
                                });
                                totaliMacroMese[m] = tot;
                                totMacroAnno += tot;
                            }
                            
                            var macroRowId = $"macro_{macro.Id}";
                            
                            <tr class="macro-voce-row table-primary" data-macroid="@macro.Id" style="cursor: pointer;" onclick="@(haVoci ? $"toggleMacroVoce('{macroRowId}')" : "")">
                                <td>
                                    <div class="d-flex align-items-center gap-2">
                                        @if (haVoci)
                                        {
                                            <i class="fas fa-chevron-right macro-chevron" id="chevron_@macroRowId"></i>
                                        }
                                        else
                                        {
                                            <i class="fas fa-folder-open text-muted" title="Nessuna voce analitica associata"></i>
                                        }
                                        <div>
                                            <div class="fw-bold">@macro.Codice</div>
                                            <div class="text-muted small">@macro.Descrizione @(!haVoci ? "(vuota)" : "")</div>
                                        </div>
                                    </div>
                                </td>
                                @for (int m = Model.MeseDa; m <= Model.MeseA; m++)
                                {
                                    var tot = totaliMacroMese[m];
                                    <td class="text-center fw-bold @(tot > 0 ? "text-primary" : "text-muted")">
                                        @(tot == 0 ? "-" : tot.ToString("N0", new System.Globalization.CultureInfo("it-IT")) + "€")
                                    </td>
                                }
                                <td class="fw-bold @(totMacroAnno > 0 ? "text-primary" : "text-muted")">@(totMacroAnno == 0 ? "-" : totMacroAnno.ToString("N0", new System.Globalization.CultureInfo("it-IT")) + "€")</td>
                            </tr>
                            
                            @* Voci analitiche sotto la macro voce (hidden by default) *@
                            @if (haVoci)
                            {
                            @foreach (var v in vociMacro)
                            {
                                decimal totRiga = 0;
                                <tr class="voce-analitica-row @macroRowId" style="display: none;">
                                    <td style="padding-left: 30px;">
                                        <div class="budget-voce-actions">
                                            <div class="voce-info" title="@v.CodiceSpesa - @v.Descrizione">
                                                <div class="fw-bold" style="font-size: 0.85rem;">@v.CodiceSpesa</div>
                                                <div class="text-muted" style="font-size: 0.7rem;">@v.Descrizione</div>
                                            </div>
                                            <button type="button" class="btn btn-sm btn-outline-secondary"
                                                    title="Azioni rapide"
                                                    onclick="event.stopPropagation(); openAzioniVoce(@v.Id, '@v.CodiceSpesa', '@v.Descrizione')">
                                                <i class="fas fa-bolt"></i>
                                            </button>
                                        </div>
                                    </td>
                                    @for (int m = Model.MeseDa; m <= Model.MeseA; m++)
                                    {
                                        Model.Map.TryGetValue((v.Id, m), out var cell);
                                        var value = cell?.Importo ?? 0m;
                                        if (value != 0) totRiga += value;
                                        var isPagata = cell?.Pagata ?? false;
                                        var cellClass = isPagata ? "cell-pagata" : (value != 0 ? "cell-da-pagare" : "");

                                        <td class="@cellClass">
                                            <input type="text"
                                                   class="form-control form-control-sm text-center budget-cell"
                                                   value="@(value == 0 ? "" : ((int)value).ToString("N0", new System.Globalization.CultureInfo("it-IT")))"
                                                   data-voceid="@v.Id"
                                                   data-anno="@Model.Anno"
                                                   data-mese="@m"
                                                   data-pagata="@(isPagata ? "true" : "false")"
                                                   data-macroid="@macro.Id"
                                                   placeholder="0"
                                                   onclick="event.stopPropagation();" />
                                        </td>
                                    }
                                    <td class="fw-bold">@totRiga.ToString("N0", new System.Globalization.CultureInfo("it-IT"))€</td>
                                </tr>
                            }
                            }
                        }
                        
                        @* ========== VOCI SENZA MACRO VOCE ========== *@
                        @if (Model.VociSenzaMacro.Any())
                        {
                            <tr class="table-warning">
                                <td colspan="@(Model.MeseA - Model.MeseDa + 3)" class="py-1">
                                    <small><i class="fas fa-exclamation-triangle me-1"></i>Voci non categorizzate</small>
                                </td>
                            </tr>
                            
                            @foreach (var v in Model.VociSenzaMacro)
                            {
                                decimal totRiga = 0;
                                <tr>
                                    <td>
                                        <div class="budget-voce-actions">
                                            <div class="voce-info" title="@v.CodiceSpesa - @v.Descrizione">
                                                <div class="fw-bold">@v.CodiceSpesa</div>
                                                <div class="text-muted">@v.Descrizione</div>
                                            </div>
                                            <button type="button" class="btn btn-sm btn-outline-secondary"
                                                    title="Azioni rapide"
                                                    onclick="openAzioniVoce(@v.Id, '@v.CodiceSpesa', '@v.Descrizione')">
                                                <i class="fas fa-bolt"></i>
                                            </button>
                                        </div>
                                    </td>
                                    @for (int m = Model.MeseDa; m <= Model.MeseA; m++)
                                    {
                                        Model.Map.TryGetValue((v.Id, m), out var cell);
                                        var value = cell?.Importo ?? 0m;
                                        if (value != 0) totRiga += value;
                                        var isPagata = cell?.Pagata ?? false;
                                        var cellClass = isPagata ? "cell-pagata" : (value != 0 ? "cell-da-pagare" : "");

                                        <td class="@cellClass">
                                            <input type="text"
                                                   class="form-control form-control-sm text-center budget-cell"
                                                   value="@(value == 0 ? "" : ((int)value).ToString("N0", new System.Globalization.CultureInfo("it-IT")))"
                                                   data-voceid="@v.Id"
                                                   data-anno="@Model.Anno"
                                                   data-mese="@m"
                                                   data-pagata="@(isPagata ? "true" : "false")"
                                                   placeholder="0" />
                                        </td>
                                    }
                                    <td class="fw-bold">@totRiga.ToString("N0", new System.Globalization.CultureInfo("it-IT"))€</td>
                                </tr>
                            }
                        }
                    </tbody>
                    <tfoot class="table-light fw-bold">
                        <!-- Riga Totale Spese -->
                        <tr>
                            <td>Tot. Spese</td>
                            @for (int m = Model.MeseDa; m <= Model.MeseA; m++)
                            {
                                <td class="tot-spese-mese" data-mese="@m">@Model.TotaliMese.GetValueOrDefault(m).ToString("N0", new System.Globalization.CultureInfo("it-IT"))€</td>
                            }
                            <td class="tot-spese-anno">@Model.TotaleAnno.ToString("N0", new System.Globalization.CultureInfo("it-IT"))€</td>
                        </tr>
                        
                        <!-- Separatore visivo per sezione Banche -->
                        <tr class="table-secondary">
                            <td colspan="@(Model.MeseA - Model.MeseDa + 3)" class="py-1">
                                <div class="d-flex align-items-center gap-2">
                                    <i class="fas fa-university text-primary"></i>
                                    <span>SALDI BANCHE</span>
                                    <small class="text-muted ms-2">(gestisci banche dall'accordion sopra)</small>
                                </div>
                            </td>
                        </tr>
                        
                        <!-- Righe Banche (una per ogni banca) -->
                        @foreach (var banca in Model.Banche)
                        {
                            decimal totRigaBanca = 0;
                            <tr class="table-light banca-row" data-bancaid="@banca.Id">
                                <td>
                                    <div class="voce-info" title="@banca.Nome">
                                        <div class="fw-bold" style="font-size: 0.8rem;">@banca.Nome</div>
                                        @if (!string.IsNullOrEmpty(banca.Iban))
                                        {
                                            <div class="text-muted" style="font-size: 0.6rem;">@banca.Iban</div>
                                        }
                                    </div>
                                </td>
                                @for (int m = Model.MeseDa; m <= Model.MeseA; m++)
                                {
                                    var saldo = Model.MapSaldiBanche.TryGetValue((banca.Id, m), out var s) ? s : 0;
                                    totRigaBanca += saldo;
                                    <td class="cell-banca">
                                        <input type="text"
                                               class="form-control form-control-sm text-center saldo-banca-cell"
                                               value="@(saldo == 0 ? "" : saldo.ToString("N0", new System.Globalization.CultureInfo("it-IT")))"
                                               data-bancaid="@banca.Id"
                                               data-anno="@Model.Anno"
                                               data-mese="@m"
                                               placeholder="0"
                                               style="font-size: 0.85rem; background: #e3f2fd; border-color: #90caf9;" />
                                    </td>
                                }
                                <td class="fw-bold text-primary banca-tot-riga" data-bancaid="@banca.Id">@(totRigaBanca == 0 ? "-" : totRigaBanca.ToString("N0", new System.Globalization.CultureInfo("it-IT")) + "€")</td>
                            </tr>
                        }
                        
                        @if (!Model.Banche.Any())
                        {
                            <tr class="table-light">
                                <td colspan="@(Model.MeseA - Model.MeseDa + 3)" class="text-center text-muted">
                                    <i class="fas fa-info-circle me-2"></i>Nessuna banca configurata. 
                                    <button type="button" class="btn btn-link btn-sm p-0" data-bs-toggle="modal" data-bs-target="#modalNuovaBanca">Aggiungi la prima banca</button>
                                </td>
                            </tr>
                        }
                        
                        <!-- Riga Totale Banche (nuovi versamenti del mese) -->
                        <tr class="table-info">
                            <td>
                                <strong>Banche mese</strong>
                            </td>
                            @for (int m = Model.MeseDa; m <= Model.MeseA; m++)
                            {
                                var totBanche = Model.TotaliBancheMese.GetValueOrDefault(m);
                                <td class="tot-banche-mese" data-mese="@m">@(totBanche == 0 ? "-" : totBanche.ToString("N0", new System.Globalization.CultureInfo("it-IT")) + "€")</td>
                            }
                            @{
                                var totBancheAnno = Model.TotaliBancheMese.Values.Sum();
                            }
                            <td class="tot-banche-anno">@(totBancheAnno == 0 ? "-" : totBancheAnno.ToString("N0", new System.Globalization.CultureInfo("it-IT")) + "€")</td>
                        </tr>
                        
                        <!-- Riga Saldo Iniziale (Riporto dal mese precedente) -->
                        <tr class="table-light">
                            <td><em>Saldo iniziale</em></td>
                            @for (int m = Model.MeseDa; m <= Model.MeseA; m++)
                            {
                                var saldoIniziale = Model.SaldoInizialeMese.GetValueOrDefault(m);
                                var isFirstMonth = m == Model.MeseDa;
                                <td class="saldo-iniziale-mese @(saldoIniziale < 0 ? "text-danger" : "")" data-mese="@m">
                                    @if (isFirstMonth)
                                    {
                                        <span>@saldoIniziale.ToString("N0", new System.Globalization.CultureInfo("it-IT"))€</span>
                                    }
                                    else
                                    {
                                        <span class="text-muted" title="Riporto dal mese precedente">↳ @saldoIniziale.ToString("N0", new System.Globalization.CultureInfo("it-IT"))€</span>
                                    }
                                </td>
                            }
                            <td></td>
                        </tr>
                        
                        <!-- Riga Differenza (Saldo finale = Saldo iniziale + Banche - Spese) -->
                        <tr class="@(Model.DifferenzaMese.Values.Any(d => d < 0) ? "table-danger" : "table-success")">
                            <td><strong>Saldo finale</strong></td>
                            @for (int m = Model.MeseDa; m <= Model.MeseA; m++)
                            {
                                var diff = Model.DifferenzaMese.GetValueOrDefault(m);
                                <td class="differenza-mese @(diff < 0 ? "text-danger fw-bold" : "text-success")" data-mese="@m">
                                    @diff.ToString("N0", new System.Globalization.CultureInfo("it-IT"))€
                                </td>
                            }
                            @{
                                var saldoFinale = Model.DifferenzaMese.GetValueOrDefault(Model.MeseA);
                            }
                            <td class="differenza-anno @(saldoFinale < 0 ? "text-danger fw-bold" : "text-success")">
                                @saldoFinale.ToString("N0", new System.Globalization.CultureInfo("it-IT"))€
                            </td>
                        </tr>
                    </tfoot>
                </table>
            </div>

            <div class="d-flex justify-content-between align-items-center mt-2">
                <small class="text-muted">Suggerimento: modifica importo in cella → esci dalla cella per salvare. Doppio click apre dettaglio (pagata/metodo/note).</small>
                @if (Model.NascondiVuote)
                {
                    <a href="@Url.Action("Index", new { anno = Model.Anno, meseDa = Model.MeseDa, meseA = Model.MeseA, pagate = Model.PagateFiltro, nascondiVuote = false, tab = "prospetto" })" 
                       class="btn btn-sm btn-outline-info">
                        <i class="fas fa-eye me-1"></i>Mostra tutte le voci
                    </a>
                }
            </div>
        </div>
    </div>
</div>

<!-- ===================== MODAL AZIONI VOCE (NON tagliato dallo scroll) ===================== -->
<div class="modal fade" id="modalAzioniVoce" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-secondary text-white">
                <h5 class="modal-title"><i class="fas fa-bolt me-2"></i>Azioni voce</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="fw-bold" id="azioniVoceLabel"></div>
                <input type="hidden" id="azioniVoceId" />
                <div class="d-grid gap-2 mt-3">
                    <button type="button" class="btn btn-outline-dark"
                            onclick="openBulkRange(parseInt(document.getElementById('azioniVoceId').value,10), azioniVoceCodice, azioniVoceDescr, 1, 12)">
                        <i class="fas fa-copy me-2"></i>Compila tutto l'anno
                    </button>
                    <button type="button" class="btn btn-outline-dark"
                            onclick="openBulkRange(parseInt(document.getElementById('azioniVoceId').value,10), azioniVoceCodice, azioniVoceDescr, @Model.MeseDa, @Model.MeseA)">
                        <i class="fas fa-arrows-alt-h me-2"></i>Compila intervallo (visibile)
                    </button>
                    <button type="button" class="btn btn-outline-dark"
                            onclick="openBulkMonths(parseInt(document.getElementById('azioniVoceId').value,10), azioniVoceCodice, azioniVoceDescr)">
                        <i class="fas fa-calendar-check me-2"></i>Compila mesi selezionati
                    </button>
                    <button type="button" class="btn btn-outline-danger"
                            onclick="openClearVoce(parseInt(document.getElementById('azioniVoceId').value,10), azioniVoceCodice, azioniVoceDescr)">
                        <i class="fas fa-eraser me-2"></i>Azzera voce (anno)
                    </button>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Chiudi</button>
            </div>
        </div>
    </div>
</div>

<!-- ===================== MODAL BULK RANGE ===================== -->
<div class="modal fade" id="modalBulkRange" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <form asp-action="ApplyBudgetVoce" method="post">
                @Html.AntiForgeryToken()
                <input type="hidden" name="voceId" id="bulkRangeVoceId" />
                <input type="hidden" name="anno" value="@Model.Anno" />
                <input type="hidden" name="ritornoMeseDa" value="@Model.MeseDa" />
                <input type="hidden" name="ritornoMeseA" value="@Model.MeseA" />
                <input type="hidden" name="ritornoPagate" value="@Model.PagateFiltro" />
                <input type="hidden" name="tab" value="prospetto" />
                <div class="modal-header bg-secondary text-white">
                    <h5 class="modal-title"><i class="fas fa-copy me-2"></i>Compila intervallo</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="small text-muted mb-2" id="bulkRangeVoceLabel"></div>
                    <div class="row g-2">
                        <div class="col-6">
                            <label class="form-label">Da mese</label>
                            <select class="form-select" name="meseDa" id="bulkRangeMeseDa">
                                @foreach (var m in mesi)
                                {
                                    <option value="@m.Key">@m.Value</option>
                                }
                            </select>
                        </div>
                        <div class="col-6">
                            <label class="form-label">A mese</label>
                            <select class="form-select" name="meseA" id="bulkRangeMeseA">
                                @foreach (var m in mesi)
                                {
                                    <option value="@m.Key">@m.Value</option>
                                }
                            </select>
                        </div>
                    </div>
                    <div class="mt-3">
                        <label class="form-label">Importo</label>
                        <div class="input-group">
                            <span class="input-group-text">€</span>
                            <input type="text" class="form-control" name="importo" placeholder="0,00" required />
                        </div>
                        <small class="text-muted">Inserisci un importo: verrà copiato su tutti i mesi selezionati</small>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annulla</button>
                    <button type="submit" class="btn btn-dark">Applica</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- ===================== MODAL BULK MONTHS ===================== -->
<div class="modal fade" id="modalBulkMonths" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <form asp-action="ApplyBudgetVoceMesi" method="post">
                @Html.AntiForgeryToken()
                <input type="hidden" name="voceId" id="bulkMonthsVoceId" />
                <input type="hidden" name="anno" value="@Model.Anno" />
                <input type="hidden" name="mesiCsv" id="bulkMonthsCsv" />
                <input type="hidden" name="ritornoMeseDa" value="@Model.MeseDa" />
                <input type="hidden" name="ritornoMeseA" value="@Model.MeseA" />
                <input type="hidden" name="ritornoPagate" value="@Model.PagateFiltro" />
                <input type="hidden" name="tab" value="prospetto" />
                <div class="modal-header bg-secondary text-white">
                    <h5 class="modal-title"><i class="fas fa-calendar-check me-2"></i>Compila mesi selezionati</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="small text-muted mb-2" id="bulkMonthsVoceLabel"></div>
                    <div class="d-flex flex-wrap gap-2 mb-3">
                        @foreach (var m in mesi)
                        {
                            <div class="form-check form-check-inline">
                                <input class="form-check-input bulk-month-check" type="checkbox" value="@m.Key" id="bm_@m.Key">
                                <label class="form-check-label" for="bm_@m.Key">@m.Value</label>
                            </div>
                        }
                    </div>
                    <div>
                        <label class="form-label">Importo</label>
                        <div class="input-group">
                            <span class="input-group-text">€</span>
                            <input type="text" class="form-control" name="importo" placeholder="0,00" required />
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annulla</button>
                    <button type="submit" class="btn btn-dark" onclick="buildMonthsCsv()">Applica</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- ===================== MODAL CLEAR VOCE ===================== -->
<div class="modal fade" id="modalClearVoce" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <form asp-action="ClearBudgetVoce" method="post">
                @Html.AntiForgeryToken()
                <input type="hidden" name="voceId" id="clearVoceId" />
                <input type="hidden" name="anno" value="@Model.Anno" />
                <input type="hidden" name="ritornoMeseDa" value="@Model.MeseDa" />
                <input type="hidden" name="ritornoMeseA" value="@Model.MeseA" />
                <input type="hidden" name="ritornoPagate" value="@Model.PagateFiltro" />
                <input type="hidden" name="tab" value="prospetto" />
                <div class="modal-header bg-danger text-white">
                    <h5 class="modal-title"><i class="fas fa-eraser me-2"></i>Azzera voce</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <p class="mb-0">Confermi azzeramento budget per:</p>
                    <div class="fw-bold" id="clearVoceLabel"></div>
                    <small class="text-muted">Verranno eliminate tutte le righe mensili dell'anno selezionato.</small>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annulla</button>
                    <button type="submit" class="btn btn-danger">Azzera</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- ===================== MODAL NUOVA MACRO VOCE ===================== -->
<div class="modal fade" id="modalNuovaMacroVoce" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <form asp-action="CreateMacroVoce" method="post">
                @Html.AntiForgeryToken()
                <input type="hidden" name="anno" value="@Model.Anno" />
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title"><i class="fas fa-layer-group me-2"></i>Nuova Macro Voce</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">Codice <span class="text-danger">*</span></label>
                        <input type="text" class="form-control" name="codice" required maxlength="50" placeholder="Es: PERSONALE" style="text-transform: uppercase;" />
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Descrizione <span class="text-danger">*</span></label>
                        <input type="text" class="form-control" name="descrizione" required maxlength="200" placeholder="Es: Costi del personale" />
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annulla</button>
                    <button type="submit" class="btn btn-primary">Salva</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- ===================== MODAL EDIT MACRO VOCE ===================== -->
<div class="modal fade" id="modalEditMacroVoce" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <form asp-action="UpdateMacroVoce" method="post">
                @Html.AntiForgeryToken()
                <input type="hidden" name="anno" value="@Model.Anno" />
                <input type="hidden" name="id" id="editMacroVoceId" />
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title"><i class="fas fa-edit me-2"></i>Modifica Macro Voce</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">Codice</label>
                        <input type="text" class="form-control" name="codice" id="editMacroVoceCodice" required maxlength="50" style="text-transform: uppercase;" />
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Descrizione</label>
                        <input type="text" class="form-control" name="descrizione" id="editMacroVoceDescrizione" required maxlength="200" />
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Ordine</label>
                        <input type="number" class="form-control" name="ordine" id="editMacroVoceOrdine" min="0" />
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" value="true" id="editMacroVoceActive" name="isActive" />
                        <label class="form-check-label" for="editMacroVoceActive">Attiva</label>
                    </div>
                    <input type="hidden" name="isActive" value="false" />
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annulla</button>
                    <button type="submit" class="btn btn-primary">Salva</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- ===================== MODAL NUOVA VOCE ===================== -->
<div class="modal fade" id="modalNuovaVoce" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <form asp-action="CreateVoceSpesaBudget" method="post">
                @Html.AntiForgeryToken()
                <input type="hidden" name="anno" value="@Model.Anno" />
                <div class="modal-header bg-success text-white">
                    <h5 class="modal-title"><i class="fas fa-plus me-2"></i>Nuova voce di spesa</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">Codice spesa <span class="text-danger">*</span></label>
                        <input type="text" class="form-control" name="codiceSpesa" required maxlength="50" placeholder="Es: AFFITTO" />
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Descrizione <span class="text-danger">*</span></label>
                        <input type="text" class="form-control" name="descrizione" required maxlength="200" placeholder="Es: Affitto ufficio" />
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Macro Voce (categoria)</label>
                        <select class="form-select" name="macroVoceId">
                            <option value="">-- Nessuna (assegna dopo) --</option>
                            @foreach (var m in Model.MacroVoci)
                            {
                                <option value="@m.Id">@m.Codice - @m.Descrizione</option>
                            }
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Metodo pagamento default</label>
                        <select class="form-select" name="metodoPagamentoDefault">
                            @foreach (var m in Enum.GetValues<MetodoPagamentoBudget>())
                            {
                                <option value="@((int)m)">@m</option>
                            }
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Note default (opzionale)</label>
                        <textarea class="form-control" name="noteDefault" rows="2" maxlength="500"></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annulla</button>
                    <button type="submit" class="btn btn-success">Salva</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- ===================== MODAL EDIT VOCE ===================== -->
<div class="modal fade" id="modalEditVoce" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <form asp-action="UpdateVoceSpesaBudget" method="post">
                @Html.AntiForgeryToken()
                <input type="hidden" name="anno" value="@Model.Anno" />
                <input type="hidden" name="id" id="editVoceId" />
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title"><i class="fas fa-edit me-2"></i>Modifica voce</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">Codice spesa</label>
                        <input type="text" class="form-control" name="codiceSpesa" id="editVoceCodice" required maxlength="50" />
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Descrizione</label>
                        <input type="text" class="form-control" name="descrizione" id="editVoceDescrizione" required maxlength="200" />
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Metodo pagamento default</label>
                        <select class="form-select" name="metodoPagamentoDefault" id="editVoceMetodo">
                            @foreach (var m in Enum.GetValues<MetodoPagamentoBudget>())
                            {
                                <option value="@((int)m)">@m</option>
                            }
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Note default</label>
                        <textarea class="form-control" name="noteDefault" id="editVoceNote" rows="2" maxlength="500"></textarea>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" value="true" id="editVoceActive" name="isActive" />
                        <label class="form-check-label" for="editVoceActive">Attiva</label>
                    </div>
                    <input type="hidden" name="isActive" value="false" />
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annulla</button>
                    <button type="submit" class="btn btn-primary">Salva</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- ===================== MODAL DETTAGLIO CELLA ===================== -->
<div class="modal fade" id="modalDettaglioCella" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <form id="formDettaglioCella">
                @Html.AntiForgeryToken()
                <div class="modal-header bg-info text-white">
                    <h5 class="modal-title"><i class="fas fa-info-circle me-2"></i>Dettaglio cella</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="small text-muted mb-2">
                        <span class="fw-bold" id="detVoceLabel"></span> - <span id="detMeseLabel"></span> @Model.Anno
                    </div>
                    <input type="hidden" id="detVoceId" />
                    <input type="hidden" id="detAnno" value="@Model.Anno" />
                    <input type="hidden" id="detMese" />
                    <div class="mb-3">
                        <label class="form-label">Importo</label>
                        <div class="input-group">
                            <span class="input-group-text">€</span>
                            <input type="text" class="form-control" id="detImporto" placeholder="0,00" />
                        </div>
                        <small class="text-muted">Usa la virgola come separatore decimale</small>
                    </div>
                    <div class="form-check mb-3">
                        <input class="form-check-input" type="checkbox" id="detPagata">
                        <label class="form-check-label" for="detPagata">Pagata</label>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Metodo pagamento</label>
                        <select class="form-select" id="detMetodoPagamento">
                            <option value="">(default voce)</option>
                            @foreach (var m in Enum.GetValues<MetodoPagamentoBudget>())
                            {
                                <option value="@((int)m)">@m</option>
                            }
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Note</label>
                        <textarea class="form-control" id="detNote" rows="2" maxlength="500"></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Chiudi</button>
                    <button type="submit" class="btn btn-info text-white"><i class="fas fa-save me-2"></i>Salva</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- ===================== MODAL COPIA DA ANNO PRECEDENTE ===================== -->
<div class="modal fade" id="modalCopyFromYear" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <form asp-action="CopyFromPreviousYear" method="post">
                @Html.AntiForgeryToken()
                <input type="hidden" name="anno" value="@Model.Anno" />
                <div class="modal-header bg-secondary text-white">
                    <h5 class="modal-title"><i class="fas fa-copy me-2"></i>Copia da anno precedente</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="alert alert-info mb-3">
                        <i class="fas fa-info-circle me-2"></i>
                        Questa operazione copierà tutti i dati del budget dall'anno <strong>@(Model.Anno - 1)</strong> all'anno <strong>@Model.Anno</strong>.
                    </div>
                    <p class="mb-2">Verranno copiati:</p>
                    <ul class="mb-3">
                        <li>Tutti gli importi mensili</li>
                        <li>Metodi di pagamento e note</li>
                    </ul>
                    <div class="alert alert-warning mb-0">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        <strong>Attenzione:</strong> Se ci sono già dati nell'anno @Model.Anno, verranno <strong>sovrascritti</strong>.
                        <br>Le celle copiate saranno impostate come "non pagate".
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annulla</button>
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-copy me-2"></i>Copia da @(Model.Anno - 1)
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- ===================== MODAL EDIT BANCA ===================== -->
<div class="modal fade" id="modalEditBanca" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <form asp-action="UpdateBanca" method="post">
                @Html.AntiForgeryToken()
                <input type="hidden" name="anno" value="@Model.Anno" />
                <input type="hidden" name="id" id="editBancaId" />
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title"><i class="fas fa-edit me-2"></i>Modifica Banca</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">Nome Banca</label>
                        <input type="text" class="form-control" name="nome" id="editBancaNome" required maxlength="100" />
                    </div>
                    <div class="mb-3">
                        <label class="form-label">IBAN</label>
                        <input type="text" class="form-control" name="iban" id="editBancaIban" maxlength="50" />
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annulla</button>
                    <button type="submit" class="btn btn-primary">Salva</button>
                </div>
            </form>
        </div>
    </div>
</div>

@section Scripts {
<script>
    const mesiLabel = {
        1: 'Gen', 2: 'Feb', 3: 'Mar', 4: 'Apr', 5: 'Mag', 6: 'Giu',
        7: 'Lug', 8: 'Ago', 9: 'Set', 10: 'Ott', 11: 'Nov', 12: 'Dic'
    };

    // Funzione per parsare un valore formattato italiano (1.234 -> 1234)
    function parseItalianNumber(str) {
        if (!str || str.trim() === '') return 0;
        // Rimuove punti delle migliaia e sostituisce virgola con punto per decimali
        return parseFloat(str.replace(/\./g, '').replace(',', '.')) || 0;
    }

    // Funzione per formattare un numero in stile italiano (1234 -> 1.234)
    function formatItalianNumber(num) {
        if (num === 0) return '0';
        return Math.round(num).toLocaleString('it-IT');
    }

    // Aggiorna tutti i totali (riga, colonna, generale)
    function updateAllTotals() {
        const table = document.querySelector('table.budget-grid');
        if (!table) return;

        const tbody = table.querySelector('tbody');
        const tfoot = table.querySelector('tfoot');
        if (!tbody || !tfoot) return;

        const rows = tbody.querySelectorAll('tr');
        const footerRow = tfoot.querySelector('tr');
        const footerCells = footerRow.querySelectorAll('td');

        // Numero di colonne mesi (esclusa prima e ultima)
        const numMesi = footerCells.length - 2; // -1 per "Tot." e -1 per totale generale

        // Array per totali colonne
        const totaliColonne = new Array(numMesi).fill(0);
        let totaleGenerale = 0;

        // Calcola totali per ogni riga
        rows.forEach(row => {
            const cells = row.querySelectorAll('td');
            let totaleRiga = 0;

            // Scorre le celle dei mesi (dalla 2a all'ultima-1)
            for (let i = 1; i < cells.length - 1; i++) {
                const input = cells[i].querySelector('.budget-cell');
                if (input) {
                    const val = parseItalianNumber(input.value);
                    totaleRiga += val;
                    totaliColonne[i - 1] += val;
                }
            }

            // Aggiorna totale riga (ultima cella)
            const lastCell = cells[cells.length - 1];
            if (lastCell) {
                lastCell.textContent = formatItalianNumber(totaleRiga) + '€';
            }

            totaleGenerale += totaleRiga;
        });

        // Aggiorna totali colonne nel footer
        for (let i = 0; i < numMesi; i++) {
            footerCells[i + 1].textContent = formatItalianNumber(totaliColonne[i]) + '€';
        }

        // Aggiorna totale generale (ultima cella footer)
        footerCells[footerCells.length - 1].textContent = formatItalianNumber(totaleGenerale) + '€';
        
        // Ricalcola anche i riporti banche/cash flow
        updateAllBancheTotals();
    }

    // Modal edit macro voce: preload data
    document.getElementById('modalEditMacroVoce')?.addEventListener('show.bs.modal', function (event) {
        const btn = event.relatedTarget;
        if (!btn) return;
        document.getElementById('editMacroVoceId').value = btn.getAttribute('data-id');
        document.getElementById('editMacroVoceCodice').value = btn.getAttribute('data-codice');
        document.getElementById('editMacroVoceDescrizione').value = btn.getAttribute('data-descrizione');
        document.getElementById('editMacroVoceOrdine').value = btn.getAttribute('data-ordine');
        document.getElementById('editMacroVoceActive').checked = btn.getAttribute('data-active') === 'true';
    });

    // Modal edit voce: preload data
    document.getElementById('modalEditVoce')?.addEventListener('show.bs.modal', function (event) {
        const btn = event.relatedTarget;
        if (!btn) return;
        document.getElementById('editVoceId').value = btn.getAttribute('data-id');
        document.getElementById('editVoceCodice').value = btn.getAttribute('data-codice');
        document.getElementById('editVoceDescrizione').value = btn.getAttribute('data-descrizione');
        document.getElementById('editVoceMetodo').value = btn.getAttribute('data-metodo');
        document.getElementById('editVoceNote').value = btn.getAttribute('data-note') || '';
        document.getElementById('editVoceActive').checked = btn.getAttribute('data-active') === 'true';
    });

    // Anti-forgery token for fetch
    function getAntiForgery() {
        const input = document.querySelector('input[name="__RequestVerificationToken"]');
        return input ? input.value : '';
    }

    // Inline save on blur + aggiornamento totali in tempo reale
    document.querySelectorAll('.budget-cell').forEach(inp => {
        // Aggiorna totali quando l'utente digita
        inp.addEventListener('input', function () {
            updateAllTotals();
        });

        // Formatta il valore quando esce dalla cella
        inp.addEventListener('blur', async function () {
            const voceId = this.getAttribute('data-voceid');
            const anno = this.getAttribute('data-anno');
            const mese = this.getAttribute('data-mese');
            
            // Parsa e riformatta il valore
            const numValue = parseItalianNumber(this.value);
            this.value = numValue === 0 ? '' : formatItalianNumber(numValue);
            
            // Invia al server
            const importo = numValue.toString().replace('.', ',');

            const form = new URLSearchParams();
            form.append('voceId', voceId);
            form.append('anno', anno);
            form.append('mese', mese);
            form.append('importo', importo);
            form.append('__RequestVerificationToken', getAntiForgery());

            const res = await fetch('@Url.Action("SaveBudgetCell", "BudgetStudio")', {
                method: 'POST',
                headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                body: form.toString()
            });
            if (!res.ok) {
                console.error('Errore salvataggio cella', await res.text());
            }
        });

        // Double click: open detail modal
        inp.addEventListener('dblclick', async function () {
            const voceId = this.getAttribute('data-voceid');
            const anno = this.getAttribute('data-anno');
            const mese = this.getAttribute('data-mese');

            const url = '@Url.Action("GetBudgetCell", "BudgetStudio")' + `?voceId=${voceId}&anno=${anno}&mese=${mese}`;
            const res = await fetch(url);
            const data = await res.json();

            document.getElementById('detVoceId').value = voceId;
            document.getElementById('detAnno').value = anno;
            document.getElementById('detMese').value = mese;
            document.getElementById('detVoceLabel').textContent = `${data.voceCodice} - ${data.voceDescrizione}`;
            document.getElementById('detMeseLabel').textContent = mesiLabel[parseInt(mese, 10)] || mese;
            document.getElementById('detImporto').value = (data.importo || 0).toString().replace('.', ',');
            document.getElementById('detPagata').checked = data.pagata === true;
            document.getElementById('detMetodoPagamento').value = data.metodoPagamento ?? '';
            document.getElementById('detNote').value = data.note ?? '';

            const modal = new bootstrap.Modal(document.getElementById('modalDettaglioCella'));
            modal.show();
        });
    });

    // Save detail modal
    document.getElementById('formDettaglioCella')?.addEventListener('submit', async function (e) {
        e.preventDefault();
        const voceId = document.getElementById('detVoceId').value;
        const anno = document.getElementById('detAnno').value;
        const mese = document.getElementById('detMese').value;

        const form = new URLSearchParams();
        form.append('voceId', voceId);
        form.append('anno', anno);
        form.append('mese', mese);
        form.append('importo', document.getElementById('detImporto').value);
        form.append('pagata', document.getElementById('detPagata').checked ? 'true' : 'false');
        const mp = document.getElementById('detMetodoPagamento').value;
        if (mp !== '') form.append('metodoPagamento', mp);
        form.append('note', document.getElementById('detNote').value);
        form.append('__RequestVerificationToken', getAntiForgery());

        const res = await fetch('@Url.Action("SaveBudgetCellDetail", "BudgetStudio")', {
            method: 'POST',
            headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
            body: form.toString()
        });

        if (!res.ok) {
            console.error('Errore salvataggio dettaglio', await res.text());
            return;
        }
        // Rimani nel prospetto dopo salvataggio
        const url = new URL(window.location.href);
        url.searchParams.set('tab', 'prospetto');
        window.location.href = url.toString();
    });

    // Bulk helpers
    window.openBulkRange = function (voceId, codice, descr, meseDa, meseA) {
        document.getElementById('bulkRangeVoceId').value = voceId;
        document.getElementById('bulkRangeVoceLabel').textContent = `${codice} - ${descr}`;
        document.getElementById('bulkRangeMeseDa').value = meseDa;
        document.getElementById('bulkRangeMeseA').value = meseA;
        new bootstrap.Modal(document.getElementById('modalBulkRange')).show();
    };

    window.openBulkMonths = function (voceId, codice, descr) {
        document.getElementById('bulkMonthsVoceId').value = voceId;
        document.getElementById('bulkMonthsVoceLabel').textContent = `${codice} - ${descr}`;
        document.querySelectorAll('.bulk-month-check').forEach(c => c.checked = false);
        document.getElementById('bulkMonthsCsv').value = '';
        new bootstrap.Modal(document.getElementById('modalBulkMonths')).show();
    };

    window.buildMonthsCsv = function () {
        const mesi = Array.from(document.querySelectorAll('.bulk-month-check'))
            .filter(c => c.checked)
            .map(c => c.value);
        document.getElementById('bulkMonthsCsv').value = mesi.join(',');
    };

    window.openClearVoce = function (voceId, codice, descr) {
        document.getElementById('clearVoceId').value = voceId;
        document.getElementById('clearVoceLabel').textContent = `${codice} - ${descr}`;
        new bootstrap.Modal(document.getElementById('modalClearVoce')).show();
    };

    // Azioni voce (modale)
    let azioniVoceCodice = '';
    let azioniVoceDescr = '';
    window.openAzioniVoce = function (voceId, codice, descr) {
        azioniVoceCodice = codice;
        azioniVoceDescr = descr;
        document.getElementById('azioniVoceId').value = voceId;
        document.getElementById('azioniVoceLabel').textContent = `${codice} - ${descr}`;
        new bootstrap.Modal(document.getElementById('modalAzioniVoce')).show();
    };
    
    // Toggle macro voce accordion
    window.toggleMacroVoce = function(macroRowId) {
        const rows = document.querySelectorAll('.' + macroRowId);
        const chevron = document.getElementById('chevron_' + macroRowId);
        
        const isVisible = rows.length > 0 && rows[0].style.display !== 'none';
        
        rows.forEach(row => {
            row.style.display = isVisible ? 'none' : 'table-row';
        });
        
        if (chevron) {
            chevron.classList.toggle('expanded', !isVisible);
        }
    };

    // ===================== GESTIONE SALDI BANCHE NEL PROSPETTO =====================
    
    // Salvataggio saldo banca inline (nel prospetto)
    document.querySelectorAll('.saldo-banca-cell').forEach(inp => {
        let originalValue = inp.value;
        
        inp.addEventListener('focus', function() {
            originalValue = this.value;
        });
        
        // Aggiorna totali quando l'utente digita
        inp.addEventListener('input', function () {
            updateAllBancheTotals();
        });
        
        inp.addEventListener('blur', async function () {
            const numValue = parseItalianNumber(this.value);
            this.value = numValue === 0 ? '' : formatItalianNumber(numValue);
            
            const bancaId = this.getAttribute('data-bancaid');
            const anno = this.getAttribute('data-anno');
            const mese = this.getAttribute('data-mese');
            const saldo = numValue.toString().replace('.', ',');
            
            const form = new URLSearchParams();
            form.append('bancaId', bancaId);
            form.append('anno', anno);
            form.append('mese', mese);
            form.append('saldo', saldo);
            form.append('__RequestVerificationToken', getAntiForgery());

            try {
                const res = await fetch('@Url.Action("SaveSaldoBanca", "BudgetStudio")', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                    body: form.toString()
                });
                const data = await res.json();
                if (data.ok) {
                    originalValue = this.value;
                    updateAllBancheTotals();
                } else {
                    console.error('Errore salvataggio saldo banca:', data.error);
                    this.value = originalValue;
                }
            } catch (err) {
                console.error('Errore salvataggio saldo banca:', err);
                this.value = originalValue;
            }
        });
    });
    
    // Aggiorna tutti i totali delle banche
    function updateAllBancheTotals() {
        const table = document.querySelector('table.budget-grid');
        if (!table) return;
        
        const tfoot = table.querySelector('tfoot');
        if (!tfoot) return;
        
        // Calcola totali per mese (colonna) e per banca (riga)
        const bancheRows = tfoot.querySelectorAll('.banca-row');
        const totaliMese = {};
        let totaleGeneraleBanche = 0;
        
        // Inizializza totali mese
        document.querySelectorAll('.tot-banche-mese').forEach(td => {
            const mese = td.getAttribute('data-mese');
            totaliMese[mese] = 0;
        });
        
        // Calcola per ogni riga banca
        bancheRows.forEach(row => {
            const bancaId = row.getAttribute('data-bancaid');
            let totRiga = 0;
            
            row.querySelectorAll('.saldo-banca-cell').forEach(inp => {
                const mese = inp.getAttribute('data-mese');
                const val = parseItalianNumber(inp.value);
                totRiga += val;
                totaliMese[mese] = (totaliMese[mese] || 0) + val;
            });
            
            // Aggiorna totale riga banca
            const totCell = row.querySelector('.banca-tot-riga');
            if (totCell) {
                totCell.textContent = totRiga === 0 ? '-' : formatItalianNumber(totRiga) + '€';
            }
            
            totaleGeneraleBanche += totRiga;
        });
        
        // Aggiorna totali colonne banche
        document.querySelectorAll('.tot-banche-mese').forEach(td => {
            const mese = td.getAttribute('data-mese');
            const tot = totaliMese[mese] || 0;
            td.textContent = tot === 0 ? '-' : formatItalianNumber(tot) + '€';
        });
        
        // Aggiorna totale anno banche
        const totAnno = document.querySelector('.tot-banche-anno');
        if (totAnno) {
            totAnno.textContent = totaleGeneraleBanche === 0 ? '-' : formatItalianNumber(totaleGeneraleBanche) + '€';
        }
        
        // Ottieni lista mesi ordinati
        const mesiOrdinati = Object.keys(totaliMese).map(m => parseInt(m)).sort((a, b) => a - b);
        
        // Calcola cash flow con riporti cumulativi
        let riporto = 0;
        let ultimoSaldoFinale = 0;
        
        mesiOrdinati.forEach((mese, index) => {
            // Recupera spese del mese
            const speseMeseCell = document.querySelector(`.tot-spese-mese[data-mese="${mese}"]`);
            const spese = speseMeseCell ? parseItalianNumber(speseMeseCell.textContent) : 0;
            
            // Banche/versamenti del mese
            const banche = totaliMese[mese] || 0;
            
            // Saldo iniziale = riporto mese precedente + banche mese
            const saldoIniziale = riporto + banche;
            
            // Aggiorna cella saldo iniziale
            const saldoInizialeCell = document.querySelector(`.saldo-iniziale-mese[data-mese="${mese}"]`);
            if (saldoInizialeCell) {
                if (index === 0) {
                    saldoInizialeCell.innerHTML = formatItalianNumber(saldoIniziale) + '€';
                } else {
                    saldoInizialeCell.innerHTML = '<span class="text-muted" title="Riporto dal mese precedente">↳ ' + formatItalianNumber(saldoIniziale) + '€</span>';
                }
                saldoInizialeCell.classList.toggle('text-danger', saldoIniziale < 0);
            }
            
            // Saldo finale = saldo iniziale - spese
            const saldoFinale = saldoIniziale - spese;
            ultimoSaldoFinale = saldoFinale;
            
            // Aggiorna cella saldo finale (differenza)
            const diffCell = document.querySelector(`.differenza-mese[data-mese="${mese}"]`);
            if (diffCell) {
                diffCell.textContent = formatItalianNumber(saldoFinale) + '€';
                diffCell.classList.toggle('text-danger', saldoFinale < 0);
                diffCell.classList.toggle('fw-bold', saldoFinale < 0);
                diffCell.classList.toggle('text-success', saldoFinale >= 0);
            }
            
            // Il riporto per il mese successivo = saldo finale
            riporto = saldoFinale;
        });
        
        // Aggiorna saldo finale anno (ultimo saldo finale)
        const diffAnnoCell = document.querySelector('.differenza-anno');
        if (diffAnnoCell) {
            diffAnnoCell.textContent = formatItalianNumber(ultimoSaldoFinale) + '€';
            diffAnnoCell.classList.toggle('text-danger', ultimoSaldoFinale < 0);
            diffAnnoCell.classList.toggle('fw-bold', ultimoSaldoFinale < 0);
            diffAnnoCell.classList.toggle('text-success', ultimoSaldoFinale >= 0);
        }
    }
    
    // ===================== MODAL EDIT BANCA =====================
    document.getElementById('modalEditBanca')?.addEventListener('show.bs.modal', function (event) {
        const btn = event.relatedTarget;
        if (!btn) return;
        document.getElementById('editBancaId').value = btn.getAttribute('data-id');
        document.getElementById('editBancaNome').value = btn.getAttribute('data-nome');
        document.getElementById('editBancaIban').value = btn.getAttribute('data-iban') || '';
    });
</script>
}
