@model StudioCG.Web.Models.AttivitaAnnuale
@using StudioCG.Web.Models
@using StudioCG.Web.Services

@{
    ViewData["Title"] = Model.AttivitaTipo?.Nome ?? "Attività";
    var tuttiAnni = ViewBag.TuttiAnni as List<AnnualitaFiscale> ?? new List<AnnualitaFiscale>();
    var clientiDisponibili = ViewBag.ClientiDisponibili as List<Cliente> ?? new List<Cliente>();
    var annoPrecedente = ViewBag.AnnoPrecedente as AnnualitaFiscale;
    var clientiAnnoPrecedente = ViewBag.ClientiAnnoPrecedente as int? ?? 0;
    var searchNome = ViewBag.SearchNome as string;
    var filtroStatoId = ViewBag.FiltroStatoId as int?;
    var ordinamento = ViewBag.Ordinamento as string ?? "asc";
    var statiDisponibili = ViewBag.StatiDisponibili as List<StatoAttivitaTipo> ?? new List<StatoAttivitaTipo>();
}

<div class="d-flex justify-content-between align-items-center mb-4">
    <div>
        <h4 class="mb-1 d-flex align-items-center">
            <i class="@Model.AttivitaTipo?.Icon me-2"></i>@Model.AttivitaTipo?.Nome
            <div class="dropdown ms-2">
                <button class="btn btn-primary btn-sm dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false">
                    @Model.AnnualitaFiscale?.Anno
                </button>
                <ul class="dropdown-menu">
                    @foreach (var anno in tuttiAnni.OrderByDescending(a => a.Anno))
                    {
                        <li>
                            <a class="dropdown-item @(anno.Id == Model.AnnualitaFiscaleId ? "active" : "")" 
                               asp-action="Tipo" asp-route-id="@Model.AttivitaTipoId" asp-route-annoId="@anno.Id">
                                @anno.Anno
                                @if (anno.IsCurrent)
                                {
                                    <span class="badge bg-success ms-2">Corrente</span>
                                }
                            </a>
                        </li>
                    }
                </ul>
            </div>
        </h4>
        @if (!string.IsNullOrEmpty(Model.AttivitaTipo?.Descrizione))
        {
            <p class="text-muted mb-0">@Model.AttivitaTipo.Descrizione</p>
        }
    </div>
    <div class="btn-group">
        <a asp-action="Index" class="btn btn-outline-secondary">
            <i class="fas fa-arrow-left me-1"></i>Torna all'elenco
        </a>
        @if (annoPrecedente != null && clientiAnnoPrecedente > 0)
        {
            <button type="button" class="btn btn-info" data-bs-toggle="modal" data-bs-target="#copiaAnnoModal">
                <i class="fas fa-copy me-1"></i>Copia da @annoPrecedente.Anno (@clientiAnnoPrecedente)
            </button>
        }
        <a asp-action="ExportExcel" asp-route-id="@Model.Id" class="btn btn-success">
            <i class="fas fa-file-excel me-1"></i>Export Excel
        </a>
        <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#nuovoClienteModal">
            <i class="fas fa-plus me-1"></i>Nuovo
        </button>
        <form asp-action="AssegnaTutti" method="post" class="d-inline" onsubmit="return confirm('Assegnare questa attività a tutti i clienti attivi?');">
            <input type="hidden" name="attivitaAnnualeId" value="@Model.Id" />
            <button type="submit" class="btn btn-outline-success">
                <i class="fas fa-user-plus me-1"></i>Assegna a Tutti
            </button>
        </form>
    </div>
</div>

<!-- Statistiche DINAMICHE basate sugli stati configurati -->
@{
    var totale = Model.ClientiAttivita.Count;
    var statsCounts = statiDisponibili.ToDictionary(
        s => s.Id,
        s => Model.ClientiAttivita.Count(ca => ca.StatoAttivitaTipoId == s.Id)
    );
    // Conta anche quelli senza stato assegnato (migrazione incompleta o nuovi)
    var senzaStato = Model.ClientiAttivita.Count(ca => ca.StatoAttivitaTipoId == null);
}

<div class="row mb-4 g-2">
    @foreach (var stato in statiDisponibili)
    {
        var count = statsCounts.GetValueOrDefault(stato.Id, 0);
        var isSelected = filtroStatoId == stato.Id;
        <div class="col">
            <a asp-action="Tipo" asp-route-id="@Model.AttivitaTipoId" asp-route-annoId="@Model.AnnualitaFiscaleId" 
               asp-route-filtroStatoId="@stato.Id" class="text-decoration-none">
                <div class="card @(isSelected ? "border border-3 border-dark" : "")" 
                     style="cursor: pointer; background-color: @stato.ColoreSfondo; color: @stato.ColoreTesto;">
                    <div class="card-body py-2 px-2">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <div class="small">@stato.Nome</div>
                                <div class="fs-4 fw-bold">@count</div>
                            </div>
                            <i class="@stato.Icon fa-lg opacity-50"></i>
                        </div>
                    </div>
                </div>
            </a>
        </div>
    }
    @if (senzaStato > 0)
    {
        <div class="col">
            <div class="card bg-light text-dark">
                <div class="card-body py-2 px-2">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <div class="small">Senza Stato</div>
                            <div class="fs-4 fw-bold">@senzaStato</div>
                        </div>
                        <i class="fas fa-question-circle fa-lg opacity-50"></i>
                    </div>
                </div>
            </div>
        </div>
    }
</div>

<!-- Filtri e Ordinamento -->
<div class="card mb-4">
    <div class="card-body py-2">
        <form asp-action="Tipo" method="get" class="row g-2 align-items-center">
            <input type="hidden" name="id" value="@Model.AttivitaTipoId" />
            <input type="hidden" name="annoId" value="@Model.AnnualitaFiscaleId" />
            <div class="col-md-4">
                <div class="input-group">
                    <span class="input-group-text"><i class="fas fa-search"></i></span>
                    <input type="text" name="searchNome" class="form-control" value="@searchNome" placeholder="Cerca cliente..." />
                </div>
            </div>
            <div class="col-md-auto">
                <div class="btn-group">
                    <a asp-action="Tipo" asp-route-id="@Model.AttivitaTipoId" asp-route-annoId="@Model.AnnualitaFiscaleId" 
                       asp-route-searchNome="@searchNome" asp-route-filtroStatoId="@filtroStatoId" asp-route-ordinamento="asc"
                       class="btn @(ordinamento == "asc" ? "btn-primary" : "btn-outline-primary")">
                        <i class="fas fa-sort-alpha-down me-1"></i>A→Z
                    </a>
                    <a asp-action="Tipo" asp-route-id="@Model.AttivitaTipoId" asp-route-annoId="@Model.AnnualitaFiscaleId" 
                       asp-route-searchNome="@searchNome" asp-route-filtroStatoId="@filtroStatoId" asp-route-ordinamento="desc"
                       class="btn @(ordinamento == "desc" ? "btn-primary" : "btn-outline-primary")">
                        <i class="fas fa-sort-alpha-up me-1"></i>Z→A
                    </a>
                </div>
            </div>
            <div class="col-md-auto">
                <button type="submit" class="btn btn-primary">
                    <i class="fas fa-sync-alt me-1"></i>Filtri - Aggiorna GRID
                </button>
            </div>
            <div class="col-md-auto">
                <a asp-action="Tipo" asp-route-id="@Model.AttivitaTipoId" asp-route-annoId="@Model.AnnualitaFiscaleId" class="btn btn-outline-secondary">
                    <i class="fas fa-times me-1"></i>Reset
                </a>
            </div>
            @if (filtroStatoId.HasValue)
            {
                var statoFiltrato = statiDisponibili.FirstOrDefault(s => s.Id == filtroStatoId.Value);
                if (statoFiltrato != null)
                {
                    <div class="col-md-auto">
                        <span class="badge px-3 py-2" style="background-color: @statoFiltrato.ColoreSfondo; color: @statoFiltrato.ColoreTesto;">
                            Filtro: @statoFiltrato.Nome
                        </span>
                    </div>
                }
            }
        </form>
    </div>
</div>

<!-- Lista Clienti -->
<div class="card" style="overflow: visible;">
    <div class="card-header">
        <h6 class="mb-0"><i class="fas fa-users me-2"></i>Clienti Assegnati (@totale)</h6>
    </div>
    <div class="card-body p-0" style="overflow: visible;">
        @if (!Model.ClientiAttivita.Any())
        {
            <div class="p-4 text-center text-muted">
                <i class="fas fa-users-slash fa-3x mb-3 opacity-50"></i>
                <p>Nessun cliente assegnato a questa attività.<br>
                   Vai alla scheda di un cliente per assegnare l'attività, oppure usa "Assegna a Tutti".</p>
            </div>
        }
        else
        {
            var campiVisibili = Model.AttivitaTipo?.Campi.Where(c => c.ShowInList).OrderBy(c => c.DisplayOrder).ToList() ?? new List<AttivitaCampo>();
            var numColonne = 4 + campiVisibili.Count; // Cliente, Ateco, Stato, Azioni + campi
            
            <div class="table-responsive" style="overflow: visible;">
                <table class="table table-hover mb-0" style="table-layout: fixed;">
                    <thead>
                        <tr>
                            <th style="width: 250px;">Cliente</th>
                            <th style="width: 100px;">Cod. Ateco</th>
                            <th style="width: 140px;">Stato</th>
                            @foreach (var campo in campiVisibili)
                            {
                                var widthStyle = campo.ColumnWidth > 0 
                                    ? $"width: {campo.ColumnWidth}px; min-width: {campo.ColumnWidth}px; max-width: {campo.ColumnWidth}px;" 
                                    : "min-width: 100px;";
                                <th class="text-center" style="@widthStyle white-space: normal; word-wrap: break-word;" data-campo-name="@campo.Name">
                                    @campo.Label
                                    @if (campo.IsCalculated)
                                    {
                                        <i class="fas fa-calculator text-warning ms-1" title="Calcolato"></i>
                                    }
                                </th>
                            }
                            <th style="width: 100px;" class="text-end">Azioni</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var ca in Model.ClientiAttivita)
                        {
                            var statoCorrente = ca.StatoAttivitaTipoNav;
                            <tr class="align-middle">
                                <td>
                                    <a asp-controller="Clienti" asp-action="Details" asp-route-id="@ca.ClienteId">
                                        <strong>@ca.Cliente?.RagioneSociale</strong>
                                    </a>
                                </td>
                                <td><code class="small">@ca.Cliente?.CodiceAteco</code></td>
                                <td>
                                    <!-- Dropdown stato inline -->
                                    <div class="dropdown stato-dropdown-container">
                                        <button class="btn btn-sm dropdown-toggle stato-badge-btn" 
                                                type="button" 
                                                data-bs-toggle="dropdown" 
                                                data-clienteattivita="@ca.Id"
                                                style="background-color: @(statoCorrente?.ColoreSfondo ?? "#6c757d"); color: @(statoCorrente?.ColoreTesto ?? "#fff"); border: none; padding: 4px 10px;">
                                            <i class="@(statoCorrente?.Icon ?? "fas fa-question") me-1 stato-icon"></i>
                                            <span class="stato-nome">@(statoCorrente?.Nome ?? "Nessuno")</span>
                                        </button>
                                        <ul class="dropdown-menu dropdown-menu-end shadow" style="z-index: 1050;">
                                            @foreach (var stato in statiDisponibili)
                                            {
                                                <li>
                                                    <a href="javascript:void(0)" 
                                                       class="dropdown-item cambio-stato-link @(stato.Id == ca.StatoAttivitaTipoId ? "active" : "")"
                                                       data-clienteattivita="@ca.Id"
                                                       data-statoid="@stato.Id"
                                                       data-statonome="@stato.Nome"
                                                       data-statoicon="@stato.Icon"
                                                       data-coloresfondo="@stato.ColoreSfondo"
                                                       data-coloretesto="@stato.ColoreTesto">
                                                        <i class="@stato.Icon me-2" style="color: @stato.ColoreSfondo;"></i>@stato.Nome
                                                    </a>
                                                </li>
                                            }
                                        </ul>
                                    </div>
                                </td>
                                @foreach (var campo in campiVisibili)
                                {
                                    var valore = ca.Valori.FirstOrDefault(v => v.AttivitaCampoId == campo.Id)?.Valore ?? "";
                                    var cellWidth = campo.ColumnWidth > 0 ? $"width: {campo.ColumnWidth}px; max-width: {campo.ColumnWidth}px;" : "";
                                    var inputWidth = campo.ColumnWidth > 0 ? $"width: {campo.ColumnWidth - 10}px;" : "width: 100%; min-width: 80px;";
                                    <td class="text-center p-1" style="@cellWidth">
                                        @if (campo.IsCalculated)
                                        {
                                            // Campo calcolato: mostra valore non editabile
                                            var valoreCalcolato = FormulaCalculatorService.CalcolaPerClienteAttivita(campo, ca, campiVisibili);
                                            <span class="calculated-field badge bg-light text-dark border" 
                                                  style="font-size: 0.85rem; display: inline-block; @inputWidth"
                                                  data-clienteattivita="@ca.Id"
                                                  data-campo="@campo.Id"
                                                  data-formula="@campo.Formula"
                                                  title="Calcolato: @campo.Formula">
                                                @(valoreCalcolato ?? "-")
                                            </span>
                                        }
                                        else if (campo.FieldType == AttivitaFieldType.Boolean)
                                        {
                                            <input type="checkbox" 
                                                   class="form-check-input inline-edit-checkbox" 
                                                   style="width: 20px; height: 20px; cursor: pointer; border: 1px solid #ced4da;"
                                                   data-clienteattivita="@ca.Id" 
                                                   data-campo="@campo.Id"
                                                   @(valore == "true" ? "checked" : "") />
                                        }
                                        else if (campo.FieldType == AttivitaFieldType.Date)
                                        {
                                            var dataFormattata = "";
                                            if (!string.IsNullOrEmpty(valore) && DateTime.TryParse(valore, out var dataVal))
                                            {
                                                dataFormattata = dataVal.ToString("yyyy-MM-dd");
                                            }
                                            <input type="date" 
                                                   class="form-control form-control-sm inline-edit-field" 
                                                   style="@inputWidth font-size: 0.8rem; border: 1px solid #dee2e6; text-align: center;"
                                                   data-clienteattivita="@ca.Id" 
                                                   data-campo="@campo.Id"
                                                   value="@dataFormattata" />
                                        }
                                        else if (campo.FieldType == AttivitaFieldType.Number || campo.FieldType == AttivitaFieldType.Decimal)
                                        {
                                            <input type="text" 
                                                   class="form-control form-control-sm inline-edit-field source-field" 
                                                   style="@inputWidth font-size: 0.8rem; border: 1px solid #dee2e6; text-align: center;"
                                                   data-clienteattivita="@ca.Id" 
                                                   data-campo="@campo.Id"
                                                   data-campo-name="@campo.Name"
                                                   value="@valore"
                                                   placeholder="-"
                                                   inputmode="numeric" />
                                        }
                                        else
                                        {
                                            <input type="text" 
                                                   class="form-control form-control-sm inline-edit-field source-field" 
                                                   style="@inputWidth font-size: 0.8rem; border: 1px solid #dee2e6; text-align: center;"
                                                   data-clienteattivita="@ca.Id" 
                                                   data-campo="@campo.Id"
                                                   data-campo-name="@campo.Name"
                                                   value="@valore"
                                                   placeholder="-" />
                                        }
                                    </td>
                                }
                                <td class="text-end">
                                    <a asp-action="ClienteAttivita" asp-route-id="@ca.Id" class="btn btn-sm btn-outline-primary" title="Modifica dettagli">
                                        <i class="fas fa-edit"></i>
                                    </a>
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
        }
    </div>
</div>

<!-- Modal Nuovo Cliente (Selezione Multipla) -->
<div class="modal fade" id="nuovoClienteModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <form asp-action="AggiungiClientiMultipli" method="post">
                <input type="hidden" name="attivitaAnnualeId" value="@Model.Id" />
                <div class="modal-header">
                    <h5 class="modal-title"><i class="fas fa-plus-circle me-2"></i>Aggiungi Clienti all'Attività</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    @if (!clientiDisponibili.Any())
                    {
                        <div class="alert alert-info">
                            <i class="fas fa-info-circle me-2"></i>Tutti i clienti sono già assegnati a questa attività.
                        </div>
                    }
                    else
                    {
                        <!-- Barra di ricerca e selezione rapida -->
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <div class="input-group">
                                    <span class="input-group-text"><i class="fas fa-search"></i></span>
                                    <input type="text" id="searchClienti" class="form-control" placeholder="Cerca cliente..." />
                                </div>
                            </div>
                            <div class="col-md-6 text-end">
                                <button type="button" class="btn btn-outline-primary btn-sm" id="selezionaTutti">
                                    <i class="fas fa-check-double me-1"></i>Seleziona Tutti
                                </button>
                                <button type="button" class="btn btn-outline-secondary btn-sm" id="deselezionaTutti">
                                    <i class="fas fa-times me-1"></i>Deseleziona Tutti
                                </button>
                            </div>
                        </div>
                        
                        <!-- Contatore selezione -->
                        <div class="mb-2">
                            <span class="badge bg-primary" id="contatoreSelezionati">0 clienti selezionati</span>
                        </div>

                        <!-- Lista clienti con checkbox -->
                        <div class="border rounded" style="max-height: 400px; overflow-y: auto;">
                            <table class="table table-hover table-sm mb-0">
                                <thead class="table-light sticky-top">
                                    <tr>
                                        <th style="width: 40px;"></th>
                                        <th>Ragione Sociale</th>
                                        <th style="width: 120px;">Cod. Ateco</th>
                                    </tr>
                                </thead>
                                <tbody id="listaClientiBody">
                                    @foreach (var cliente in clientiDisponibili)
                                    {
                                        <tr class="cliente-row">
                                            <td class="text-center">
                                                <input type="checkbox" class="form-check-input cliente-checkbox" 
                                                       name="clienteIds" value="@cliente.Id" 
                                                       style="width: 18px; height: 18px; cursor: pointer;"
                                                       data-nome="@cliente.RagioneSociale.ToLower()" />
                                            </td>
                                            <td>
                                                <label class="mb-0 w-100" style="cursor: pointer;">
                                                    @cliente.RagioneSociale
                                                </label>
                                            </td>
                                            <td><code class="small">@cliente.CodiceAteco</code></td>
                                        </tr>
                                    }
                                </tbody>
                            </table>
                        </div>
                        
                        <small class="text-muted mt-2 d-block">
                            <i class="fas fa-info-circle me-1"></i>Totale clienti disponibili: @clientiDisponibili.Count
                        </small>
                    }
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annulla</button>
                    @if (clientiDisponibili.Any())
                    {
                        <button type="submit" class="btn btn-primary" id="btnAggiungiClienti">
                            <i class="fas fa-plus me-1"></i>Aggiungi Selezionati
                        </button>
                    }
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Modal Copia Anno -->
@if (annoPrecedente != null && clientiAnnoPrecedente > 0)
{
    var campiAttivita = Model.AttivitaTipo?.Campi?.OrderBy(c => c.DisplayOrder).ToList() ?? new List<AttivitaCampo>();
    <div class="modal fade" id="copiaAnnoModal" tabindex="-1">
        <div class="modal-dialog">
            <form asp-action="CopiaClientiDaAnno" method="post">
                <div class="modal-content">
                    <div class="modal-header bg-info text-white">
                        <h5 class="modal-title"><i class="fas fa-copy me-2"></i>Copia da Anno Precedente</h5>
                        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <input type="hidden" name="attivitaAnnualeId" value="@Model.Id" />
                        <input type="hidden" name="annoPrecedenteId" value="@annoPrecedente.Id" />
                        
                        <div class="alert alert-info">
                            <i class="fas fa-info-circle me-1"></i>
                            Verranno copiati <strong>@clientiAnnoPrecedente clienti</strong> dal <strong>@annoPrecedente.Anno</strong> al <strong>@Model.AnnualitaFiscale?.Anno</strong>.
                        </div>
                        
                        <div class="p-3 bg-light rounded">
                            <div class="form-check mb-2">
                                <input type="checkbox" name="copiaDati" value="true" class="form-check-input" id="copiaDatiCheckAttivita" 
                                       style="border: 3px solid #333;" onchange="toggleCampiCopiaAttivita(this.checked)">
                                <label class="form-check-label fw-bold" for="copiaDatiCheckAttivita">
                                    <i class="fas fa-database me-1"></i>Copia anche i dati inseriti
                                </label>
                            </div>
                            
                            @if (campiAttivita.Any())
                            {
                                <div id="selezioneCampiCopiaAttivita" style="display: none;">
                                    <div class="border rounded p-2 mt-2 bg-white" style="max-height: 200px; overflow-y: auto;">
                                        <div class="d-flex justify-content-between align-items-center mb-2">
                                            <small class="fw-bold">Seleziona campi da copiare:</small>
                                            <div>
                                                <button type="button" class="btn btn-outline-primary btn-sm py-0 px-1" onclick="selezionaTuttiCampiCopiaAttivita(true)">Tutti</button>
                                                <button type="button" class="btn btn-outline-secondary btn-sm py-0 px-1" onclick="selezionaTuttiCampiCopiaAttivita(false)">Nessuno</button>
                                            </div>
                                        </div>
                                        @foreach (var campo in campiAttivita)
                                        {
                                            <div class="form-check">
                                                <input type="checkbox" name="campiDaCopiare" value="@campo.Id" 
                                                       class="form-check-input campo-copia-check-attivita" id="copiaCampoAtt_@campo.Id" checked
                                                       style="border: 2px solid #666;">
                                                <label class="form-check-label small" for="copiaCampoAtt_@campo.Id">
                                                    @campo.Label
                                                </label>
                                            </div>
                                        }
                                    </div>
                                    <small class="text-muted d-block mt-1">
                                        Solo i campi selezionati verranno copiati nell'anno destinazione.
                                    </small>
                                </div>
                            }
                            
                            <small class="text-muted d-block mt-2">
                                <i class="fas fa-info-circle me-1"></i>
                                I clienti già presenti nell'anno destinazione saranno ignorati.
                            </small>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annulla</button>
                        <button type="submit" class="btn btn-info"><i class="fas fa-copy me-1"></i>Copia</button>
                    </div>
                </div>
            </form>
        </div>
    </div>
}

@section Scripts {
    <script>
        // ========== SELEZIONE MULTIPLA CLIENTI ==========
        
        // Aggiorna contatore selezionati
        function aggiornaContatore() {
            var selezionati = document.querySelectorAll('.cliente-checkbox:checked').length;
            var contatore = document.getElementById('contatoreSelezionati');
            if (contatore) {
                contatore.textContent = selezionati + ' client' + (selezionati === 1 ? 'e selezionato' : 'i selezionati');
            }
            
            // Abilita/disabilita pulsante
            var btnAggiungi = document.getElementById('btnAggiungiClienti');
            if (btnAggiungi) {
                btnAggiungi.disabled = selezionati === 0;
            }
        }

        // Checkbox change event
        document.querySelectorAll('.cliente-checkbox').forEach(function(checkbox) {
            checkbox.addEventListener('change', aggiornaContatore);
        });

        // Seleziona tutti (solo visibili)
        var btnSelezionaTutti = document.getElementById('selezionaTutti');
        if (btnSelezionaTutti) {
            btnSelezionaTutti.addEventListener('click', function() {
                document.querySelectorAll('.cliente-row:not([style*="display: none"]) .cliente-checkbox').forEach(function(cb) {
                    cb.checked = true;
                });
                aggiornaContatore();
            });
        }

        // Deseleziona tutti
        var btnDeselezionaTutti = document.getElementById('deselezionaTutti');
        if (btnDeselezionaTutti) {
            btnDeselezionaTutti.addEventListener('click', function() {
                document.querySelectorAll('.cliente-checkbox').forEach(function(cb) {
                    cb.checked = false;
                });
                aggiornaContatore();
            });
        }

        // Ricerca clienti
        var searchInput = document.getElementById('searchClienti');
        if (searchInput) {
            searchInput.addEventListener('input', function() {
                var filtro = this.value.toLowerCase();
                document.querySelectorAll('.cliente-row').forEach(function(row) {
                    var nome = row.querySelector('.cliente-checkbox').getAttribute('data-nome');
                    if (nome.includes(filtro)) {
                        row.style.display = '';
                    } else {
                        row.style.display = 'none';
                    }
                });
            });
        }

        // Click sulla riga per selezionare
        document.querySelectorAll('.cliente-row td:not(:first-child)').forEach(function(td) {
            td.addEventListener('click', function() {
                var checkbox = this.parentElement.querySelector('.cliente-checkbox');
                checkbox.checked = !checkbox.checked;
                aggiornaContatore();
            });
        });

        // Inizializza contatore
        aggiornaContatore();

        // ========== INLINE EDITING ==========
        
        // Funzione per salvare valore inline
        function salvaValoreInline(clienteAttivitaId, campoId, valore, elemento) {
            // Mostra indicatore di salvataggio
            elemento.style.opacity = '0.5';
            
            fetch('/Attivita/SalvaValoreInline', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                    'RequestVerificationToken': document.querySelector('input[name="__RequestVerificationToken"]')?.value || ''
                },
                body: `clienteAttivitaId=${clienteAttivitaId}&campoId=${campoId}&valore=${encodeURIComponent(valore)}`
            })
            .then(response => response.json())
            .then(data => {
                elemento.style.opacity = '1';
                if (data.success) {
                    // Flash verde per conferma
                    elemento.style.backgroundColor = '#d4edda';
                    setTimeout(() => { elemento.style.backgroundColor = ''; }, 500);
                } else {
                    // Flash rosso per errore
                    elemento.style.backgroundColor = '#f8d7da';
                    setTimeout(() => { elemento.style.backgroundColor = ''; }, 1000);
                    console.error('Errore salvataggio:', data.error);
                }
            })
            .catch(error => {
                elemento.style.opacity = '1';
                elemento.style.backgroundColor = '#f8d7da';
                setTimeout(() => { elemento.style.backgroundColor = ''; }, 1000);
                console.error('Errore:', error);
            });
        }

        // Checkbox - salva al click
        document.querySelectorAll('.inline-edit-checkbox').forEach(function(checkbox) {
            checkbox.addEventListener('change', function() {
                var caId = this.getAttribute('data-clienteattivita');
                var campoId = this.getAttribute('data-campo');
                var valore = this.checked ? 'true' : 'false';
                salvaValoreInline(caId, campoId, valore, this);
            });
        });

        // Input text, date, select - salva al blur (uscita dal campo)
        document.querySelectorAll('.inline-edit-field').forEach(function(campo) {
            campo.addEventListener('change', function() {
                var caId = this.getAttribute('data-clienteattivita');
                var campoId = this.getAttribute('data-campo');
                var valore = this.value;
                salvaValoreInline(caId, campoId, valore, this);
                
                // Ricalcola campi calcolati per questa riga
                ricalcolaCampiCalcolati(caId);
            });
        });

        // ========== RICALCOLO CAMPI CALCOLATI ==========
        
        // Mappa dei campi per il calcolo
        var campiMappa = {
            @if (Model.AttivitaTipo?.Campi != null)
            {
                @foreach (var campo in Model.AttivitaTipo.Campi.Where(c => !c.IsCalculated))
                {
                    @Html.Raw($"'{campo.Name}': {campo.Id},")
                }
            }
        };

        // Formule dei campi calcolati
        var campiCalcolati = [
            @if (Model.AttivitaTipo?.Campi != null)
            {
                @foreach (var campo in Model.AttivitaTipo.Campi.Where(c => c.IsCalculated && !string.IsNullOrEmpty(c.Formula)))
                {
                    @Html.Raw($"{{ id: {campo.Id}, name: '{campo.Name}', formula: '{campo.Formula!.Replace("'", "\\'")}' }},")
                }
            }
        ];

        // Funzione per calcolare formula lato client
        function calcolaFormula(formula, valori) {
            try {
                // Sostituisci riferimenti ai campi con i loro valori
                var formulaCalcolata = formula.replace(/\[([^\]]+)\]/g, function(match, nomeCampo) {
                    var valore = valori[nomeCampo.toUpperCase()] || valori[nomeCampo] || 0;
                    // Converti virgola in punto per parsing
                    if (typeof valore === 'string') {
                        valore = valore.replace(',', '.');
                    }
                    var numero = parseFloat(valore);
                    return isNaN(numero) ? 0 : numero;
                });

                // Converti virgole in punti (supporto formato italiano es: 0,88 -> 0.88)
                formulaCalcolata = formulaCalcolata.replace(/,/g, '.');

                // Valida formula (solo numeri, operatori, parentesi)
                if (!/^[\d\.\+\-\*\/\(\)\s]+$/.test(formulaCalcolata)) {
                    return null;
                }

                // Calcola
                var risultato = eval(formulaCalcolata);
                
                // Formatta con 2 decimali e formato italiano
                return risultato.toLocaleString('it-IT', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
            } catch (e) {
                console.error('Errore calcolo formula:', e);
                return null;
            }
        }

        // Ricalcola tutti i campi calcolati per una riga
        function ricalcolaCampiCalcolati(clienteAttivitaId) {
            if (campiCalcolati.length === 0) return;
            
            // Raccogli valori di tutti i campi sorgente della riga
            var valori = {};
            document.querySelectorAll('.inline-edit-field[data-clienteattivita="' + clienteAttivitaId + '"]').forEach(function(input) {
                var nomeCampo = input.getAttribute('data-campo-name');
                if (nomeCampo) {
                    valori[nomeCampo] = input.value;
                    valori[nomeCampo.toUpperCase()] = input.value;
                }
            });
            
            // Ricalcola ogni campo calcolato
            campiCalcolati.forEach(function(campoCalc) {
                var span = document.querySelector('.calculated-field[data-clienteattivita="' + clienteAttivitaId + '"][data-campo="' + campoCalc.id + '"]');
                if (span) {
                    var risultato = calcolaFormula(campoCalc.formula, valori);
                    span.textContent = risultato || '-';
                    
                    // Feedback visivo
                    span.style.backgroundColor = '#fff3cd';
                    setTimeout(function() { span.style.backgroundColor = ''; }, 500);
                }
            });
        }

        // ========== CAMBIO STATO INLINE ==========
        
        document.querySelectorAll('.cambio-stato-link').forEach(function(link) {
            link.addEventListener('click', function(e) {
                e.preventDefault();
                
                var clienteAttivitaId = this.getAttribute('data-clienteattivita');
                var nuovoStatoId = this.getAttribute('data-statoid');
                var statoNome = this.getAttribute('data-statonome');
                var statoIcon = this.getAttribute('data-statoicon');
                var coloreSfondo = this.getAttribute('data-coloresfondo');
                var coloreTesto = this.getAttribute('data-coloretesto');
                
                // Trova il pulsante badge dello stato
                var container = document.querySelector('.stato-badge-btn[data-clienteattivita="' + clienteAttivitaId + '"]');
                if (!container) return;
                
                // Mostra indicatore di caricamento
                container.style.opacity = '0.5';
                
                fetch('/Attivita/CambiaStatoInline', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded'
                    },
                    body: 'clienteAttivitaId=' + clienteAttivitaId + '&nuovoStatoId=' + nuovoStatoId
                })
                .then(response => response.json())
                .then(data => {
                    container.style.opacity = '1';
                    if (data.success) {
                        // Aggiorna il badge visivamente
                        container.style.backgroundColor = data.coloreSfondo;
                        container.style.color = data.coloreTesto;
                        container.querySelector('.stato-icon').className = data.statoIcon + ' me-1 stato-icon';
                        container.querySelector('.stato-nome').textContent = data.statoNome;
                        
                        // Flash verde per conferma
                        container.style.boxShadow = '0 0 10px #28a745';
                        setTimeout(() => { container.style.boxShadow = ''; }, 500);
                        
                        // Aggiorna classe active nel dropdown
                        var dropdown = container.parentElement.querySelector('.dropdown-menu');
                        dropdown.querySelectorAll('.cambio-stato-link').forEach(function(item) {
                            item.classList.remove('active');
                            if (item.getAttribute('data-statoid') === nuovoStatoId) {
                                item.classList.add('active');
                            }
                        });
                    } else {
                        // Flash rosso per errore
                        container.style.boxShadow = '0 0 10px #dc3545';
                        setTimeout(() => { container.style.boxShadow = ''; }, 1000);
                        console.error('Errore cambio stato:', data.error);
                        alert('Errore nel cambio stato: ' + data.error);
                    }
                })
                .catch(error => {
                    container.style.opacity = '1';
                    container.style.boxShadow = '0 0 10px #dc3545';
                    setTimeout(() => { container.style.boxShadow = ''; }, 1000);
                    console.error('Errore:', error);
                    alert('Errore di connessione');
                });
            });
        });
        
        // ========== COPIA ANNO FUNZIONI ==========
        
        // Toggle visualizzazione campi da copiare
        function toggleCampiCopiaAttivita(mostra) {
            var div = document.getElementById('selezioneCampiCopiaAttivita');
            if (div) {
                div.style.display = mostra ? 'block' : 'none';
            }
        }

        // Seleziona/deseleziona tutti i campi da copiare
        function selezionaTuttiCampiCopiaAttivita(seleziona) {
            var checkboxes = document.querySelectorAll('.campo-copia-check-attivita');
            checkboxes.forEach(function(cb) {
                cb.checked = seleziona;
            });
        }
    </script>
}
