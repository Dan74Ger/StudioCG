@model List<StudioCG.Web.Models.Fatturazione.AccessoCliente>
@using StudioCG.Web.Models.Fatturazione
@{
    ViewData["Title"] = "Accessi Clienti";
    var annoSelezionato = (int)ViewBag.AnnoSelezionato;
    var anniDisponibili = (List<int>)ViewBag.AnniDisponibili;
    var clienti = (List<StudioCG.Web.Models.Cliente>)ViewBag.Clienti;
    var clienteIdSelezionato = (int?)ViewBag.ClienteIdSelezionato;
    var meseSelezionato = (int?)ViewBag.MeseSelezionato;
    
    var mesi = new Dictionary<int, string>
    {
        {1, "Gennaio"}, {2, "Febbraio"}, {3, "Marzo"}, {4, "Aprile"},
        {5, "Maggio"}, {6, "Giugno"}, {7, "Luglio"}, {8, "Agosto"},
        {9, "Settembre"}, {10, "Ottobre"}, {11, "Novembre"}, {12, "Dicembre"}
    };
}

<div class="container-fluid">
    <!-- Header -->
    <div class="row mb-4">
        <div class="col-12 d-flex justify-content-between align-items-center flex-wrap gap-2">
            <div>
                <h4 class="mb-0"><i class="fas fa-door-open me-2 text-success"></i>Accessi Clienti</h4>
                <small class="text-muted">Registrazione accessi clienti in studio - Anno @annoSelezionato</small>
            </div>
            <div class="d-flex gap-2">
                <div class="btn-group">
                    <button type="button" class="btn btn-outline-primary dropdown-toggle" data-bs-toggle="dropdown">
                        <i class="fas fa-calendar-alt me-2"></i>Anno @annoSelezionato
                    </button>
                    <ul class="dropdown-menu dropdown-menu-end">
                        @foreach (var anno in anniDisponibili)
                        {
                            <li>
                                <a class="dropdown-item @(anno == annoSelezionato ? "active" : "")" 
                                   asp-action="AccessiClienti" asp-route-anno="@anno">@anno</a>
                            </li>
                        }
                    </ul>
                </div>
                <div class="btn-group">
                    <button type="button" class="btn btn-outline-secondary dropdown-toggle" data-bs-toggle="dropdown">
                        <i class="fas fa-calendar-week me-2"></i>@(meseSelezionato.HasValue && meseSelezionato.Value > 0 ? mesi[meseSelezionato.Value] : "Tutti i mesi")
                    </button>
                    <ul class="dropdown-menu dropdown-menu-end">
                        <li>
                            <a class="dropdown-item @(!meseSelezionato.HasValue || meseSelezionato.Value == 0 ? "active" : "")" 
                               asp-action="AccessiClienti" asp-route-anno="@annoSelezionato" asp-route-clienteId="@clienteIdSelezionato" asp-route-mese="">
                                Tutti i mesi
                            </a>
                        </li>
                        <li><hr class="dropdown-divider"></li>
                        @foreach (var mese in mesi)
                        {
                            <li>
                                <a class="dropdown-item @(meseSelezionato == mese.Key ? "active" : "")" 
                                   asp-action="AccessiClienti" asp-route-anno="@annoSelezionato" asp-route-clienteId="@clienteIdSelezionato" asp-route-mese="@mese.Key">
                                    @mese.Value
                                </a>
                            </li>
                        }
                    </ul>
                </div>
                <button type="button" class="btn btn-success" data-bs-toggle="modal" data-bs-target="#modalNuovo">
                    <i class="fas fa-plus me-2"></i>Nuovo Accesso
                </button>
            </div>
        </div>
    </div>

    <!-- Statistiche -->
    <div class="row g-3 mb-4">
        <div class="col-md-3">
            <div class="card bg-success text-white">
                <div class="card-body py-3">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <div class="small opacity-75">Totale Accessi</div>
                            <div class="fs-4 fw-bold">@Model.Count</div>
                        </div>
                        <i class="fas fa-sign-in-alt fa-2x opacity-50"></i>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-info text-white">
                <div class="card-body py-3">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <div class="small opacity-75">Ore Totali</div>
                            <div class="fs-4 fw-bold">@Model.Sum(a => a.TotaleOre).ToString("0.00")</div>
                        </div>
                        <i class="fas fa-clock fa-2x opacity-50"></i>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-primary text-white">
                <div class="card-body py-3">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <div class="small opacity-75">Importo Totale</div>
                            <div class="fs-4 fw-bold">@Model.Sum(a => a.TotaleImporto).ToString("C", new System.Globalization.CultureInfo("it-IT"))</div>
                        </div>
                        <i class="fas fa-euro-sign fa-2x opacity-50"></i>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-secondary text-white">
                <div class="card-body py-3">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <div class="small opacity-75">Clienti</div>
                            <div class="fs-4 fw-bold">@Model.Select(a => a.ClienteId).Distinct().Count()</div>
                        </div>
                        <i class="fas fa-users fa-2x opacity-50"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Filtri -->
    <div class="card mb-4">
        <div class="card-body py-2">
            <form asp-action="AccessiClienti" method="get" class="row g-2 align-items-end">
                <input type="hidden" name="anno" value="@annoSelezionato" />
                <div class="col-md-5">
                    <label class="form-label small text-muted">Cliente</label>
                    <select name="clienteId" class="form-select form-select-sm">
                        <option value="">-- Tutti i clienti --</option>
                        @foreach (var cliente in clienti)
                        {
                            <option value="@cliente.Id" selected="@(clienteIdSelezionato == cliente.Id)">@cliente.RagioneSociale</option>
                        }
                    </select>
                </div>
                <div class="col-md-4">
                    <button type="submit" class="btn btn-primary btn-sm">
                        <i class="fas fa-filter me-1"></i>Filtra
                    </button>
                    <a asp-action="AccessiClienti" asp-route-anno="@annoSelezionato" class="btn btn-outline-secondary btn-sm">
                        <i class="fas fa-times me-1"></i>Reset
                    </a>
                </div>
            </form>
        </div>
    </div>

    <!-- Tabella -->
    <div class="card">
        <div class="card-header d-flex justify-content-between align-items-center">
            <h5 class="mb-0"><i class="fas fa-list me-2"></i>Elenco Accessi (@Model.Count)</h5>
        </div>
        <div class="card-body p-0">
            @if (Model.Any())
            {
                <div class="table-responsive">
                    <table class="table table-hover mb-0">
                        <thead class="bg-light">
                            <tr>
                                <th>Data</th>
                                <th>Cliente</th>
                                <th>Mattina</th>
                                <th>Pomeriggio</th>
                                <th class="text-center">Ore</th>
                                <th class="text-end">€/h</th>
                                <th class="text-end">Totale</th>
                                <th>Scadenza</th>
                                <th>Registrato da</th>
                                <th class="text-center">Azioni</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var acc in Model)
                            {
                                // Gli accessi clienti sono SEMPRE modificabili/cancellabili
                                <tr>
                                    <td>@acc.Data.ToString("dd/MM/yyyy")</td>
                                    <td><strong>@acc.Cliente?.RagioneSociale</strong></td>
                                    <td>
                                        @if (acc.OraInizioMattino.HasValue && acc.OraFineMattino.HasValue)
                                        {
                                            <span class="badge bg-light text-dark">
                                                @acc.OraInizioMattino.Value.ToString(@"hh\:mm") - @acc.OraFineMattino.Value.ToString(@"hh\:mm")
                                            </span>
                                        }
                                        else
                                        {
                                            <span class="text-muted">-</span>
                                        }
                                    </td>
                                    <td>
                                        @if (acc.OraInizioPomeriggio.HasValue && acc.OraFinePomeriggio.HasValue)
                                        {
                                            <span class="badge bg-light text-dark">
                                                @acc.OraInizioPomeriggio.Value.ToString(@"hh\:mm") - @acc.OraFinePomeriggio.Value.ToString(@"hh\:mm")
                                            </span>
                                        }
                                        else
                                        {
                                            <span class="text-muted">-</span>
                                        }
                                    </td>
                                    <td class="text-center">
                                        <span class="badge bg-info">@acc.TotaleOre.ToString("0.00") h</span>
                                    </td>
                                    <td class="text-end">@acc.TariffaOraria.ToString("C", new System.Globalization.CultureInfo("it-IT"))</td>
                                    <td class="text-end fw-bold">@acc.TotaleImporto.ToString("C", new System.Globalization.CultureInfo("it-IT"))</td>
                                    <td>
                                        @if (acc.ScadenzaFatturazione != null)
                                        {
                                            <span class="badge @(acc.ScadenzaFatturazione.Stato == StatoScadenza.Aperta ? "bg-secondary" : acc.ScadenzaFatturazione.Stato == StatoScadenza.Proforma ? "bg-warning text-dark" : "bg-success")">
                                                @acc.ScadenzaFatturazione.DataScadenza.ToString("dd/MM")
                                            </span>
                                        }
                                    </td>
                                    <td>
                                        @if (acc.Utente != null)
                                        {
                                            <small class="text-muted">@acc.Utente.Nome @acc.Utente.Cognome</small>
                                        }
                                    </td>
                                    <td class="text-center">
                                        <div class="btn-group btn-group-sm">
                                            <button type="button" class="btn btn-outline-primary" title="Modifica"
                                                    data-bs-toggle="modal" data-bs-target="#modalEdit"
                                                    data-id="@acc.Id"
                                                    data-clienteid="@acc.ClienteId"
                                                    data-cliente="@acc.Cliente?.RagioneSociale"
                                                    data-data="@acc.Data.ToString("yyyy-MM-dd")"
                                                    data-orainiziomattina="@acc.OraInizioMattino?.ToString(@"hh\:mm")"
                                                    data-orafinemattina="@acc.OraFineMattino?.ToString(@"hh\:mm")"
                                                    data-orainiziopomeriggio="@acc.OraInizioPomeriggio?.ToString(@"hh\:mm")"
                                                    data-orafinepomeriggio="@acc.OraFinePomeriggio?.ToString(@"hh\:mm")"
                                                    data-tariffaoraria="@acc.TariffaOraria.ToString("0.00", System.Globalization.CultureInfo.InvariantCulture)"
                                                    data-scadenzaid="@acc.ScadenzaFatturazioneId"
                                                    data-note="@acc.Note">
                                                <i class="fas fa-edit"></i>
                                            </button>
                                            <form asp-action="DeleteAccessoCliente" method="post" class="d-inline"
                                                  onsubmit="return confirm('Eliminare questo accesso?');">
                                                @Html.AntiForgeryToken()
                                                <input type="hidden" name="id" value="@acc.Id" />
                                                <input type="hidden" name="anno" value="@annoSelezionato" />
                                                <button type="submit" class="btn btn-outline-danger" title="Elimina">
                                                    <i class="fas fa-trash"></i>
                                                </button>
                                            </form>
                                        </div>
                                    </td>
                                </tr>
                            }
                        </tbody>
                        <tfoot class="bg-light">
                            <tr class="fw-bold">
                                <td colspan="4">TOTALI</td>
                                <td class="text-center">@Model.Sum(a => a.TotaleOre).ToString("0.00") h</td>
                                <td></td>
                                <td class="text-end">@Model.Sum(a => a.TotaleImporto).ToString("C", new System.Globalization.CultureInfo("it-IT"))</td>
                                <td colspan="3"></td>
                            </tr>
                        </tfoot>
                    </table>
                </div>
            }
            else
            {
                <div class="text-center py-5">
                    <i class="fas fa-door-open fa-4x text-muted mb-3"></i>
                    <h5 class="text-muted">Nessun accesso registrato</h5>
                    <p class="text-muted">Clicca "Nuovo Accesso" per iniziare</p>
                </div>
            }
        </div>
    </div>
</div>

<!-- Modal Nuovo -->
<div class="modal fade" id="modalNuovo" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <form asp-action="CreateAccessoCliente" method="post">
                <input type="hidden" name="anno" value="@annoSelezionato" />
                <div class="modal-header bg-success text-white">
                    <h5 class="modal-title"><i class="fas fa-plus me-2"></i>Nuovo Accesso Cliente</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Cliente <span class="text-danger">*</span></label>
                            <select name="clienteId" id="selectClienteNuovo" class="form-select" required>
                                <option value="">-- Seleziona Cliente --</option>
                                @foreach (var cliente in clienti)
                                {
                                    <option value="@cliente.Id">@cliente.RagioneSociale</option>
                                }
                            </select>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Data <span class="text-danger">*</span></label>
                            <input type="date" name="data" class="form-control" required value="@DateTime.Today.ToString("yyyy-MM-dd")">
                        </div>
                    </div>
                    
                    <div class="card mb-3">
                        <div class="card-header py-2 bg-light">
                            <strong>Fascia Mattina</strong>
                        </div>
                        <div class="card-body py-2">
                            <div class="row">
                                <div class="col-md-6">
                                    <label class="form-label small">Inizio</label>
                                    <input type="time" name="oraInizioMattina" class="form-control form-control-sm oraInput" placeholder="09:00">
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label small">Fine</label>
                                    <input type="time" name="oraFineMattina" class="form-control form-control-sm oraInput" placeholder="13:00">
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="card mb-3">
                        <div class="card-header py-2 bg-light">
                            <strong>Fascia Pomeriggio</strong>
                        </div>
                        <div class="card-body py-2">
                            <div class="row">
                                <div class="col-md-6">
                                    <label class="form-label small">Inizio</label>
                                    <input type="time" name="oraInizioPomeriggio" class="form-control form-control-sm oraInput" placeholder="14:00">
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label small">Fine</label>
                                    <input type="time" name="oraFinePomeriggio" class="form-control form-control-sm oraInput" placeholder="18:00">
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-4 mb-3">
                            <label class="form-label">Tariffa Oraria <span class="text-danger">*</span></label>
                            <div class="input-group">
                                <span class="input-group-text">€</span>
                                <input type="text" name="tariffaOraria" class="form-control" required value="50,00" id="tariffaNuovo">
                                <span class="input-group-text">/h</span>
                            </div>
                        </div>
                        <div class="col-md-4 mb-3">
                            <label class="form-label">Ore Calcolate</label>
                            <input type="text" id="oreCalcolateNuovo" class="form-control" readonly value="0.00">
                        </div>
                        <div class="col-md-4 mb-3">
                            <label class="form-label">Importo Calcolato</label>
                            <input type="text" id="importoCalcolatoNuovo" class="form-control fw-bold" readonly value="€ 0,00">
                        </div>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Scadenza Destinazione <span class="text-danger">*</span></label>
                        <select name="scadenzaFatturazioneId" id="selectScadenzaNuovo" class="form-select" required>
                            <option value="">-- Prima seleziona un cliente --</option>
                        </select>
                        <small class="form-text text-muted">Seleziona una scadenza esistente o creane una nuova</small>
                    </div>
                    <div class="mb-3" id="nuovaScadenzaContainer" style="display: none;">
                        <label class="form-label">Data Nuova Scadenza <span class="text-danger">*</span></label>
                        <input type="date" name="dataNuovaScadenza" id="dataNuovaScadenza" class="form-control">
                        <small class="form-text text-muted">Verrà creata una scadenza per questa data</small>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Note</label>
                        <textarea name="note" class="form-control" rows="2" maxlength="500"></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annulla</button>
                    <button type="submit" class="btn btn-success">
                        <i class="fas fa-save me-2"></i>Salva Accesso
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Modal Modifica -->
<div class="modal fade" id="modalEdit" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <form asp-action="UpdateAccessoCliente" method="post">
                <input type="hidden" name="id" id="editId" />
                <input type="hidden" name="anno" value="@annoSelezionato" />
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title"><i class="fas fa-edit me-2"></i>Modifica Accesso</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Cliente</label>
                            <input type="text" id="editCliente" class="form-control" readonly>
                            <input type="hidden" name="clienteId" id="editClienteId">
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Data <span class="text-danger">*</span></label>
                            <input type="date" name="data" id="editData" class="form-control" required>
                        </div>
                    </div>
                    
                    <div class="card mb-3">
                        <div class="card-header py-2 bg-light">
                            <strong>Fascia Mattina</strong>
                        </div>
                        <div class="card-body py-2">
                            <div class="row">
                                <div class="col-md-6">
                                    <label class="form-label small">Inizio</label>
                                    <input type="time" name="oraInizioMattina" id="editOraInizioMattino" class="form-control form-control-sm oraInputEdit">
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label small">Fine</label>
                                    <input type="time" name="oraFineMattina" id="editOraFineMattino" class="form-control form-control-sm oraInputEdit">
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="card mb-3">
                        <div class="card-header py-2 bg-light">
                            <strong>Fascia Pomeriggio</strong>
                        </div>
                        <div class="card-body py-2">
                            <div class="row">
                                <div class="col-md-6">
                                    <label class="form-label small">Inizio</label>
                                    <input type="time" name="oraInizioPomeriggio" id="editOraInizioPomeriggio" class="form-control form-control-sm oraInputEdit">
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label small">Fine</label>
                                    <input type="time" name="oraFinePomeriggio" id="editOraFinePomeriggio" class="form-control form-control-sm oraInputEdit">
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-4 mb-3">
                            <label class="form-label">Tariffa Oraria <span class="text-danger">*</span></label>
                            <div class="input-group">
                                <span class="input-group-text">€</span>
                                <input type="text" name="tariffaOraria" id="editTariffa" class="form-control" required>
                                <span class="input-group-text">/h</span>
                            </div>
                        </div>
                        <div class="col-md-4 mb-3">
                            <label class="form-label">Ore Calcolate</label>
                            <input type="text" id="oreCalcolateEdit" class="form-control" readonly value="0.00">
                        </div>
                        <div class="col-md-4 mb-3">
                            <label class="form-label">Importo Calcolato</label>
                            <input type="text" id="importoCalcolatoEdit" class="form-control fw-bold" readonly value="€ 0,00">
                        </div>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Scadenza Destinazione <span class="text-danger">*</span></label>
                        <select name="scadenzaFatturazioneId" id="editScadenzaId" class="form-select" required>
                        </select>
                        <small class="form-text text-muted">Seleziona una scadenza esistente o creane una nuova</small>
                    </div>
                    <div class="mb-3" id="editNuovaScadenzaContainer" style="display: none;">
                        <label class="form-label">Data Nuova Scadenza <span class="text-danger">*</span></label>
                        <input type="date" name="dataNuovaScadenza" id="editDataNuovaScadenza" class="form-control">
                        <small class="form-text text-muted">Verrà creata una scadenza per questa data</small>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Note</label>
                        <textarea name="note" id="editNote" class="form-control" rows="2" maxlength="500"></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annulla</button>
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-save me-2"></i>Salva Modifiche
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

@section Scripts {
<script>
    var annoCorrente = @annoSelezionato;

    // Calcolo ore per form nuovo
    function calcolaOreNuovo() {
        var ore = 0;
        var im = document.querySelector('[name="oraInizioMattina"]').value;
        var fm = document.querySelector('[name="oraFineMattina"]').value;
        var ip = document.querySelector('[name="oraInizioPomeriggio"]').value;
        var fp = document.querySelector('[name="oraFinePomeriggio"]').value;

        if (im && fm) {
            var [hi, mi] = im.split(':').map(Number);
            var [hf, mf] = fm.split(':').map(Number);
            ore += (hf * 60 + mf - hi * 60 - mi) / 60;
        }
        if (ip && fp) {
            var [hi, mi] = ip.split(':').map(Number);
            var [hf, mf] = fp.split(':').map(Number);
            ore += (hf * 60 + mf - hi * 60 - mi) / 60;
        }

        var tariffa = parseFloat(document.getElementById('tariffaNuovo').value.replace(',', '.')) || 0;
        var importo = ore * tariffa;

        document.getElementById('oreCalcolateNuovo').value = ore.toFixed(2);
        document.getElementById('importoCalcolatoNuovo').value = '€ ' + importo.toFixed(2).replace('.', ',');
    }

    document.querySelectorAll('.oraInput, #tariffaNuovo').forEach(function(el) {
        el.addEventListener('change', calcolaOreNuovo);
        el.addEventListener('input', calcolaOreNuovo);
    });

    // Calcolo ore per form edit
    function calcolaOreEdit() {
        var ore = 0;
        var im = document.getElementById('editOraInizioMattino').value;
        var fm = document.getElementById('editOraFineMattino').value;
        var ip = document.getElementById('editOraInizioPomeriggio').value;
        var fp = document.getElementById('editOraFinePomeriggio').value;

        if (im && fm) {
            var [hi, mi] = im.split(':').map(Number);
            var [hf, mf] = fm.split(':').map(Number);
            ore += (hf * 60 + mf - hi * 60 - mi) / 60;
        }
        if (ip && fp) {
            var [hi, mi] = ip.split(':').map(Number);
            var [hf, mf] = fp.split(':').map(Number);
            ore += (hf * 60 + mf - hi * 60 - mi) / 60;
        }

        var tariffa = parseFloat(document.getElementById('editTariffa').value.replace(',', '.')) || 0;
        var importo = ore * tariffa;

        document.getElementById('oreCalcolateEdit').value = ore.toFixed(2);
        document.getElementById('importoCalcolatoEdit').value = '€ ' + importo.toFixed(2).replace('.', ',');
    }

    document.querySelectorAll('.oraInputEdit, #editTariffa').forEach(function(el) {
        el.addEventListener('change', calcolaOreEdit);
        el.addEventListener('input', calcolaOreEdit);
    });

    // Carica scadenze per cliente (nuovo)
    document.getElementById('selectClienteNuovo').addEventListener('change', function() {
        var clienteId = this.value;
        var selectScadenza = document.getElementById('selectScadenzaNuovo');
        
        if (!clienteId) {
            selectScadenza.innerHTML = '<option value="">-- Prima seleziona un cliente --</option>';
            document.getElementById('nuovaScadenzaContainer').style.display = 'none';
            return;
        }
        
        fetch('/Amministrazione/GetScadenzeCliente?clienteId=' + clienteId + '&anno=' + annoCorrente)
            .then(response => response.json())
            .then(data => {
                selectScadenza.innerHTML = '<option value="">-- Seleziona scadenza --</option>';
                selectScadenza.innerHTML += '<option value="NUOVA">➕ Crea nuova scadenza...</option>';
                data.forEach(function(scad) {
                    var opt = document.createElement('option');
                    opt.value = scad.id;
                    opt.textContent = scad.dataScadenza + ' - ' + scad.stato;
                    selectScadenza.appendChild(opt);
                });
            });
    });

    // Mostra/Nascondi campo data nuova scadenza (nuovo)
    document.getElementById('selectScadenzaNuovo').addEventListener('change', function() {
        var container = document.getElementById('nuovaScadenzaContainer');
        var dataInput = document.getElementById('dataNuovaScadenza');
        if (this.value === 'NUOVA') {
            container.style.display = 'block';
            dataInput.required = true;
        } else {
            container.style.display = 'none';
            dataInput.required = false;
        }
    });

    // Mostra/Nascondi campo data nuova scadenza (modifica)
    document.getElementById('editScadenzaId').addEventListener('change', function() {
        var container = document.getElementById('editNuovaScadenzaContainer');
        var dataInput = document.getElementById('editDataNuovaScadenza');
        if (this.value === 'NUOVA') {
            container.style.display = 'block';
            dataInput.required = true;
        } else {
            container.style.display = 'none';
            dataInput.required = false;
        }
    });

    // Modal Modifica
    document.getElementById('modalEdit').addEventListener('show.bs.modal', function(event) {
        var btn = event.relatedTarget;
        var clienteId = btn.getAttribute('data-clienteid');
        var scadenzaId = btn.getAttribute('data-scadenzaid');
        
        document.getElementById('editId').value = btn.getAttribute('data-id');
        document.getElementById('editClienteId').value = clienteId;
        document.getElementById('editCliente').value = btn.getAttribute('data-cliente');
        document.getElementById('editData').value = btn.getAttribute('data-data');
        document.getElementById('editOraInizioMattino').value = btn.getAttribute('data-orainiziomattina') || '';
        document.getElementById('editOraFineMattino').value = btn.getAttribute('data-orafinemattina') || '';
        document.getElementById('editOraInizioPomeriggio').value = btn.getAttribute('data-orainiziopomeriggio') || '';
        document.getElementById('editOraFinePomeriggio').value = btn.getAttribute('data-orafinepomeriggio') || '';
        document.getElementById('editTariffa').value = btn.getAttribute('data-tariffaoraria').replace('.', ',');
        document.getElementById('editNote').value = btn.getAttribute('data-note') || '';

        // Calcola ore
        calcolaOreEdit();

        // Carica scadenze per il cliente
        fetch('/Amministrazione/GetScadenzeCliente?clienteId=' + clienteId + '&anno=' + annoCorrente)
            .then(response => response.json())
            .then(data => {
                var selectScadenza = document.getElementById('editScadenzaId');
                selectScadenza.innerHTML = '<option value="">-- Seleziona scadenza --</option>';
                selectScadenza.innerHTML += '<option value="NUOVA">➕ Crea nuova scadenza...</option>';
                data.forEach(function(scad) {
                    var opt = document.createElement('option');
                    opt.value = scad.id;
                    opt.textContent = scad.dataScadenza + ' - ' + scad.stato;
                    if (scad.id == scadenzaId) opt.selected = true;
                    selectScadenza.appendChild(opt);
                });
            });
        
        // Nascondi il container nuova scadenza all'apertura
        document.getElementById('editNuovaScadenzaContainer').style.display = 'none';
    });
</script>
}

