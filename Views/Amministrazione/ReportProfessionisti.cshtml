@{
    ViewData["Title"] = "Report Professionisti";
    var annoSelezionato = (int)ViewBag.AnnoSelezionato;
    var meseSelezionato = (int)ViewBag.MeseSelezionato;
    var progressivo = (bool)ViewBag.Progressivo;
    var anniDisponibili = (List<int>)ViewBag.AnniDisponibili;
    var reportData = ViewBag.ReportData as IEnumerable<dynamic> ?? new List<dynamic>();
    var professionisti = ViewBag.Professionisti as List<StudioCG.Web.Models.User> ?? new List<StudioCG.Web.Models.User>();
    var totaleGenerale = (decimal)ViewBag.TotaleGenerale;
    var cultura = new System.Globalization.CultureInfo("it-IT");
    
    var mesi = new[] { "", "Gennaio", "Febbraio", "Marzo", "Aprile", "Maggio", "Giugno", 
                       "Luglio", "Agosto", "Settembre", "Ottobre", "Novembre", "Dicembre" };
}

<div class="container-fluid">
    <!-- Header -->
    <div class="row mb-4">
        <div class="col-12 d-flex justify-content-between align-items-center flex-wrap gap-2">
            <div>
                <h4 class="mb-0"><i class="fas fa-user-tie me-2 text-primary"></i>Report Professionisti</h4>
                <small class="text-muted">
                    Incassi per professionista - 
                    @if (progressivo)
                    {
                        <span class="badge bg-primary">Gen - @mesi[meseSelezionato] @annoSelezionato (Progressivo)</span>
                    }
                    else
                    {
                        <span class="badge bg-info">@mesi[meseSelezionato] @annoSelezionato</span>
                    }
                </small>
            </div>
        </div>
    </div>

    <!-- Filtri -->
    <div class="card mb-4">
        <div class="card-body py-3">
            <form asp-action="ReportProfessionisti" method="get" class="row g-3 align-items-end">
                <div class="col-md-2">
                    <label class="form-label small text-muted">Anno</label>
                    <select name="anno" class="form-select">
                        @foreach (var anno in anniDisponibili)
                        {
                            <option value="@anno" selected="@(anno == annoSelezionato)">@anno</option>
                        }
                    </select>
                </div>
                <div class="col-md-3">
                    <label class="form-label small text-muted">Mese</label>
                    <select name="mese" class="form-select">
                        @for (int m = 1; m <= 12; m++)
                        {
                            <option value="@m" selected="@(m == meseSelezionato)">@mesi[m]</option>
                        }
                    </select>
                </div>
                <div class="col-md-4">
                    <label class="form-label small text-muted">Modalità</label>
                    <div class="btn-group w-100" role="group">
                        <input type="radio" class="btn-check" name="progressivo" id="soloMese" value="false" 
                               @(progressivo ? "" : "checked")>
                        <label class="btn btn-outline-info" for="soloMese">
                            <i class="fas fa-calendar-day me-1"></i>Solo Mese
                        </label>

                        <input type="radio" class="btn-check" name="progressivo" id="progressivoBtn" value="true"
                               @(progressivo ? "checked" : "")>
                        <label class="btn btn-outline-primary" for="progressivoBtn">
                            <i class="fas fa-chart-line me-1"></i>Progressivo
                        </label>
                    </div>
                </div>
                <div class="col-md-3">
                    <button type="submit" class="btn btn-primary w-100">
                        <i class="fas fa-sync-alt me-2"></i>Aggiorna
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Riepilogo -->
    <div class="row g-3 mb-4">
        <div class="col-md-3">
            <div class="card bg-primary text-white">
                <div class="card-body py-3">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <div class="small opacity-75">Totale Incassato</div>
                            <div class="fs-4 fw-bold">@totaleGenerale.ToString("C", new System.Globalization.CultureInfo("it-IT"))</div>
                        </div>
                        <i class="fas fa-euro-sign fa-2x opacity-50"></i>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-warning text-dark">
                <div class="card-body py-3">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <div class="small opacity-75">Da Incassare</div>
                            <div class="fs-4 fw-bold">@(((decimal)ViewBag.TotaleDaIncassare).ToString("C", new System.Globalization.CultureInfo("it-IT")))</div>
                        </div>
                        <i class="fas fa-hourglass-half fa-2x opacity-50"></i>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-success text-white">
                <div class="card-body py-3">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <div class="small opacity-75">Professionisti Attivi</div>
                            <div class="fs-4 fw-bold">@reportData.Count()</div>
                        </div>
                        <i class="fas fa-users fa-2x opacity-50"></i>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-info text-white">
                <div class="card-body py-3">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <div class="small opacity-75">Periodo</div>
                            <div class="fs-5 fw-bold">
                                @if (progressivo)
                                {
                                    @:Gen → @mesi[meseSelezionato]
                                }
                                else
                                {
                                    @mesi[meseSelezionato]
                                }
                            </div>
                        </div>
                        <i class="fas fa-calendar-alt fa-2x opacity-50"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Tabella Report -->
    <div class="card">
        <div class="card-header d-flex justify-content-between align-items-center">
            <h5 class="mb-0"><i class="fas fa-chart-bar me-2"></i>Incassi per Professionista</h5>
            <div class="btn-group">
                <a href="@Url.Action("ExportReportProfessionisti", new { anno = annoSelezionato, mese = meseSelezionato, progressivo = progressivo })" 
                   class="btn btn-outline-success btn-sm" title="Export riepilogo">
                    <i class="fas fa-file-excel me-1"></i>Export Excel
                </a>
                <a href="@Url.Action("ExportReportProfessionistiDettagliato", new { anno = annoSelezionato })" 
                   class="btn btn-success btn-sm" title="Export con dettaglio completo per mese/professionista">
                    <i class="fas fa-file-excel me-1"></i>Export Dettagliato
                </a>
            </div>
        </div>
        <div class="card-body p-0">
            @if (reportData.Any())
            {
                <div class="table-responsive">
                    <table class="table table-hover mb-0" id="reportTable">
                        <thead class="bg-light">
                            <tr>
                                <th>#</th>
                                <th>Professionista</th>
                                <th class="text-end">Incassato</th>
                                <th class="text-center" style="width: 40%;">Quota</th>
                            </tr>
                        </thead>
                        <tbody>
                            @{
                                int pos = 1;
                            }
                            @foreach (var item in reportData)
                            {
                                var percentuale = totaleGenerale > 0 ? ((decimal)item.TotaleIncassato / totaleGenerale * 100) : 0;
                                <tr>
                                    <td>
                                        @if (pos == 1)
                                        {
                                            <span class="badge bg-warning text-dark"><i class="fas fa-trophy"></i></span>
                                        }
                                        else if (pos == 2)
                                        {
                                            <span class="badge bg-secondary">2°</span>
                                        }
                                        else if (pos == 3)
                                        {
                                            <span class="badge bg-danger">3°</span>
                                        }
                                        else
                                        {
                                            <span class="text-muted">@pos°</span>
                                        }
                                    </td>
                                    <td>
                                        <strong>@item.NomeCompleto</strong>
                                    </td>
                                    <td class="text-end fw-bold">@(((decimal)item.TotaleIncassato).ToString("C", new System.Globalization.CultureInfo("it-IT")))</td>
                                    <td>
                                        <div class="progress" style="height: 25px;">
                                            <div class="progress-bar @(pos == 1 ? "bg-success" : pos == 2 ? "bg-info" : "bg-primary")" 
                                                 role="progressbar" 
                                                 style="width: @(percentuale.ToString("0.0", System.Globalization.CultureInfo.InvariantCulture))%"
                                                 aria-valuenow="@percentuale" aria-valuemin="0" aria-valuemax="100">
                                                @(percentuale.ToString("0.0"))%
                                            </div>
                                        </div>
                                    </td>
                                </tr>
                                pos++;
                            }
                        </tbody>
                        <tfoot class="bg-light">
                            <tr class="fw-bold">
                                <td colspan="2">TOTALE</td>
                                <td class="text-end">@totaleGenerale.ToString("C", new System.Globalization.CultureInfo("it-IT"))</td>
                                <td>
                                    <div class="progress" style="height: 25px;">
                                        <div class="progress-bar bg-dark" role="progressbar" style="width: 100%">
                                            100%
                                        </div>
                                    </div>
                                </td>
                            </tr>
                        </tfoot>
                    </table>
                </div>
            }
            else
            {
                <div class="text-center py-5">
                    <i class="fas fa-chart-pie fa-4x text-muted mb-3"></i>
                    <h5 class="text-muted">Nessun incasso nel periodo</h5>
                    <p class="text-muted">Seleziona un altro periodo o attendi nuovi incassi</p>
                </div>
            }
        </div>
    </div>

    <!-- ============================================ -->
    <!-- GRIGLIA MENSILE PER PROFESSIONISTA -->
    <!-- ============================================ -->
    @{
        var gridMensile = (IEnumerable<dynamic>)ViewBag.GridMensile;
        var totaliMensili = (List<decimal>)ViewBag.TotaliMensili;
        var totaleAnnuo = (decimal)ViewBag.TotaleAnnuo;
        var daIncassarePerMese = (List<decimal>)ViewBag.DaIncassarePerMese;
        var totaleDaIncassare = (decimal)ViewBag.TotaleDaIncassare;
        var mesiShort = new[] { "", "Gen", "Feb", "Mar", "Apr", "Mag", "Giu", "Lug", "Ago", "Set", "Ott", "Nov", "Dic" };
    }
    
    <div class="card mt-4">
        <div class="card-header bg-dark text-white">
            <h5 class="mb-0">
                <i class="fas fa-table me-2"></i>Dettaglio Mensile per Professionista - Anno @annoSelezionato
            </h5>
        </div>
        <div class="card-body p-0">
            <div class="table-responsive">
                <table class="table table-bordered table-hover table-sm mb-0" id="gridMensileTable">
                    <thead class="table-secondary">
                        <tr class="text-center">
                            <th style="min-width: 150px;">Professionista</th>
                            @for (int m = 1; m <= 12; m++)
                            {
                                <th style="min-width: 70px;">@mesiShort[m]</th>
                            }
                            <th class="table-primary" style="min-width: 90px;">TOTALE</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var row in gridMensile)
                        {
                            var rowMesi = (List<decimal>)row.Mesi;
                            var rowTotale = (decimal)row.Totale;
                            var profId = (int)row.ProfessionistaId;
                            var profNome = (string)row.Professionista;
                            <tr>
                                <td class="fw-bold">@profNome</td>
                                @for (int m = 0; m < 12; m++)
                                {
                                    var importoMese = rowMesi[m];
                                    var meseNum = m + 1;
                                    if (importoMese > 0)
                                    {
                                        <td class="text-end text-success cella-incasso"
                                            data-professionista="@profId" 
                                            data-mese="@meseNum" 
                                            data-nome="@profNome"
                                            style="cursor: pointer;"
                                            title="Doppio click per dettaglio">
                                            @importoMese.ToString("N0", cultura)
                                        </td>
                                    }
                                    else
                                    {
                                        <td class="text-end text-muted">
                                            <span>-</span>
                                        </td>
                                    }
                                }
                                <td class="text-end fw-bold table-primary">@rowTotale.ToString("C0", cultura)</td>
                            </tr>
                        }
                    </tbody>
                    <tfoot>
                        @* Riga Totale Incassato *@
                        <tr class="fw-bold table-dark">
                            <td>TOTALE INCASSATO</td>
                            @for (int m = 0; m < 12; m++)
                            {
                                var totMese = totaliMensili[m];
                                <td class="text-end @(totMese > 0 ? "" : "text-muted")">
                                    @if (totMese > 0)
                                    {
                                        @totMese.ToString("N0", cultura)
                                    }
                                    else
                                    {
                                        <span>-</span>
                                    }
                                </td>
                            }
                            <td class="text-end fs-6 text-success">@totaleAnnuo.ToString("C0", cultura)</td>
                        </tr>
                        @* Riga Da Incassare (sotto totale incassato) *@
                        @if (totaleDaIncassare > 0)
                        {
                            <tr class="table-warning fw-bold">
                                <td>
                                    <i class="fas fa-hourglass-half me-1 text-warning"></i>DA INCASSARE
                                </td>
                                @for (int m = 0; m < 12; m++)
                                {
                                    var importoDaInc = daIncassarePerMese[m];
                                    var meseNum = m + 1;
                                    @if (importoDaInc > 0)
                                    {
                                        <td class="text-end text-warning cella-da-incassare"
                                            data-mese="@meseNum"
                                            style="cursor: pointer;"
                                            title="Doppio click per dettaglio fatture da incassare">
                                            @importoDaInc.ToString("N0", cultura)
                                        </td>
                                    }
                                    else
                                    {
                                        <td class="text-end text-muted">
                                            <span>-</span>
                                        </td>
                                    }
                                }
                                <td class="text-end text-warning">@totaleDaIncassare.ToString("C0", cultura)</td>
                            </tr>
                        }
                    </tfoot>
                </table>
            </div>
        </div>
    </div>

    <!-- Grafico Andamento Mensile -->
    <div class="card mt-4">
        <div class="card-header bg-dark text-white">
            <h6 class="mb-0"><i class="fas fa-chart-area me-2"></i>Andamento Mensile Incassi - Anno @annoSelezionato</h6>
        </div>
        <div class="card-body py-3" style="background-color: #343a40;">
            <div style="height: 120px;">
                <canvas id="graficoMensile"></canvas>
            </div>
        </div>
    </div>
</div>

<!-- Modal Dettaglio Incassi -->
<div class="modal fade" id="modalDettaglioIncassi" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered modal-dialog-scrollable">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title">
                    <i class="fas fa-search-dollar me-2"></i>
                    Dettaglio Incassi - <span id="dettaglioNomeProfessionista"></span>
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3 d-flex justify-content-between align-items-center">
                    <span class="badge bg-info fs-6" id="dettaglioPeriodo"></span>
                    <span class="badge bg-success fs-6" id="dettaglioTotale"></span>
                </div>
                <div id="dettaglioLoading" class="text-center py-4" style="display: none;">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Caricamento...</span>
                    </div>
                </div>
                <div class="table-responsive">
                    <table class="table table-striped table-hover" id="tabellaDettaglioIncassi">
                        <thead class="table-dark">
                            <tr>
                                <th><i class="fas fa-calendar-day me-1"></i>Data Incasso</th>
                                <th class="text-end"><i class="fas fa-euro-sign me-1"></i>Importo</th>
                                <th><i class="fas fa-file-invoice me-1"></i>N° Fattura</th>
                                <th><i class="fas fa-calendar me-1"></i>Data Fattura</th>
                                <th><i class="fas fa-building me-1"></i>Cliente</th>
                            </tr>
                        </thead>
                        <tbody id="dettaglioIncassiBody">
                        </tbody>
                        <tfoot class="table-secondary">
                            <tr class="fw-bold">
                                <td>TOTALE</td>
                                <td class="text-end text-success" id="dettaglioTotaleFooter"></td>
                                <td colspan="3"></td>
                            </tr>
                        </tfoot>
                    </table>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Chiudi</button>
            </div>
        </div>
    </div>
</div>

<!-- Modal Dettaglio Fatture Da Incassare -->
<div class="modal fade" id="modalFattureDaIncassare" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered modal-dialog-scrollable">
        <div class="modal-content">
            <div class="modal-header bg-warning text-dark">
                <h5 class="modal-title">
                    <i class="fas fa-hourglass-half me-2"></i>
                    Fatture Da Incassare - <span id="fatturePeriodo"></span>
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3 d-flex justify-content-between align-items-center">
                    <span class="badge bg-warning text-dark fs-6" id="fattureMeseBadge"></span>
                    <span class="badge bg-danger fs-6" id="fattureTotaleBadge"></span>
                </div>
                <div id="fattureLoading" class="text-center py-4" style="display: none;">
                    <div class="spinner-border text-warning" role="status">
                        <span class="visually-hidden">Caricamento...</span>
                    </div>
                </div>
                <div class="table-responsive">
                    <table class="table table-striped table-hover" id="tabellaFattureDaIncassare">
                        <thead class="table-warning">
                            <tr>
                                <th><i class="fas fa-file-invoice me-1"></i>N° Fattura</th>
                                <th><i class="fas fa-calendar me-1"></i>Data Fattura</th>
                                <th><i class="fas fa-building me-1"></i>Cliente</th>
                                <th class="text-end"><i class="fas fa-euro-sign me-1"></i>Importo Fatt.</th>
                                <th class="text-end"><i class="fas fa-coins me-1"></i>Già Incassato</th>
                                <th class="text-end"><i class="fas fa-exclamation-triangle me-1"></i>Da Incassare</th>
                            </tr>
                        </thead>
                        <tbody id="fattureDaIncassareBody">
                        </tbody>
                        <tfoot class="table-danger">
                            <tr class="fw-bold">
                                <td colspan="3">TOTALE</td>
                                <td class="text-end" id="fattureTotaleImporto"></td>
                                <td class="text-end" id="fattureTotaleIncassato"></td>
                                <td class="text-end" id="fattureTotaleResiduo"></td>
                            </tr>
                        </tfoot>
                    </table>
                </div>
            </div>
            <div class="modal-footer">
                <a href="@Url.Action("Incassi", new { anno = annoSelezionato, stato = 0 })" class="btn btn-warning">
                    <i class="fas fa-coins me-1"></i>Vai a Incassi
                </a>
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Chiudi</button>
            </div>
        </div>
    </div>
</div>

@section Scripts {
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2"></script>
<script>
    // Mesi per visualizzazione
    var mesiNomi = ['', 'Gennaio', 'Febbraio', 'Marzo', 'Aprile', 'Maggio', 'Giugno', 
                    'Luglio', 'Agosto', 'Settembre', 'Ottobre', 'Novembre', 'Dicembre'];
    var annoCorrente = @annoSelezionato;

    // Gestione doppio click sulle celle con importo
    document.querySelectorAll('.cella-incasso').forEach(function(cella) {
        cella.addEventListener('dblclick', function() {
            var professionistaId = this.getAttribute('data-professionista');
            var mese = parseInt(this.getAttribute('data-mese'));
            var nome = this.getAttribute('data-nome');
            
            if (!professionistaId || !mese) return;
            
            // Aggiorna header modal
            document.getElementById('dettaglioNomeProfessionista').textContent = nome;
            document.getElementById('dettaglioPeriodo').textContent = mesiNomi[mese] + ' ' + annoCorrente;
            
            // Mostra loading
            document.getElementById('dettaglioLoading').style.display = 'block';
            document.getElementById('dettaglioIncassiBody').innerHTML = '';
            document.getElementById('dettaglioTotale').textContent = '';
            document.getElementById('dettaglioTotaleFooter').textContent = '';
            
            // Apri modal
            var modal = new bootstrap.Modal(document.getElementById('modalDettaglioIncassi'));
            modal.show();
            
            // Carica dati
            fetch('/Amministrazione/GetDettaglioIncassiProfessionista?professionistaId=' + professionistaId + '&mese=' + mese + '&anno=' + annoCorrente)
                .then(function(response) { return response.json(); })
                .then(function(data) {
                    document.getElementById('dettaglioLoading').style.display = 'none';
                    
                    var html = '';
                    var totale = 0;
                    
                    data.forEach(function(inc) {
                        totale += inc.importo;
                        html += '<tr>';
                        html += '<td><i class="fas fa-calendar-check text-primary me-1"></i>' + inc.dataIncasso + '</td>';
                        html += '<td class="text-end text-success fw-bold">' + formatCurrency(inc.importo) + '</td>';
                        html += '<td>' + (inc.numeroFattura ? '<span class="badge bg-secondary">' + inc.numeroFattura + '</span>' : '-') + '</td>';
                        html += '<td>' + inc.dataFattura + '</td>';
                        html += '<td><strong>' + inc.cliente + '</strong></td>';
                        html += '</tr>';
                    });
                    
                    document.getElementById('dettaglioIncassiBody').innerHTML = html;
                    document.getElementById('dettaglioTotale').textContent = 'Totale: ' + formatCurrency(totale);
                    document.getElementById('dettaglioTotaleFooter').textContent = formatCurrency(totale);
                    
                    if (data.length === 0) {
                        document.getElementById('dettaglioIncassiBody').innerHTML = '<tr><td colspan="5" class="text-center text-muted py-4">Nessun incasso trovato</td></tr>';
                    }
                })
                .catch(function(error) {
                    console.error('Errore:', error);
                    document.getElementById('dettaglioLoading').style.display = 'none';
                    document.getElementById('dettaglioIncassiBody').innerHTML = '<tr><td colspan="5" class="text-center text-danger py-4">Errore nel caricamento</td></tr>';
                });
        });
        
        // Effetto hover per indicare interattività
        cella.addEventListener('mouseenter', function() {
            this.style.backgroundColor = '#e8f5e9';
        });
        cella.addEventListener('mouseleave', function() {
            this.style.backgroundColor = '';
        });
    });

    // Gestione doppio click sulle celle "Da Incassare"
    document.querySelectorAll('.cella-da-incassare').forEach(function(cella) {
        cella.addEventListener('dblclick', function() {
            var mese = parseInt(this.getAttribute('data-mese'));
            
            if (!mese) return;
            
            // Aggiorna header modal
            document.getElementById('fatturePeriodo').textContent = mesiNomi[mese] + ' ' + annoCorrente;
            document.getElementById('fattureMeseBadge').textContent = mesiNomi[mese] + ' ' + annoCorrente;
            
            // Mostra loading
            document.getElementById('fattureLoading').style.display = 'block';
            document.getElementById('fattureDaIncassareBody').innerHTML = '';
            document.getElementById('fattureTotaleBadge').textContent = '';
            
            // Apri modal
            var modal = new bootstrap.Modal(document.getElementById('modalFattureDaIncassare'));
            modal.show();
            
            // Carica dati
            fetch('/Amministrazione/GetFattureDaIncassareMese?mese=' + mese + '&anno=' + annoCorrente)
                .then(function(response) { return response.json(); })
                .then(function(data) {
                    document.getElementById('fattureLoading').style.display = 'none';
                    
                    var html = '';
                    var totaleImporto = 0;
                    var totaleIncassato = 0;
                    var totaleResiduo = 0;
                    
                    data.forEach(function(fat, idx) {
                        totaleImporto += fat.importoFattura;
                        totaleIncassato += fat.importoIncassato;
                        totaleResiduo += fat.residuo;
                        
                        var isParziale = fat.stato === 'Parziale';
                        var statoBadge = isParziale 
                            ? '<span class="badge bg-info ms-1">Parziale</span>' 
                            : '';
                        
                        html += '<tr' + (isParziale ? ' class="table-info"' : '') + '>';
                        html += '<td><span class="badge bg-secondary">' + fat.numeroFattura + '</span>' + statoBadge + '</td>';
                        html += '<td>' + fat.dataFattura + '</td>';
                        html += '<td><strong>' + fat.cliente + '</strong></td>';
                        html += '<td class="text-end">' + formatCurrency(fat.importoFattura) + '</td>';
                        html += '<td class="text-end text-success">' + formatCurrency(fat.importoIncassato) + '</td>';
                        html += '<td class="text-end text-danger fw-bold">' + formatCurrency(fat.residuo) + '</td>';
                        html += '</tr>';
                        
                        // Se è parziale, mostra dettaglio incassi
                        if (isParziale && fat.incassiParziali && fat.incassiParziali.length > 0) {
                            html += '<tr class="bg-light">';
                            html += '<td colspan="6" class="py-2 ps-4">';
                            html += '<div class="small">';
                            html += '<strong class="text-info"><i class="fas fa-history me-1"></i>Incassi già registrati:</strong>';
                            html += '<ul class="mb-0 mt-1">';
                            fat.incassiParziali.forEach(function(inc) {
                                var professionistiStr = '';
                                if (inc.professionisti && inc.professionisti.length > 0) {
                                    professionistiStr = ' → ' + inc.professionisti.map(function(p) {
                                        return '<span class="badge bg-primary me-1">' + p.nome + '</span> ' + formatCurrency(p.importo);
                                    }).join(', ');
                                }
                                html += '<li>';
                                html += '<span class="text-muted">' + inc.data + '</span> - ';
                                html += '<span class="text-success fw-bold">' + formatCurrency(inc.importo) + '</span>';
                                if (inc.note) {
                                    html += ' <em class="text-muted">(' + inc.note + ')</em>';
                                }
                                html += professionistiStr;
                                html += '</li>';
                            });
                            html += '</ul>';
                            html += '</div>';
                            html += '</td>';
                            html += '</tr>';
                        }
                    });
                    
                    document.getElementById('fattureDaIncassareBody').innerHTML = html;
                    document.getElementById('fattureTotaleBadge').textContent = 'Totale: ' + formatCurrency(totaleResiduo);
                    document.getElementById('fattureTotaleImporto').textContent = formatCurrency(totaleImporto);
                    document.getElementById('fattureTotaleIncassato').textContent = formatCurrency(totaleIncassato);
                    document.getElementById('fattureTotaleResiduo').textContent = formatCurrency(totaleResiduo);
                    
                    if (data.length === 0) {
                        document.getElementById('fattureDaIncassareBody').innerHTML = '<tr><td colspan="6" class="text-center text-muted py-4">Nessuna fattura da incassare</td></tr>';
                    }
                })
                .catch(function(error) {
                    console.error('Errore:', error);
                    document.getElementById('fattureLoading').style.display = 'none';
                    document.getElementById('fattureDaIncassareBody').innerHTML = '<tr><td colspan="6" class="text-center text-danger py-4">Errore nel caricamento</td></tr>';
                });
        });
        
        // Effetto hover per indicare interattività
        cella.addEventListener('mouseenter', function() {
            this.style.backgroundColor = '#fff3cd';
        });
        cella.addEventListener('mouseleave', function() {
            this.style.backgroundColor = '';
        });
    });

    function formatCurrency(value) {
        return new Intl.NumberFormat('it-IT', { style: 'currency', currency: 'EUR' }).format(value);
    }

    // Registra il plugin datalabels
    Chart.register(ChartDataLabels);

    // Grafico andamento mensile
    var ctx = document.getElementById('graficoMensile').getContext('2d');
    var datiMensili = [@string.Join(",", totaliMensili.Select(v => v.ToString(System.Globalization.CultureInfo.InvariantCulture)))];
    var maxValore = Math.max(...datiMensili, 1);
    
    new Chart(ctx, {
        type: 'bar',
        data: {
            labels: ['Gen', 'Feb', 'Mar', 'Apr', 'Mag', 'Giu', 'Lug', 'Ago', 'Set', 'Ott', 'Nov', 'Dic'],
            datasets: [{
                label: 'Incassato €',
                data: datiMensili,
                backgroundColor: datiMensili.map((v, i) => {
                    if (i === @(meseSelezionato - 1)) return 'rgba(102, 126, 234, 0.9)';
                    return v > 0 ? 'rgba(40, 167, 69, 0.7)' : 'rgba(200, 200, 200, 0.3)';
                }),
                borderColor: datiMensili.map((v, i) => {
                    if (i === @(meseSelezionato - 1)) return '#667eea';
                    return v > 0 ? '#28a745' : '#ccc';
                }),
                borderWidth: 2,
                borderRadius: 4
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            layout: {
                padding: { top: 20 }
            },
            plugins: {
                legend: { display: false },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            return '€ ' + context.parsed.y.toLocaleString('it-IT', {minimumFractionDigits: 2});
                        }
                    }
                },
                datalabels: {
                    anchor: 'end',
                    align: 'top',
                    formatter: function(value) {
                        if (value > 0) {
                            return '€ ' + value.toLocaleString('it-IT', {maximumFractionDigits: 0});
                        }
                        return '';
                    },
                    font: {
                        weight: 'bold',
                        size: 10
                    },
                    color: '#ffffff'
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    display: false,
                    max: maxValore * 1.3
                },
                x: {
                    grid: { display: false },
                    ticks: { 
                        font: { size: 10, weight: 'bold' },
                        color: '#ffffff'
                    }
                }
            }
        }
    });
</script>
}

